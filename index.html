<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é†«å¸«å‹¾é¸å–®ï¼ˆåœ–ç‰‡åƒç´ ç´šæ’ç‰ˆï½œMNT ç½/è¢‹ï¼‰</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#1b2430; --muted:#6b7280; --bg:#f7f7f9; --panel:#ffffff; --border:#e5e7eb;
    --head:#2c3446; --head-text:#e5e7ee; --tab:#eef2f7; --price:#0f172a;
    --pill-bg:#e8eefc; --pill-text:#3556c6; --warn:#b45309;
    --tab-active:#4b5569; --tab-active-text:#fff;

    --page-max: 1600px;   /* ä¸»å®¹å™¨æœ€å¤§å¯¬åº¦ */
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    letter-spacing:.2px;
  }

  /* ===== é ‚éƒ¨æ·±è‰²æ¨™é¡Œæ¢ ===== */
  .topbar{
    background:var(--head); color:var(--head-text);
    padding:10px 16px 6px; border-bottom:4px solid #424c64;
  }
  .topbar .title{ font-weight:900; letter-spacing:2px; font-size:26px; text-align:center }
  .topbar .meta{ display:flex; justify-content:flex-end; gap:18px; margin-top:4px; font-size:13px; opacity:.95 }

  /* ===== åˆ†é  Tab ===== */
  .tabs{ background:#f0f2f7; border-bottom:1px solid var(--border) }
  .tabs .wrap{ display:flex; gap:8px; padding:8px 12px; max-width:1180px; margin:0 auto }
  .tabbtn{
    appearance:none; border:1px solid var(--border); background:#fff; color:var(--ink);
    padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600; font-size:14px;
  }
  .tabbtn.active{ background:var(--tab-active); color:var(--tab-active-text); border-color:var(--tab-active) }

  /* ===== ç‰ˆé¢ï¼šä¸Šæ–¹ 6 å¡ç‰‡ + ä¸‹æ–¹æ•´æ’è³¼ç‰©è»Š ===== */
  .wrap{ max-width: var(--page-max); margin:14px auto 24px; padding:0 12px }

  .grid{
    display:grid;
    grid-template-columns: repeat(6, 1fr); /* ä¸Šæ’ 6 å¼µå¡å‰›å¥½ä¸€åˆ— */
    gap:16px;
    align-items: stretch;
  }
  /* éŸ¿æ‡‰å¼ï¼šä¸­è¢å¹• 3 æ¬„ï¼Œå°è¢å¹• 2 / 1 æ¬„ */
  @media (max-width:1280px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
  @media (max-width:860px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
  @media (max-width:600px){ .grid{ grid-template-columns: 1fr; } }

  /* ===== ä¸»é è³¼ç‰©è»Šï¼ˆç½®åº•æ•´æ’ï¼‰ ===== */
    .cart-full{
      grid-column: 1 / -1;
      position: relative;  /* ä¸è¦å›ºå®š */
    }

    /* ===== ç¬¬äºŒé è³¼ç‰©è»Šï¼ˆå³ä¸Šè§’å›ºå®šï¼‰ ===== */
    .cart-care{
      position: sticky;
      top: 78px;
      align-self: start;
    }


  /* ===== ç¬¬äºŒé ï¼ˆä¿é¤Šï¼èŒ¶é£²ï¼‰ç‰ˆé¢ï¼šå…§å®¹ + è³¼ç‰©è»Š ===== */
  .grid-care{
    display:grid; grid-template-columns: 1fr 520px; gap:12px;
  }
  @media (max-width:1220px){ .grid-care{ grid-template-columns: 1fr; } }

  /* ===== å¡ç‰‡ ===== */
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:10px; overflow:hidden }
  .card.hang{ position:relative }
  .card.hang:before{
    content:""; position:absolute; top:-12px; left:50%; transform:translateX(-50%);
    width:36px; height:36px; border-radius:999px; background:#f0f2f7; border:4px solid #cfd6e8;
    box-shadow: inset 0 0 0 6px #f7f8fb; z-index:2;
  }
  .card h3{ margin:0; padding:9px 12px; font-size:15px; color:#fff; background:#4b5569;
            border-bottom:1px solid #3e485d; letter-spacing:1px }
  .content{ padding:10px 12px }

  /* ===== è¡¨æ ¼ ===== */
  table{ width:100%; border-collapse:collapse; font-size:12.5px }
  thead th{ background:#eef1f6; font-weight:700; font-size:12.5px }
  th,td{ padding:10px 8px; border-bottom:1px solid var(--border); vertical-align:middle; line-height:1.2 }
  tr{ height:44px }
  th.qty, td.qty{ width:96px; text-align:center; white-space:nowrap }
  td.right{ text-align:right }
  .price{ font-variant-numeric:tabular-nums; color:var(--price) }

  /* ===== MNT ç½ï¼è¢‹åˆ— ===== */
  .mnt-row td{ padding:10px 8px }
  .mnt-name{ display:block; font-weight:500; margin-bottom:6px }
  .mnt-subline{ display:flex; gap:14px; flex-wrap:wrap; font-size:12px; color:var(--muted) }
  .mnt-subline label{ display:inline-flex; align-items:center; gap:6px }
  .mnt-subline input{ width:58px; text-align:center; height:28px }
  .mnt-qty-total{ font-weight:700 }

  /* ===== å°å…ƒä»¶ ===== */
  .stack{ display:flex; flex-direction:column; gap:6px }
  .row{ display:flex; justify-content:space-between; align-items:center; gap:8px }
  .pill{ display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px;
         background:var(--pill-bg); color:var(--pill-text); border:1px solid #c9d5ff }
  .muted{ color:#6b7280; font-size:12px }
  .warn{ color:var(--warn); font-size:12px }
  .btn{ appearance:none; border:1px solid #4b5569; color:#4b5569; background:#fff; cursor:pointer;
        padding:6px 10px; border-radius:8px; font-size:13px }
  .btn.primary{ background:#4b5569; color:#fff }
  .tag{ font-size:11px; padding:2px 6px; border-radius:999px; background:#fef3c7; border:1px solid #f8ce7a; color:#7a5200 }

  /* ===== æ¸…å–® ===== */
  .list{ list-style:none; padding:0; margin:0 }
  .list li{ display:flex; justify-content:space-between; align-items:center; gap:6px; padding:8px 0;
            border-bottom:1px solid var(--border) }
  .list .meta{ display:flex; align-items:center; gap:6px }

/* ===== å–®å“ï¼ˆä¸»é ï¼‰å–æ¶ˆæ¡†æ ¼ï¼Œä¿ç•™åˆ†éš”ç·š ===== */

/* å®¹å™¨ç¶­æŒç›´æ’ã€ç„¡é–“è·ï¼Œè®“åˆ†éš”ç·šé€£çºŒ */
#singlesList{
  display:flex;
  flex-direction:column;
  gap:0;
  font-size:12.5px;    /* çµ±ä¸€å­—ç´šï¼Œé¿å…ç¹¼æ‰¿ç•°å¸¸ */
  line-height:1.2;     /* çµ±ä¸€è¡Œé«˜ */
}

/* æ¯åˆ—å›ºå®šé«˜åº¦ï¼Œç”± li æ§åˆ¶ï¼›ç½®ä¸­å°é½Šï¼Œåˆ†éš”ç·šåªç•«åº•ç·š */
#singlesList li{
  list-style:none;
  display:flex;
  align-items:center;
  height:48px;                 /* â­ å›ºå®šåˆ—é«˜ */
  padding:0 8px;               /* â­ padding æ”¾åœ¨ li */
  border-bottom:1px solid var(--border);
}
#singlesList li:last-child{ border-bottom:0; }

/* label ä¸å†æ±ºå®šé«˜åº¦ï¼Œåªåšå·¦å³åˆ†ä½ˆ */
#singlesList label{
  display:flex;
  justify-content:space-between;
  align-items:center;
  width:100%;
  border:0 !important;
  background:transparent !important;
  padding:0;                   /* é«˜åº¦èˆ‡å…§è·äº¤çµ¦ li */
  margin:0;
}

/* å·¦ï¼šåç¨± + åƒ¹æ ¼ï¼ˆå–®è¡Œçœç•¥ï¼‰ */
#singlesList .left{
  flex:1;
  min-width:0;
  display:flex;
  gap:6px;
  align-items:center;
  overflow:hidden;
  white-space:nowrap;          /* â­ æ•´æ®µä¸æ›è¡Œ */
}
#singlesList .left .name{
  flex:1;
  min-width:0;
  overflow:hidden;
  text-overflow:ellipsis;
}
#singlesList .left .muted{
  flex-shrink:0;
  white-space:nowrap;          /* åƒ¹æ ¼ä¸æ›è¡Œ */
}

/* å³ï¼šæ•¸é‡è¼¸å…¥æ¡†å›ºå®šå¤§å°ä¸¦è²¼é½Šå³å´ */
#singlesList input[type="number"]{
  width:64px;
  height:32px;
  text-align:center;
  box-sizing:border-box;
  margin-left:auto;            /* å³å°é½Š */
}




  /* ===== è³¼ç‰©è»Š ===== */
  .cart .row{ font-size:14px }
  .cart .subtotal{ font-weight:800; padding-top:8px; border-top:1px dashed var(--border) }
  .cart-item{ display:grid; grid-template-columns:1fr auto; gap:4px; padding:8px 0; border-bottom:1px dashed var(--border) }
  .qtyctl{ display:flex; align-items:center; gap:6px }
  .qtyctl button{ width:28px; height:28px; border-radius:6px }

  /* ===== åˆ—å° ===== */
  @media print{
    body{ background:#fff }
    .topbar{ -webkit-print-color-adjust:exact; print-color-adjust:exact }
    .tabs{ display:none!important }
    .card.hang:before{ display:none!important }
    .grid{ grid-template-columns: repeat(3, 1fr); gap:10px }
    .cart-full{ grid-column: 1 / -1; }
    .content{ padding:8px 10px }
    th,td{ padding:5px 5px; font-size:12px }
    .btn{ display:none!important }
  }
  /* ===== çµ„åˆå„ªæƒ ï¼šæ¨™é¡Œå­—é«”èˆ‡æ•¸é‡è¼¸å…¥æ¡†ï¼ˆæ¯”ç…§ä¸‰å¤§å¥—çµ„ï¼‰ ===== */
    .combo-block b{
      font-size:15px;            /* ä¸‰å¤§å¥—çµ„å¡ç‰‡æ¨™é¡Œæ˜¯ 15px */
      line-height:1.25;
    }

    .combo-block input[type="number"]{
      width:58px !important;     /* èˆ‡ä¸‰å¤§å¥—çµ„ä¸€è‡´ */
      height:28px !important;    /* èˆ‡ä¸‰å¤§å¥—çµ„ä¸€è‡´ */
        text-align:center !important;
      }

/* æš¢/è¡›/C/L/é­š/å¤œ/æ•/è“ï¼ˆmix8ï¼‰å­—é«”èª¿æ•´ï¼šèˆ‡ä¸‰å¤§å¥—çµ„å“é …ä¸€è‡´ */
#qtywrap-mix8 label{
  font-size:12.5px;   /* èˆ‡ä¸‰å¤§å¥—çµ„å“é …ä¸€è‡´ */
}
#qtywrap-mix8 .muted{
  font-size:12px;     /* åƒ¹æ ¼çš„å°å­—ç¶­æŒè¼ƒå° */
}

/* MNT è›‹ç™½ç²‰ 3 å…¥ä»»é¸ï¼ˆç½ï¼è¢‹ï¼‰å­—é«”èª¿æ•´ï¼šèˆ‡ä¸‰å¤§å¥—çµ„å“é …ä¸€è‡´ */
[data-mntpack]{
  font-size:12.5px;  /* è·Ÿä¸‰å¤§å¥—çµ„è¡¨æ ¼å“é …å­—é«”ä¸€æ¨£ */
}

/* æœ€ç©©å®šå¯«æ³•ï¼šç›´æ¥æŒ‡å®šé‚£å…©åˆ— */
.combo-block .mntpack-row{
  font-size:12.5px;   /* èˆ‡ä¸‰å¤§å¥—çµ„å“é …ä¸€è‡´ */
}

/* ===== å³å´ã€Œçµ„åˆå„ªæƒ åƒ¹ã€å“åå­—ç´šèª¿æ•´ï¼ˆå°é½Šä¸‰å¤§å¥—çµ„ 12.5pxï¼‰ ===== */
/* åªå¥—ç”¨åœ¨å³å´ combos-right çš„å…©çµ„ pickNFixed å¡ç‰‡ï¼ˆæ—©æ™šå®‰ï¼èŒ¶åŒ…ä¸‰å…¥ï¼‰ */
#combos-right .combo-block:has([data-add-combo="earlyLate"]) .row:has(input[type="number"]) > span,
#combos-right .combo-block:has([data-add-combo="tea3"]) .row:has(input[type="number"]) > span {
  font-size: 12.5px;   /* èˆ‡ä¸‰å¤§å¥—çµ„å“é …ä¸€è‡´ */
}

/* åƒ¹æ ¼å°å­—ç¶­æŒ 12px */
#combos-right .combo-block:has([data-add-combo="earlyLate"]) .row:has(input[type="number"]) > span .muted,
#combos-right .combo-block:has([data-add-combo="tea3"]) .row:has(input[type="number"]) > span .muted {
  font-size: 12px;
}


/* å›ºå®šé…æ–¹æ¸…å–®ï¼ˆå„ªå…ˆç›ˆï¼æ²¹æ¾±é›™åˆ‡ã€å„ªå…ˆç›ˆï¼é›™Lç›ŠèŒç³–ï¼‰ */
#combos-right .list .meta span:not(.muted) { font-size:12.5px; }
/* åƒ¹æ ¼å°å­—ç¶­æŒè¼ƒå° */
#combos-right .list .meta .muted { font-size:12px; }

/* ===== è³¼ç‰©è»Šå°ˆå±¬é¡è‰²ï¼ˆæ·¡è—å†·è‰²é¢¨æ ¼ï¼‰ ===== */
.card.cart {
  background: #e1f0f7;   /* æ·¡è—èƒŒæ™¯ */
  border-color: #bae6fd; /* æ·ºè—é‚Šæ¡† */
}

/* è³¼ç‰©è»Šæ¨™é¡Œåˆ— */
.card.cart h3 {
  background: #4f646d;   /* è—è‰²æ¨™é¡Œåº• */
  color: #ffffff;        /* ç™½å­— */
  border-bottom: 1px solid #0284c7; /* æ·±è—é‚Šç·š */
}

/* è³¼ç‰©è»Šå…§åƒ¹æ ¼é¡è‰²åŠ å¼· */
.card.cart .price {
  color: #124c6b; /* æ·±è—å­— */
  font-weight: 600;
}

/* è³¼ç‰©è»Šå…§çš„å°å­—ï¼ˆmutedï¼‰ */
.card.cart .muted {
  color: #475569; /* å†·ç°è— */
}

/* === è³¼ç‰©è»Šåˆ†éš”ç·šæ”¹é»‘è‰² === */
.cart-item{ border-bottom:1px dashed #000000 !important; }
.cart .subtotal{ border-top:1px dashed #000000 !important; }
.card.cart hr{ border-top:1px solid #ff0000 !important; }


</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getFirestore, collection, doc, writeBatch, serverTimestamp,addDoc
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  // ï¼ˆå¯é¸ï¼‰è‹¥ä½ æƒ³è¦ GA äº‹ä»¶æ‰éœ€è¦ analytics
  // import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";

  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
  apiKey: "AIzaSyByf-Dt9Yiqxx-iKEHdlSHOaOLSDPB89qY",
  authDomain: "plus2r-taichung.firebaseapp.com",
  projectId: "plus2r-taichung",
  storageBucket: "plus2r-taichung.appspot.com",
  messagingSenderId: "163462804695",
  appId: "1:163462804695:web:6c915b616d02d167f7ec92",
  measurementId: "G-0L97P1Y9HZ"
};

  const app = initializeApp(firebaseConfig);
  // const analytics = getAnalytics(app); // å¯é¸

  // âœ¨ é—œéµï¼šæŠŠéœ€è¦ç”¨åˆ°çš„ API æ›åˆ°å…¨åŸŸï¼Œä¾›å¾Œé¢çš„æ¨¡çµ„ä½¿ç”¨
  window.__fb = {
    auth: getAuth(app),
    db: getFirestore(app),
    collection, doc, writeBatch, serverTimestamp,
    signInAnonymously, onAuthStateChanged,addDoc,
  };
</script>

</head>
<body>

  <!-- ===== é¡§å®¢è³‡æ–™ Gate ===== -->
<div id="customer-gate" style="max-width:520px;margin:24px auto;padding:16px;background:#fff;border:1px solid #e5e7eb;border-radius:10px">
  <h2 style="margin:0 0 12px">å…ˆå¡«å¯«åŸºæœ¬è³‡æ–™</h2>
  <p class="muted" style="margin-top:0">å®Œæˆå¾Œå³å¯é€²å…¥å‹¾é¸è³¼ç‰©é é¢ã€‚</p>

  <form id="customer-form" class="stack" style="gap:10px">
    <label class="stack">
      <span>å§“å</span>
      <input id="cust-name" type="text" required placeholder="ç‹æ›‰æ˜" style="height:36px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px">
    </label>
    <label class="stack">
      <span>é›»è©±</span>
      <input id="cust-phone" type="tel" required
       placeholder="0xxxxxxxxx"
       pattern="^0[0-9]{9}$"
       title="å¿…é ˆæ˜¯ 0 é–‹é ­çš„ 10 ä½æ•¸å­—"
       style="height:36px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px">

    </label>
    <label class="stack">
      <span>Email</span>
      <input id="cust-email" type="email" required placeholder="name@example.com"
             style="height:36px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px">
    </label>
    <label class="stack">
      <span>èº«åˆ†è­‰å­—è™Ÿ</span>
      <input id="cust-nid" type="text" required placeholder="A123456789"
             style="height:36px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px"
             pattern="^[A-Za-z][12][0-9]{8}$" title="æ ¼å¼ç‚ºè‹±æ–‡å­—æ¯+1æˆ–2+8ä½æ•¸å­—ï¼Œä¾‹å¦‚ A123456789">
    </label>
  <!-- æ–°å¢ï¼šæ”¶ä»¶åœ°å€ -->
<label class="stack">
  <span>æ”¶ä»¶åœ°å€</span>
  <input id="cust-address" type="text" required placeholder="å°ä¸­å¸‚è¥¿å±¯å€â€¦"
         style="height:36px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px">
</label>

<!-- æ–°å¢ï¼šä»˜æ¬¾æ–¹å¼ï¼ˆé è¨­åŒ¯æ¬¾ï¼‰ -->
<fieldset style="border:0;padding:0;margin:0">
  <legend class="muted" style="margin-bottom:6px">ä»˜æ¬¾æ–¹å¼</legend>
  <label style="display:inline-flex;align-items:center;gap:6px;margin-right:16px">
    <input type="radio" name="payMethod" value="remit" id="pay-remit" checked>
    <span>åŒ¯æ¬¾</span>
  </label>
  <!-- <label style="display:inline-flex;align-items:center;gap:6px">
    <input type="radio" name="payMethod" value="cash" id="pay-cash">
    <span>ç¾é‡‘</span> -->
  <!-- </label> --> 
</fieldset>

<!-- æ–°å¢ï¼šåŒ¯æ¬¾å¾Œäº”ç¢¼ï¼ˆåƒ…åŒ¯æ¬¾æ™‚é¡¯ç¤º/å¿…å¡«ï¼‰ -->
<label class="stack" id="last5-wrap">
  <span>åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</span>
  <input id="remit-last5" inputmode="numeric" pattern="^[0-9]{5}$" maxlength="5"
         placeholder="12345"
         title="è«‹è¼¸å…¥ 5 ä½æ•¸å­—"
         style="height:36px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px">
  <small class="muted">â€» æš«ä¸é–‹æ”¾ç¾é‡‘ä»˜æ¬¾</small>
</label>

    <label style="display:flex;gap:8px;align-items:center;margin-top:4px">
      <input id="agree" type="checkbox" required>
      <span class="muted">æˆ‘åŒæ„è¨ºæ‰€ä½¿ç”¨æœ¬è³‡æ–™è™•ç†è¨‚å–®</span>
    </label>
  
    <div class="row" style="justify-content:flex-end;margin-top:6px">
      <button class="btn primary" type="submit">é–‹å§‹é¸è³¼</button>
    </div>
  </form>
  
</div>
<div id="shop-root" style="display:none">
  <!-- æ·±è‰²æŠ¬é ­å€ -->
  <div class="topbar">
    <div class="title">é†«&nbsp;&nbsp;å¸«&nbsp;&nbsp;å‹¾&nbsp;&nbsp;é¸&nbsp;&nbsp;å–®</div>
    <div class="meta">
      <div>æ—¥æœŸï¼š<span id="today"></span></div>
      <div>å–®è™Ÿï¼š<span id="orderNo"></span></div>
    </div>
  </div>

  <!-- åˆ†é  -->
  <nav class="tabs">
    <div class="wrap">
      <button class="tabbtn active" data-tab="main">ä¸»é ï¼ˆå¥—çµ„ / å–®å“ / çµ„åˆåƒ¹ï¼‰</button>
      <button class="tabbtn" data-tab="care">ç„¡é½¡é†«å¸«ä¿é¤Šå“ & èŒ¶é£²</button>
    </div>
  </nav>

  <!-- Page Aï¼šä¸»é  -->
  <section class="wrap" id="page-main" aria-hidden="false">
    <div class="grid">
      <!-- ä¸‰å€‹å¥—çµ„ -->
      <section class="card hang" id="classicCard">
        <h3>ç¶“å…¸å¥—çµ„</h3>
        <div class="content">
          <table>
            <thead><tr><th>å“é …</th><th class="qty">æ•¸é‡</th></tr></thead>
            <tbody id="classicBody"></tbody>
          </table>
          <div class="content stack" style="padding:8px 0 0">
            <div class="row"><span class="pill">å¯æ­åƒ¹</span><b class="price" id="classicDeal"></b></div>
            <div class="muted">åˆ / è¤‡è¨ºå¯æ­</div>
            <div class="muted" id="classicHint"></div>
            <div class="row"><button class="btn primary" data-add-bundle="classic">åŠ å…¥è³¼ç‰©è»Š</button></div>
          </div>
        </div>
      </section>

      <section class="card hang" id="superCard">
        <h3>è¶…å€¼å‡ç´šå¥—çµ„</h3>
        <div class="content">
          <table>
            <thead><tr><th>å“é …</th><th class="qty">æ•¸é‡</th></tr></thead>
            <tbody id="superBody"></tbody>
          </table>
          <div class="content stack" style="padding:8px 0 0">
            <div class="row"><span class="pill">å¯æ­åƒ¹</span><b class="price" id="superDeal"></b></div>
            <div class="muted">åˆ / è¤‡è¨ºå¯æ­</div>
            <div class="muted" id="superHint"></div>
            <div class="row"><button class="btn primary" data-add-bundle="super">åŠ å…¥è³¼ç‰©è»Š</button></div>
          </div>
        </div>
      </section>

      <section class="card hang" id="lightCard">
        <h3>è¼•ç›ˆå¥—çµ„</h3>
        <div class="content">
          <table>
            <thead><tr><th>å“é …</th><th class="qty">æ•¸é‡</th></tr></thead>
            <tbody id="lightBody"></tbody>
          </table>
          <div class="content stack" style="padding:8px 0 0">
            <div class="row"><span class="pill">å¯æ­åƒ¹</span><b class="price" id="lightDeal"></b></div>
            <div class="muted">åªé™è¤‡è¨º</div>
            <div class="muted" id="lightHint"></div>
            <div class="row"><button class="btn primary" data-add-bundle="light">åŠ å…¥è³¼ç‰©è»Š</button></div>
          </div>
        </div>
      </section>

      <!-- å–®å“ -->
      <section class="card">
        <h3>å–®å“</h3>
        <div class="content">
          <ul class="list" id="singlesList"></ul>
        </div>
      </section>

      <!-- çµ„åˆå„ªæƒ ï¼ˆå·¦ï¼‰ -->
      <section class="card">
        <h3>çµ„åˆå„ªæƒ åƒ¹</h3>
        <div class="content stack" id="combos"></div>
      </section>

      <!-- çµ„åˆå„ªæƒ ï¼ˆå³ï¼‰ -->
      <section class="card">
        <h3>çµ„åˆå„ªæƒ åƒ¹</h3>
        <div class="content stack" id="combos-right"></div>
      </section>

      <!-- â†“â†“â†“ é€™ä¸€å¡Šæ”¹æˆç½®åº•æ•´æ’è³¼ç‰©è»Š â†“â†“â†“ -->
      <aside class="card cart cart-full">
        <h3>è³¼ç‰©è»Š</h3>
        <div class="content">
          <div id="cartItems"></div>
          <div class="muted" id="bundleNotes" style="margin-top:6px"></div>
          <hr style="border:none;border-top:1px solid var(--border);margin:8px 0" />
          <div class="row"><span>å°è¨ˆ</span><span class="price" id="subtotal">$0</span></div>
          <div class="row"><span>æŠ˜æ‰£</span><span class="price" id="discount">$0</span></div>
          <div class="row subtotal"><span>ç¸½è¨ˆ</span><span class="price" id="grandTotal">$0</span></div>
          <div class="row" style="gap:8px; margin-top:10px">
            <button class="btn" id="clearCart">æ¸…ç©º</button>
            <button class="btn primary" id="submitOrder">é€å‡ºè¨‚å–®</button>
          </div>
        </div>
      </aside>
      <!-- â†‘â†‘â†‘ ç½®åº•æ•´æ’è³¼ç‰©è»Š â†‘â†‘â†‘ -->
    </div>
  </section>

  <!-- Page Bï¼šç„¡é½¡é†«å¸«ä¿é¤Šå“ & èŒ¶é£²ï¼ˆç¶­æŒåŸæœ¬ï¼‰ -->
  <section class="wrap" id="page-care" aria-hidden="true" style="display:none">
    <div class="grid-care">
      <div class="stack">
        <section class="card">
          <h3>ğŸ’§ ä¿é¤Šå“</h3>
          <div class="content"><ul class="list" id="care-skin"></ul></div>
        </section>
        <section class="card">
          <h3>ğŸµ é£Ÿå“ / èŒ¶åŒ…</h3>
          <div class="content"><ul class="list" id="care-drink"></ul></div>
        </section>
        <section class="card">
          <h3>ğŸ› ï¸ å…¶ä»–ç”¨å“</h3>
          <div class="content"><ul class="list" id="care-others"></ul></div>
        </section>
        <section class="card">
          <h3>ğŸŒ¸ ç§å¯†ä¿é¤Š</h3>
          <div class="content"><ul class="list" id="care-intimate"></ul></div>
        </section>
        <section class="card">
          <h3>ğŸ’ª å¥åº·è£œçµ¦</h3>
          <div class="content"><ul class="list" id="care-health"></ul></div>
        </section>

        <!-- å›ºå®šé…æ–¹çµ„åˆ -->
        <section class="card">
          <h3>ä¿é¤Šä¸‰ä»¶çµ„ï¼ˆå›ºå®šçµ„åˆï¼‰</h3>
          <div class="content stack">
            <div class="row"><span class="tag">çµ„åˆåƒ¹ $4,980</span></div>
            <ul class="list">
              <li><div class="meta"><span>èƒºåŸºé…¸æ´—é¡æ…•çµ² Ã— 1</span><span class="muted">$680</span></div></li>
              <li><div class="meta"><span>å¤–æ³Œé«”ä¿®è­·ç²¾è¯æ¶² Ã— 1</span><span class="muted">$2,500</span></div></li>
              <li><div class="meta"><span>çš®è„‚è†œä¿®è­·ä¹³éœœ Ã— 1</span><span class="muted">$2,050</span></div></li>
            </ul>
            <div class="row">
              <label class="muted" style="display:inline-flex;align-items:center;gap:6px">
                <span>çµ„æ•¸</span>
                <input type="number" min="1" value="1" id="sets-skin3" style="width:64px;text-align:center;height:28px">
              </label>
              <button class="btn primary" id="add-skin3">åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
          </div>
        </section>
      </div>

      <!-- å³ï¼šè³¼ç‰©è»Šï¼ˆåŒæ­¥ï¼‰ -->
      <!-- å³ï¼šè³¼ç‰©è»Šï¼ˆåŒæ­¥ï¼‰ -->
      <aside class="card cart cart-care">
        <h3>è³¼ç‰©è»Š</h3>
        <div class="content">
          <div id="cartItems-care"></div>
          <div class="muted" id="bundleNotes-care" style="margin-top:6px"></div>
          <hr style="border:none;border-top:1px solid var(--border);margin:8px 0" />
          <div class="row"><span>å°è¨ˆ</span><span class="price" id="subtotal-care">$0</span></div>
          <div class="row"><span>æŠ˜æ‰£</span><span class="price" id="discount-care">$0</span></div>
          <div class="row subtotal"><span>ç¸½è¨ˆ</span><span class="price" id="grandTotal-care">$0</span></div>
          <div class="row" style="gap:8px; margin-top:10px">
            <button class="btn" id="clearCart-care">æ¸…ç©º</button>
            <button class="btn primary" id="submitOrder-care">é€å‡ºè¨‚å–®</button>
          </div>
          <div class="muted">ï¼ˆæ­¤è™•é¡¯ç¤ºèˆ‡ä¸»é è³¼ç‰©è»ŠåŒæ­¥ï¼‰</div>
        </div>
      </aside>

    </div>
  </section>
</div>
  <script>
    /****************** è³‡æ–™ ******************/
    const currency = n => "$" + (n||0).toLocaleString();
    
    // å–®å“ï¼ˆä¸»é ï¼‰
    const singles = [
      { id:"mnt_protein", name:"MNT è›‹ç™½ç²‰", unitPrice:1880 },
      { id:"light_digest", name:"æš¢ä¾¿è¼•", unitPrice:1200 },
      { id:"wei_shijia", name:"è¡›é©ä½³", unitPrice:1200 },
      { id:"jiao_yuan_c", name:"å¬Œåœ“C", unitPrice:1200 },
      { id:"morning_capsule", name:"æ—©å®‰è† å›Š", unitPrice:900 },
      { id:"night_chew", name:"æ™šå®‰å’€åš¼éŒ ", unitPrice:900 },
      { id:"oil_cut", name:"æ²¹æ¾±é›™åˆ‡", unitPrice:600 },
      { id:"elite", name:"å„ªå…ˆç›ˆ", unitPrice:1500 },
      { id:"clean_mouth", name:"æ¸…å£æ¨‚", unitPrice:600 },
      { id:"double_l", name:"é›™Lç›ŠèŒç³–", unitPrice:1200 },
      { id:"fish_oil", name:"é»ƒæ™¶é­šæ²¹", unitPrice:1300 },
      { id:"night_relax", name:"å¤œå…çœ ", unitPrice:1300 },
      { id:"sensitive", name:"å…æ•é€š", unitPrice:1300 },
      { id:"berry", name:"å…åª„è“", unitPrice:1300 }
    ];
    
    // ===== æ–°å¢ï¼šç„¡é½¡é†«å¸«ä¿é¤Šå“ & èŒ¶é£²ï¼ˆç¬¬äºŒé ï¼‰ =====
    const careCatalog = {
      skin: [
        { id:"foam_cleanser", name:"èƒºåŸºé…¸æ´—é¡æ…•çµ²", unitPrice:680 },
        { id:"exo_serum", name:"å¤–æ³Œé«”ä¿®è­·ç²¾è¯æ¶²", unitPrice:2500 },
        { id:"lipid_cream", name:"çš®è„‚è†œä¿®è­·ä¹³éœœ", unitPrice:2050 },
        { id:"tinted_sunscreen", name:"è¼•é€æ½¤è‰²é˜²æ›¬ä¹³", unitPrice:980 },
        { id:"exo_mask_single", name:"å¤–æ³Œé«”ä¿®è­·é¢è†œï¼ˆå–®ç‰‡ï¼‰", unitPrice:180 },
        { id:"exo_mask_box", name:"å¤–æ³Œé«”ä¿®è­·é¢è†œï¼ˆä¸€ç›’5ç‰‡ï¼‰", unitPrice:850 },
      ],
      drink: [
        { id:"yogurt", name:"å…å„ªæ ¼ï¼ˆé™å°åŒ—ç„¡é½¡è‡ªå–ï¼‰", unitPrice:680 },
        { id:"tea_calm", name:"å¥½å¥½å®‰å¿ƒèŒ¶", unitPrice:600 },
        { id:"tea_beauty", name:"ç¾ç¾æ¼‚æ¼‚èŒ¶", unitPrice:600 },
        { id:"tea_energy", name:"æ»¿æ»¿æ´»åŠ›èŒ¶", unitPrice:600 },
      ],
      others: [
        { id:"ketone_device", name:"æ°£é…®æ©Ÿ", unitPrice:3950 },
        { id:"blender_bottle", name:"Blender æ–æ¯", unitPrice:380 },
      ],
      intimate: [
        { id:"intimate_firm", name:"ç§å¯†ç·Šå¯¦ç²¾èƒ", unitPrice:3110 },
        { id:"intimate_clean", name:"ç§å¯†æ·¨æ½¤ç²¾èƒ", unitPrice:1880 },
        { id:"intimate_hyal", name:"ç»å°¿é…¸ç§å¯†éœ²", unitPrice:550 },
      ],
      health: [
        { id:"b1_patch", name:"B1 æ´»åŠ›è²¼ç‰‡", unitPrice:780 },
      ]
    };
    
    const singlesByName = Object.fromEntries(
      [...singles, ...Object.values(careCatalog).flat()].map(s=>[s.name, s.unitPrice])
    );
    
    // å¥—çµ„å®šç¾©ï¼ˆä¸»é ï¼‰â€”æ–°å¢ discount
    const bundleDefs = {
      classic: {
        title:"ç¶“å…¸å¥—çµ„", minPrice:16140, discount:1140,
        items:[
          ["MNT è›‹ç™½ç²‰",3], ["æš¢ä¾¿è¼•",2], ["è¡›é©ä½³",1], ["å¬Œåœ“C",2], ["æ—©å®‰è† å›Š",1], ["æ™šå®‰å’€åš¼éŒ ",1], ["æ²¹æ¾±é›™åˆ‡",1], ["å„ªå…ˆç›ˆ",1], ["æ¸…å£æ¨‚",1], ["4+2R è¿½è¹¤",1]
        ]
      },
      super: {
        title:"è¶…å€¼å‡ç´šå¥—çµ„", minPrice:33340, discount:3340,
        items:[
          ["MNT è›‹ç™½ç²‰",8], ["æš¢ä¾¿è¼•",4], ["è¡›é©ä½³",2], ["å¬Œåœ“C",3], ["æ—©å®‰è† å›Š",2], ["æ™šå®‰å’€åš¼éŒ ",2], ["æ²¹æ¾±é›™åˆ‡",1], ["å„ªå…ˆç›ˆ",1], ["æ¸…å£æ¨‚",1], ["é›™Lç›ŠèŒç³–",1], ["4+2R è¿½è¹¤",2]
        ]
      },
      light: {
        title:"è¼•ç›ˆå¥—çµ„", minPrice:9840, discount:40,
        items:[
          ["MNT è›‹ç™½ç²‰",3], ["æš¢ä¾¿è¼•",1], ["å¬Œåœ“C",1], ["æ—©å®‰è† å›Š",1], ["æ™šå®‰å’€åš¼éŒ ",1], ["4+2R è¿½è¹¤",1]
        ]
      }
    };
    
    // MNT ç½ / è¢‹ é è¨­ï¼ˆç¸½æ•¸åˆ†åˆ¥ç‚º 3 / 8 / 3ï¼‰
    const mntPreset = {
      classic: { can:1, bag:2 },
      super:   { can:3, bag:5 },
      light:   { can:1, bag:2 }
    };
    
    // çµ„åˆï¼ˆä¸»é ï¼‰
    const combos = [
      { id:"mnt3pack", title:"MNT è›‹ç™½ç²‰ 3 å…¥ä»»é¸ï¼ˆç½ï¼è¢‹ï¼‰",
        rule:{ type:"mntCanBagTotalFixed", n:3, fixedPrice:5000, init:{can:1, bag:2} }, product:"MNT è›‹ç™½ç²‰" },
      { id:"mix8", title:"æš¢/è¡›/C/L/é­š/å¤œ/æ•/è“ çµ„åˆ",
        rule:{ type:"pickTierFixed", tiers:[ {n:6, price:6300}, {n:3, price:3300} ] },
        choices:["æš¢ä¾¿è¼•","è¡›é©ä½³","å¬Œåœ“C","é›™Lç›ŠèŒç³–","é»ƒæ™¶é­šæ²¹","å¤œå…çœ ","å…æ•é€š","å…åª„è“"] },
      { id:"earlyLate", title:"æ—©æ™šå®‰çµ„åˆ", rule:{type:"pickNFixed", n:4, fixedPrice:3200}, choices:["æ—©å®‰è† å›Š","æ™šå®‰å’€åš¼éŒ "] },
      { id:"goldOil", title:"é‡‘éŠ€åŒ…çµ„åˆ", rule:{ type:"exactBundleFixed", fixedPrice:5000, items:[ {name:"å„ªå…ˆç›ˆ", qty:3}, {name:"æ²¹æ¾±é›™åˆ‡", qty:2} ] } },
      { id:"gradFav", title:"ç•¢æ¥­ç”Ÿæœ€æ„›çµ„åˆ", rule:{ type:"exactBundleFixed", fixedPrice:6200, items:[ {name:"å„ªå…ˆç›ˆ", qty:3}, {name:"é›™Lç›ŠèŒç³–", qty:2} ] } },
      { id:"tea3", title:"èŒ¶åŒ…ä¸‰å…¥ä»»é¸", rule:{ type:"pickNFixed", n: 3, fixedPrice: 1500 }, choices: ["å¥½å¥½å®‰å¿ƒèŒ¶","ç¾ç¾æ¼‚æ¼‚èŒ¶","æ»¿æ»¿æ´»åŠ›èŒ¶"] }
    ];
    
    /****************** ç‹€æ…‹ ******************/
    const cart = [];
    
    function initialStateFromBundle(key){
      const def = bundleDefs[key];
      const o = {};
      def.items.forEach(([name,qty])=>{
        if(name === "MNT è›‹ç™½ç²‰"){ o[name] = { ...mntPreset[key] }; }
        else{ o[name] = qty; }
      });
      return o;
    }
    const state = {
      classic: initialStateFromBundle('classic'),
      super:   initialStateFromBundle('super'),
      light:   initialStateFromBundle('light')
    };
    // å°‡åƒ "$45,000" æˆ– "-$4,480" çš„é‡‘é¡å­—ä¸²è½‰ç‚ºæ•´æ•¸ï¼ˆå–®ä½ï¼šå…ƒï¼‰
// æœƒè™•ç† $ã€é€—è™Ÿã€ç©ºç™½ã€è² è™Ÿï¼›è‹¥æ˜¯æœƒè¨ˆæ‹¬è™Ÿ "(1,000)" ä¹Ÿç•¶ä½œ -1000
function toCents(text) {
  if (text == null) return 0;
  const s = String(text).trim();
  if (!s) return 0;

  const hasParen = /^\(.*\)$/.test(s);            // æœƒè¨ˆç”¨æ‹¬è™Ÿä»£è¡¨è² æ•¸
  const cleaned  = s.replace(/[^0-9.\-]/g, "");    // ç§»é™¤ $ ã€é€—è™Ÿç­‰ï¼Œåªç•™æ•¸å­—/å°æ•¸é»/è² è™Ÿ
  const num = parseFloat(cleaned);

  if (isNaN(num)) return 0;
  const val = hasParen ? -num : num;

  // ä½ ç›®å‰çš„é‡‘é¡éƒ½æ˜¯æ•´æ•¸å…ƒï¼Œä¿éšªèµ·è¦‹å››æ¨äº”å…¥
  return Math.round(val);
}

// è®“ module script ä¹Ÿèƒ½æ‹¿åˆ°
window.toCents = toCents;

    /****************** å·¥å…· ******************/
    const $ = s=>document.querySelector(s);
    const $$ = s=>[...document.querySelectorAll(s)];
    function bundleSubtotal(key){
      const o = state[key]; let sum = 0;
      for(const [name,qty] of Object.entries(o)){
        if(name === "MNT è›‹ç™½ç²‰"){
          const unit = singlesByName[name]||0;
          const can = (qty && qty.can)? +qty.can : 0;
          const bag = (qty && qty.bag)? +qty.bag : 0;
          sum += (can + bag) * unit;
        }else{
          sum += (singlesByName[name]||0) * (+qty||0);
        }
      }
      return sum;
    }
    
    function setBundleUi(key, subtotal){
      const def = bundleDefs[key];
      const eligible = subtotal >= def.minPrice;
      // æ”¹ã€Œå¯æ­åƒ¹ã€pill â†’ æŠ˜å¾Œåƒ¹
      const pill = $(`#${key}Card .pill`);
      if (pill) pill.textContent = "å¥—çµ„å„ªæƒ ";
      // æŠ˜å¾Œåƒ¹æˆ–ç ´æŠ˜è™Ÿ
      const dealEl = document.getElementById(key+"Deal");
      if (dealEl) dealEl.textContent = eligible ? currency(Math.max(0, subtotal - def.discount)) : "â€”";
      // å•†å“å°è¨ˆ
      const subEl = document.getElementById(key+"Sub");
      if (subEl) subEl.textContent = currency(subtotal);
      // æç¤º
      const hint = document.getElementById(key+"Hint");
      if (hint) {
        hint.textContent = eligible
          ? `å¯æŠ˜ ${currency(def.discount)}ï¼Œæ‡‰ä»˜ ${currency(Math.max(0, subtotal - def.discount))}ã€‚`
          : `æœªé”é–€æª»ï¼ˆéœ€æ»¿ ${currency(def.minPrice)}ï¼‰ï¼Œç„¡æ³•åŠ å…¥æ•´çµ„ã€‚`;
      }
      // æ§åˆ¶æŒ‰éˆ•
      const btn = document.querySelector(`[data-add-bundle='${key}']`);
      if (btn){
        btn.disabled = !eligible;
        btn.title = eligible ? `ç¬¦åˆæŠ˜æ‰£ ${currency(def.discount)}` : `æœªé”é–€æª» ${currency(def.minPrice)}`;
      }
    }
    
    /****************** Renderï¼šä¸‰å€‹å¥—çµ„ï¼ˆä¸»é ï¼‰ ******************/
function renderBundle(key){
  const def = bundleDefs[key];
  const tbody = document.getElementById(key+"Body");
  tbody.innerHTML = def.items.map(([name,qty])=>{
    // 1) MNT ç½/è¢‹ï¼šç¶­æŒåŸæœ¬å¯è¼¸å…¥
    if(name === "MNT è›‹ç™½ç²‰"){
      const cur = state[key][name] || { can:0, bag:0 };
      const total = (+cur.can||0) + (+cur.bag||0);
      return `<tr class="mnt-row">
        <td>
          <span class="mnt-name">${name}</span>
          <div class="mnt-subline">
            <label>ç½ <input type="number" min="0" step="1" value="${cur.can}" data-mnt="${key}:can"></label>
            <label>è¢‹ <input type="number" min="0" step="1" value="${cur.bag}" data-mnt="${key}:bag"></label>
          </div>
        </td>
        <td class="qty"><span class="mnt-qty-total" id="${key}-mnt-total">${total}</span></td>
      </tr>`;
    }

    // 2) 4+2R è¿½è¹¤ï¼šå›ºå®šæ•¸é‡ï¼Œä¸å¯æ›´æ”¹ï¼ˆæ²’æœ‰è¼¸å…¥æ¡†ï¼‰
    if(name === "4+2R è¿½è¹¤"){
      // ä»¥å¥—çµ„å®šç¾©ç‚ºæº–ï¼Œå¼·åˆ¶å¯«å› stateï¼ˆé¿å…è¢«å¤–éƒ¨æ”¹å‹•ï¼‰
      const fixed = qty;
      state[key][name] = fixed;
      return `<tr class="fixed-row">
        <td>${name} <span class="tag">å›ºå®š</span></td>
        <td class="qty"><span class="muted">${fixed}</span></td>
      </tr>`;
    }

    // 3) å…¶ä»–ä¸€èˆ¬å“ï¼šå¯è¼¸å…¥
    const val = state[key][name] ?? qty;
    return `<tr>
      <td>${name}</td>
      <td class="qty"><input type="number" min="0" step="1" value="${val}" data-bq="${key}:${name}" style="width:58px;text-align:center;height:28px"></td>
    </tr>`;
  }).join("");

  // é¦–æ¬¡æ›´æ–° UI
  setBundleUi(key, bundleSubtotal(key));

  // ç¶ä¸€èˆ¬å“ inputï¼ˆä¸æœƒåŒ…å«ã€Œ4+2R è¿½è¹¤ã€ï¼Œå› ç‚ºæ²’æœ‰ inputï¼‰
  $$(`input[data-bq^="${key}:"]`).forEach(i=>{
    i.addEventListener("input",()=>{
      const [k,name] = i.dataset.bq.split(":");
      state[k][name] = Math.max(0, parseInt(i.value||"0")||0);
      setBundleUi(k, bundleSubtotal(k));
    });
  });

  // ç¶ MNT ç½/è¢‹ input
  $$(`input[data-mnt^='${key}:']`).forEach(i=>{
    i.addEventListener('input',()=>{
      const [k,which] = i.dataset.mnt.split(':');
      const obj = state[k]["MNT è›‹ç™½ç²‰"] || {can:0, bag:0};
      obj[which] = Math.max(0, parseInt(i.value||'0')||0);
      state[k]["MNT è›‹ç™½ç²‰"] = obj;

      const total = (+obj.can||0) + (+obj.bag||0);
      const totalEl = document.getElementById(`${k}-mnt-total`);
      if(totalEl) totalEl.textContent = String(total);

      setBundleUi(k, bundleSubtotal(k));
    });
  });
}

    /****************** Renderï¼šä¸»é å–®å“ï¼ˆå¯èª¿æ•´æ•¸é‡ + åŒæ­¥æ›´æ–°è³¼ç‰©è»Šï¼‰ ******************/
function renderSingles(){
  const ul = document.getElementById("singlesList");
  ul.innerHTML = "";

  singles.forEach(s=>{
    const li = document.createElement("li");
    li.innerHTML = `
      <label>
        <span class="left">
          <span class="name">${s.name}</span>
          <span class="muted">${currency(s.unitPrice)}</span>
        </span>
        <input type="number" min="0" value="0" data-single="${s.id}">
      </label>
    `;
    ul.appendChild(li);
  });

  // åº•éƒ¨ï¼šæ›´æ–°è³¼ç‰©è»Šï¼ˆæŠŠç•«é¢ä¸Šçš„æ•¸é‡ã€ŒåŒæ­¥è¦†å¯«ã€åˆ°è³¼ç‰©è»Šï¼‰
  const addRow = document.createElement("div");
  addRow.style = "margin-top:10px; text-align:right";
  addRow.innerHTML = `<button class="btn primary" id="syncSingles">åŠ å…¥è³¼ç‰©è»Š</button>`;
  ul.parentElement.appendChild(addRow);

  // ç¶å®šäº‹ä»¶ï¼šåŒæ­¥ä¸»é å–®å“åˆ°è³¼ç‰©è»Šï¼ˆä¸æ¸…ç©ºè¼¸å…¥æ¡†ï¼‰
  document.getElementById("syncSingles").addEventListener("click", ()=>{
    const inputs = [...document.querySelectorAll("input[data-single]")];

    // å…ˆæŠŠã€Œä¸»é å–®å“ã€é¡åˆ¥çš„èˆŠé …ç›®å¾è³¼ç‰©è»Šç§»é™¤ï¼Œå†ä¾ç•«é¢æ•¸é‡é‡å»ºï¼ˆé¿å…é‡è¤‡ç›¸åŠ ï¼‰
    const mainSingleIds = new Set(singles.map(s=>s.id));
    for(let i = cart.length - 1; i >= 0; i--){
      const c = cart[i];
      if(c.type === 'single' && mainSingleIds.has(c.itemId)){
        cart.splice(i, 1);
      }
    }

    // ä¾ç›®å‰è¼¸å…¥æ¡†çš„æ•¸é‡æ–°å¢åˆ°è³¼ç‰©è»Šï¼ˆæ•¸é‡ç‚º 0 çš„å°±ä¸æ–°å¢ï¼‰
    inputs.forEach(inp=>{
      const qty = Math.max(0, parseInt(inp.value || "0", 10) || 0);
      if(qty > 0){
        const s = singles.find(x => x.id === inp.dataset.single);
        cart.push({
          type:'single',
          itemId:s.id,
          name:s.name,
          unitPrice:s.unitPrice,
          qty
        });
      }
    });

    renderCart(); // é‡æ–°è¨ˆç®—é‡‘é¡èˆ‡é …ç›®
  });
}


    /****************** Renderï¼šçµ„åˆï¼ˆä¸»é ï¼Œåˆ†æµåˆ°ä¸»å®¹å™¨ & å³æ¬„ï¼‰ ******************/
    function renderCombos(){
      const mainWrap  = document.getElementById("combos");
      const rightWrap = document.getElementById("combos-right");
      mainWrap.innerHTML = "";
      if (rightWrap) rightWrap.innerHTML = "";
    
      const RIGHT_COMBO_IDS = new Set(["earlyLate", "goldOil", "gradFav", "tea3"]);
      const appendBlock = (el) => (container) => container && container.appendChild(el);
    
      combos.forEach(c=>{
        const target = RIGHT_COMBO_IDS.has(c.id) ? rightWrap : mainWrap;
    
        if(c.rule.type === "mntCanBagTotalFixed"){
          const id = c.id, n=c.rule.n;
          const initCan = (c.rule.init && c.rule.init.can) || 0;
          const initBag = (c.rule.init && c.rule.init.bag) || 0;
    
          const block = document.createElement("div");
          block.className = "card combo-block";
          block.innerHTML = `<div class="content">
            <div class="row" style="margin-bottom:6px">
              <b>${c.title}</b>
              <span class="tag">${n} å…¥ä»»é¸ / çµ„åˆåƒ¹ ${currency(c.rule.fixedPrice)}</span>
            </div>
            <div class="row mntpack-row" style="margin:6px 0"><span>${c.product}ï¼ˆç½ï¼‰</span><input type="number" min="0" value="${initCan}" data-mntpack="${id}:can" style="width:58px;text-align:center;height:28px"></div>
            <div class="row mntpack-row" style="margin:6px 0"><span>${c.product}ï¼ˆè¢‹ï¼‰</span><input type="number" min="0" value="${initBag}" data-mntpack="${id}:bag" style="width:58px;text-align:center;height:28px"></div>
            <div class="row" style="margin-top:6px">
              <div class="muted">ç¸½è¨ˆ <b id="cnt-${id}">${initCan+initBag}</b> / ${n}</div>
              <button class="btn primary" data-add-mntpack="${id}" ${(initCan+initBag)===n? "":"disabled"}>åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
          </div>`;
          appendBlock(block)(target);
    
          const canInput = document.querySelector(`input[data-mntpack='${id}:can']`);
          const bagInput = document.querySelector(`input[data-mntpack='${id}:bag']`);
          const btn = document.querySelector(`[data-add-mntpack='${id}']`);
          const cnt = document.getElementById(`cnt-${id}`);
          const update=()=>{
            const can=+canInput.value||0, bag=+bagInput.value||0, sum=can+bag;
            cnt.textContent=String(sum); btn.disabled = sum!==n;
          };
          canInput.addEventListener('input',update);
          bagInput.addEventListener('input',update);
          btn.addEventListener('click', ()=>{
            const can=+canInput.value||0, bag=+bagInput.value||0;
            const selections=[]; if(can>0) selections.push({name:`${c.product}ï¼ˆç½ï¼‰`, qty:can});
            if(bag>0) selections.push({name:`${c.product}ï¼ˆè¢‹ï¼‰`, qty:bag});
            cart.push({ type:'combo', name:c.title, rule:c.rule, selections, qty:1 });
            canInput.value=c.rule.init?.can||0; bagInput.value=c.rule.init?.bag||0; update(); renderCart();
          });
          update(); return;
        }
    
        if (c.rule.type === "pickTierFixed") {
          const id = c.id;
          const [tierA, tierB] = c.rule.tiers;
          const block = document.createElement("div");
          block.className = "card combo-block";
          block.innerHTML = `
            <div class="content">
              <div class="row" style="margin-bottom:6px">
                <b>${c.title}</b>
                <span class="tag" id="tag-${id}">${tierA.n} å…¥ä»»é¸ / çµ„åˆåƒ¹ ${currency(tierA.price)}</span>
              </div>
              <div class="row" style="gap:16px; margin:6px 0 10px">
                <label style="display:inline-flex;align-items:center;gap:6px">
                  <input type="radio" name="tier-${id}" value="0" checked>
                  <span>${tierA.n} å…¥ / ${currency(tierA.price)}</span>
                </label>
                <label style="display:inline-flex;align-items:center;gap:6px">
                  <input type="radio" name="tier-${id}" value="1">
                  <span>${tierB.n} å…¥ / ${currency(tierB.price)}</span>
                </label>
              </div>
              <div id="qtywrap-${id}" style="display:flex; flex-direction:column; gap:10px; margin-bottom:8px">
                ${c.choices.map(name=>{
                  const unit = singlesByName[name]||0;
                  const safeId = `${id}:${name}`;
                  const showUnitPrice = id !== "mix8";
                  return `
                    <label style="display:flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius:8px; padding:6px 8px; justify-content:space-between">
                      <span>${name}${showUnitPrice ? ` <span class="muted">${currency(unit)}</span>` : ""}</span>
                      <input type="number" min="0" value="0" data-qty="${safeId}" style="width:64px; text-align:center; height:28px">
                    </label>
                  `;
                }).join("")}
              </div>
              <div class="row" style="margin-top:6px">
                <div class="muted">å·²é¸ <b id="cnt-${id}">0</b> / <span id="need-${id}">${tierA.n}</span></div>
                <button class="btn primary" data-add-mix8="${id}" disabled>åŠ å…¥è³¼ç‰©è»Š</button>
              </div>
            </div>`;
          appendBlock(block)(target);
    
          const radios = [...document.querySelectorAll(`input[name='tier-${id}']`)];
          const qtyInputs = [...document.querySelectorAll(`input[data-qty^='${id}:']`)];
          const tagEl  = document.getElementById(`tag-${id}`);
          const cntEl  = document.getElementById(`cnt-${id}`);
          const needEl = document.getElementById(`need-${id}`);
          const addBtn = document.querySelector(`[data-add-mix8='${id}']`);
    
          let currentTier = 0; // 0 -> 6å…¥, 1 -> 3å…¥
          const need = () => currentTier === 0 ? tierA.n : tierB.n;
          const price = () => currentTier === 0 ? tierA.price : tierB.price;
          const sumQty = () => qtyInputs.reduce((s, i) => s + (+i.value || 0), 0);
    
          const update = () => {
            const selected = sumQty();
            cntEl.textContent = String(selected);
            needEl.textContent = String(need());
            addBtn.disabled = selected !== need();
            tagEl.textContent = `${need()} å…¥ä»»é¸ / çµ„åˆåƒ¹ ${currency(price())}`;
          };
    
          radios.forEach(r => r.addEventListener('change', () => {
            currentTier = +r.value;
            qtyInputs.forEach(i => i.value = "0");
            update();
          }));
          qtyInputs.forEach(i => i.addEventListener('input', () => {
            const v = Math.max(0, parseInt(i.value || "0", 10) || 0);
            i.value = String(v);
            update();
          }));
          addBtn.addEventListener('click', () => {
            const selections = qtyInputs
              .map(i => ({ name: i.dataset.qty.split(':')[1], qty: +i.value || 0 }))
              .filter(s => s.qty > 0);
            cart.push({
              type: 'combo',
              name: `${c.title}ï¼ˆ${need()}å…¥ï¼‰`,
              rule: { fixedPrice: price() },
              selections,
              qty: 1
            });
            qtyInputs.forEach(i => i.value = "0");
            update();
            renderCart();
          });
          update();
          return;
        }
    
        if(c.rule.type === "pickNFixed"){
          const id = c.id;
          const block = document.createElement("div");
          block.className = "card combo-block";
          block.innerHTML = `<div class="content">
            <div class="row" style="margin-bottom:6px"><b>${c.title}</b><span class="tag">${c.rule.n} å…¥ä»»é¸ / çµ„åˆåƒ¹ ${currency(c.rule.fixedPrice)}</span></div>
            ${c.choices.map(name=>{
              const unit = singlesByName[name]||0;
              return `<div class="row" style="margin:6px 0">
                <span>${name} <span class="muted">${currency(unit)}</span></span>
                <input type="number" min="0" value="0" data-choice="${id}:${name}" style="width:58px;text-align:center;height:28px">
              </div>`;
            }).join("")}
            <div class="row" style="margin-top:6px">
              <div class="muted">å·²é¸ <b id="cnt-${id}">0</b> / ${c.rule.n}</div>
              <button class="btn primary" data-add-combo="${id}" disabled>åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
          </div>`;
          appendBlock(block)(target);
    
          const inputs = [...document.querySelectorAll(`input[data-choice^='${id}:']`)];
          const btn = document.querySelector(`[data-add-combo='${id}']`);
          const cnt = document.getElementById(`cnt-${id}`);
          const update=()=>{
            const sum = inputs.reduce((s,i)=> s + (+i.value||0), 0);
            cnt.textContent = String(sum); btn.disabled = sum !== c.rule.n;
          };
          inputs.forEach(i=> i.addEventListener('input', update));
          btn.addEventListener('click', ()=>{
            const selections = inputs.map(i=>({name: i.dataset.choice.split(':')[1], qty: +i.value||0})).filter(x=>x.qty>0);
            cart.push({ type:'combo', name:c.title, rule:c.rule, selections, qty:1 });
            inputs.forEach(i=> i.value = 0); update(); renderCart();
          });
          update(); return;
        }
    
        if (c.rule.type === "exactBundleFixed") {
          const id=c.id;
          const block=document.createElement("div"); block.className="card";
          block.innerHTML=`<div class="content">
            <div class="row" style="margin-bottom:6px"><b>${c.title}</b><span class="tag">å›ºå®šçµ„åˆ / çµ„åˆåƒ¹ ${currency(c.rule.fixedPrice)}</span></div>
            <ul class="list" style="margin-bottom:8px">
              ${c.rule.items.map(it => `<li><div class="meta"><span>${it.name} Ã— ${it.qty}</span><span class="muted">å–®åƒ¹ ${currency(singlesByName[it.name]||0)}</span></div></li>`).join("")}
            </ul>
            <div class="row" style="margin-top:6px">
              <label class="muted" style="display:inline-flex;align-items:center;gap:6px"><span>çµ„æ•¸</span><input type="number" min="1" value="1" id="sets-${id}" style="width:64px;text-align:center;height:28px"></label>
              <button class="btn primary" data-add-exact="${id}">åŠ å…¥è³¼ç‰©è»Š</button>
            </div>
          </div>`;
          appendBlock(block)(target);
    
          const addBtn = document.querySelector(`[data-add-exact='${id}']`);
          const setsInput = document.getElementById(`sets-${id}`);
          addBtn.addEventListener("click", () => {
            const sets = Math.max(1, parseInt(setsInput.value || "1", 10));
            const selections = c.rule.items.map(it => ({ name: it.name, qty: it.qty }));
            cart.push({ type:"combo", name:c.title, rule:{ fixedPrice:c.rule.fixedPrice }, selections, qty:sets });
            setsInput.value = "1"; renderCart();
          });
          return;
        }
      });
    }
    
    /****************** Renderï¼šç¬¬äºŒé å•†å“æ¸…å–®ï¼ˆæ”¹ç‚ºè¼¸å…¥æ•¸é‡ï¼‹ä¸€æ¬¡åŠ å…¥ï¼‰ ******************/
function renderCareLists(){
  // å…±ç”¨ï¼šæŠŠæŸåˆ†é¡æ¸²æŸ“æˆã€Œåç¨±ï¼‹å–®åƒ¹ï¼‹æ•¸é‡è¼¸å…¥ã€
  const fill = (elId, items) => {
    const ul = document.getElementById(elId);
    ul.innerHTML = "";
    items.forEach(s => {
      const li = document.createElement("li");
      li.innerHTML = `
        <div class="meta">
          <span>${s.name}</span>
          <span class="muted">${currency(s.unitPrice)}</span>
        </div>
        <input type="number" min="0" value="0"
               data-care-qty="${s.id}" style="width:64px; text-align:center; height:28px">
      `;
      ul.appendChild(li);
    });

    // æ¯å€‹å€å¡Šåº•éƒ¨éƒ½åŠ ä¸€æ’å‹•ä½œæ¬„ï¼ˆå¯åªç•™åœ¨ç¬¬ä¸€å€‹å€å¡Šï¼›é€™è£¡æ¯å€‹å€å¡Šéƒ½æ”¾ä¸€é¡†ä¹ŸOKï¼‰
    const action = document.createElement("div");
    action.style = "margin-top:10px; text-align:right";
    action.innerHTML = `<button class="btn primary" data-sync-care="true">åŠ å…¥è³¼ç‰©è»Š</button>`;
    ul.parentElement.appendChild(action);
  };

  fill("care-skin",   careCatalog.skin);
  fill("care-drink",  careCatalog.drink);
  fill("care-others", careCatalog.others);
  fill("care-intimate", careCatalog.intimate);
  fill("care-health", careCatalog.health);

  // ç›£è½æ‰€æœ‰ã€ŒåŠ å…¥å–®å“ã€æŒ‰éˆ•ï¼ˆä»»ä¸€é¡†éƒ½åšåŒæ¨£å‹•ä½œï¼‰
  $$("[data-sync-care]").forEach(btn => btn.addEventListener("click", () => {
    // 1) å…ˆæŠŠã€Œç¬¬äºŒé çš„å–®å“ã€å¾è³¼ç‰©è»Šæ¸…æ‰ï¼ˆé¿å…é‡è¤‡ç›¸åŠ ï¼›æ¡ç”¨è¦†å¯«èªæ„ï¼‰
    const careIds = new Set(Object.values(careCatalog).flat().map(s => s.id));
    for (let i = cart.length - 1; i >= 0; i--) {
      const c = cart[i];
      if (c.type === "single" && careIds.has(c.itemId)) {
        cart.splice(i, 1);
      }
    }

    // 2) é‡æ–°ä¾ç•«é¢ä¸Šçš„æ•¸é‡å»ºç«‹è³¼ç‰©è»Šæ¢ç›®ï¼ˆæ•¸é‡=0 å°±ç•¥éï¼‰
    const inputs = [...document.querySelectorAll("input[data-care-qty]")];
    inputs.forEach(inp => {
      const qty = Math.max(0, parseInt(inp.value || "0", 10) || 0);
      if (qty > 0) {
        // æ‰¾åˆ°è©² id å°æ‡‰çš„å•†å“å®šç¾©
        const s = Object.values(careCatalog).flat().find(x => x.id === inp.dataset.careQty);
        if (s) {
          cart.push({
            type: "single",
            itemId: s.id,
            name: s.name,
            unitPrice: s.unitPrice,
            qty
          });
        }
      }
    });

    // 3) é‡æ–°æ¸²æŸ“è³¼ç‰©è»Šï¼ˆå³å´èˆ‡ä¸»é åŒæ­¥ï¼‰ï¼›è¼¸å…¥æ¡†ä¸æ¸…ç©º
    renderCart();
  }));

  // ä¿é¤Šä¸‰ä»¶çµ„ï¼ˆå›ºå®š $4,980ï¼‰ç¶­æŒåŸé‚è¼¯
  const addSkin3 = document.getElementById('add-skin3');
  const setsSkin3 = document.getElementById('sets-skin3');
  addSkin3.addEventListener('click', () => {
    const sets = Math.max(1, parseInt(setsSkin3.value || "1", 10));
    const selections = [
      { name:"èƒºåŸºé…¸æ´—é¡æ…•çµ²", qty:1 },
      { name:"å¤–æ³Œé«”ä¿®è­·ç²¾è¯æ¶²", qty:1 },
      { name:"çš®è„‚è†œä¿®è­·ä¹³éœœ", qty:1 },
    ];
    cart.push({ type:'combo', name:'ä¿é¤Šä¸‰ä»¶çµ„', rule:{ fixedPrice:4980 }, selections, qty:sets });
    // ä¸å½±éŸ¿å–®å“è¼¸å…¥æ¡†
    setsSkin3.value = "1";
    renderCart();
  });
}

    
    /****************** Renderï¼šè³¼ç‰©è»Šï¼ˆåŒæ­¥åˆ°å…©é çš„é¡¯ç¤ºå€ï¼‰ ******************/
    function renderCart(){
      const boxMain = document.getElementById('cartItems'); if(boxMain) boxMain.innerHTML = '';
      const boxCare = document.getElementById('cartItems-care'); if(boxCare) boxCare.innerHTML = '';
    
      let gross = 0;           // æŠ˜æ‰£å‰å°è¨ˆ
      let discountTotal = 0;   // æŠ˜æ‰£ç¸½é¡ï¼ˆæ­£æ•¸ï¼‰
    
      cart.forEach((ci, idx)=>{
        const rowHTMLSingle = (line)=>`
          <div><div class='name'>å–®å“ï½œ${ci.name}</div><div class='muted'>å–®åƒ¹ ${currency(ci.unitPrice)}</div></div>
          <div class='right'>
            <div class='qtyctl'>
              <button class='btn' data-dec='${idx}'>âˆ’</button>
              <span>${ci.qty}</span>
              <button class='btn' data-inc='${idx}'>ï¼‹</button>
              <button class='btn' data-del='${idx}' title='åˆªé™¤'>âœ•</button>
            </div>
            <div class='price'>${currency(line)}</div>
          </div>`;
    
        const rowHTMLBundle = (netLine,unitSub,unitDisc,sel)=>`
          <div>
            <div class='name'>å¥—çµ„ï½œ${ci.name}</div>
            ${sel?`<div class='muted'>${sel}</div>`:''}
            <div class='muted'>æ¯çµ„å°è¨ˆ ${currency(unitSub)}ï¼›ç¬¦åˆæŠ˜æ‰£ âˆ’${currency(unitDisc)}</div>
          </div>
          <div class='right'>
            <div class='qtyctl'>
              <button class='btn' data-dec='${idx}'>âˆ’</button>
              <span>${ci.qty}</span>
              <button class='btn' data-inc='${idx}'>ï¼‹</button>
              <button class='btn' data-del='${idx}' title='åˆªé™¤'>âœ•</button>
            </div>
            <div class='price'>${currency(netLine)}</div>
          </div>`;
    
        const rowHTMLCombo = (line,seltext)=>`
          <div>
            <div class='name'>çµ„åˆï½œ${ci.name}</div>
            <div class='muted'>${seltext}</div>
            <span class='tag'>çµ„åˆåƒ¹ ${currency(ci.rule.fixedPrice)} / çµ„</span>
          </div>
          <div class='right'>
            <div class='qtyctl'>
              <button class='btn' data-dec='${idx}'>âˆ’</button>
              <span>${ci.qty}</span>
              <button class='btn' data-inc='${idx}'>ï¼‹</button>
              <button class='btn' data-del='${idx}' title='åˆªé™¤'>âœ•</button>
            </div>
            <div class='price'>${currency(line)}</div>
          </div>`;
    
        let row;
        if(ci.type==='single'){
          const unitLine = ci.unitPrice;
          gross += unitLine * ci.qty;
          const net = unitLine * ci.qty;
          row = document.createElement('div'); row.className='cart-item'; row.innerHTML = rowHTMLSingle(net);
        } else if(ci.type==='bundle'){
          // æ¯çµ„ï¼šunitSubtotal âˆ’ unitDiscountï¼ˆå·²åœ¨åŠ å…¥æ™‚ç¢ºèªé–€æª»ï¼‰
          const unitSub = ci.unitSubtotal;
          const unitDisc = ci.unitDiscount;
          gross += unitSub * ci.qty;
          discountTotal += unitDisc * ci.qty;
          const net = (unitSub - unitDisc) * ci.qty;
          const sel = ci.selections?.map(s=>`${s.name}Ã—${s.qty}`).join('ã€') || '';
          row = document.createElement('div'); row.className='cart-item'; row.innerHTML = rowHTMLBundle(net,unitSub,unitDisc,sel);
        } else { // combo
          const unit = ci.rule.fixedPrice;
          gross += unit * ci.qty;
          const net = unit * ci.qty;
          const seltext = ci.selections.map(s=>`${s.name}Ã—${s.qty}`).join('ã€');
          row = document.createElement('div'); row.className='cart-item'; row.innerHTML = rowHTMLCombo(net,seltext);
        }
    
        if(boxMain) boxMain.appendChild(row.cloneNode(true));
        if(boxCare) boxCare.appendChild(row);
      });
    
      const syncMoney = (suf)=>{
        const $sub = document.getElementById('subtotal'+suf);
        const $dis = document.getElementById('discount'+suf);
        const $tot = document.getElementById('grandTotal'+suf);
        const $note= document.getElementById('bundleNotes'+suf);
        if($sub) $sub.textContent = currency(gross);
        if($dis) $dis.textContent = '-' + currency(discountTotal);
        if($tot) $tot.textContent = currency(Math.max(0, gross - discountTotal));
        if($note) $note.textContent = discountTotal>0 ? 'å·²å¥—ç”¨å¥—çµ„æ»¿é¡æŠ˜æ‰£ã€‚' : '';
      };
      syncMoney('');
      syncMoney('-care');
    
      $$('[data-inc]').forEach(b=> b.addEventListener('click',()=>{ cart[+b.dataset.inc].qty++; renderCart(); }));
      $$('[data-dec]').forEach(b=> b.addEventListener('click',()=>{ const i=+b.dataset.dec; cart[i].qty=Math.max(1, cart[i].qty-1); renderCart(); }));
      $$('[data-del]').forEach(b=> b.addEventListener('click',()=>{ cart.splice(+b.dataset.del,1); renderCart(); }));
    }
    
    /****************** æ“ä½œï¼šåŠ å…¥å¥—çµ„ï¼ˆä¸»é ï¼‰ ******************/
   /****************** æ“ä½œï¼šåŠ å…¥å¥—çµ„ï¼ˆä¸»é ï¼‰ ******************/
function addBundle(key){
  const def = bundleDefs[key];

  // 1) å…ˆæŠŠ state è½‰æˆ selections
  const selections = [];
  Object.entries(state[key]).forEach(([name, qty]) => {
    if (name === 'MNT è›‹ç™½ç²‰' && qty && typeof qty === 'object') {
      const unitPrice = singlesByName[name] || 0;
      const can = Math.max(0, +qty.can || 0);
      const bag = Math.max(0, +qty.bag || 0);

      // â­ é—œéµï¼šæŠŠã€Œç½ã€èˆ‡ã€Œè¢‹ã€æ‹†æˆå…©å€‹å“é …
      if (can > 0) selections.push({ name: 'MNT è›‹ç™½ç²‰ï¼ˆç½ï¼‰', qty: can, unitPrice });
      if (bag > 0) selections.push({ name: 'MNT è›‹ç™½ç²‰ï¼ˆè¢‹ï¼‰', qty: bag, unitPrice });
    } else {
      const q = Math.max(0, +qty || 0);
      if (q > 0) selections.push({ name, qty: q, unitPrice: singlesByName[name] || 0 });
    }
  });

  // 2) è¨ˆç®—å°è¨ˆï¼ˆæ³¨æ„ï¼šMNT å·²ç¶“æ‹†æˆå…©é …ï¼Œæ‰€ä»¥ç›´æ¥åŠ ç¸½ selections å³å¯ï¼‰
  const sub = selections.reduce((s, x) => s + x.qty * x.unitPrice, 0);

  // 3) æœªé”é–€æª»ä¸å¯åŠ å…¥
  if (sub < def.minPrice){
    alert(`ã€Œ${def.title}ã€æœªé”é–€æª»ï¼ˆéœ€æ»¿ $${def.minPrice.toLocaleString()}ï¼‰ï¼Œç„¡æ³•åŠ å…¥æ•´çµ„ã€‚`);
    return;
  }

  // 4) åŠ å…¥è³¼ç‰©è»Šï¼ˆæ¯æ¬¡åŠ å…¥ç¨ç«‹ä¸€ç­†ï¼‰
  cart.push({
    type: 'bundle',
    bundleKey: key,
    name: def.title,
    unitSubtotal: sub,
    unitDiscount: def.discount,
    selections,    // â­ é€™è£¡çš„ selections æœƒå¸¶è‘—ã€Œç½ï¼è¢‹ã€åˆ†é–‹
    qty: 1
  });

  renderCart();
}

    
    /****************** åˆ†é åˆ‡æ› & é€å‡º/æ¸…ç©º ******************/
    function wireActions(){
      document.getElementById('clearCart').addEventListener('click', ()=>{ cart.length=0; renderCart(); });
      document.getElementById('submitOrder').addEventListener('click', submitOrder);
    
      document.getElementById('clearCart-care').addEventListener('click', ()=>{ cart.length=0; renderCart(); });
      document.getElementById('submitOrder-care').addEventListener('click', submitOrder);
    
      $$('[data-tab]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          $$('[data-tab]').forEach(b=> b.classList.remove('active'));
          btn.classList.add('active');
          const target = btn.dataset.tab;
          const showMain = (target==='main');
          document.getElementById('page-main').style.display = showMain? '' : 'none';
          document.getElementById('page-main').setAttribute('aria-hidden', String(!showMain));
          document.getElementById('page-care').style.display = showMain? 'none' : '';
          document.getElementById('page-care').setAttribute('aria-hidden', String(showMain));
          renderCart();
        });
      });
    }
    function submitOrder(){
      if(cart.length===0){ alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„'); return; }
      const payload = { orderNo: document.getElementById('orderNo').textContent, items: cart };
      console.log('é€å‡ºè¨‚å–®ï¼š', payload); 
    }
    
    /****************** å•Ÿå‹• ******************/
    function init(){
      const d = new Date();
      document.getElementById('today').textContent = d.toLocaleDateString('zh-TW');
      document.getElementById('orderNo').textContent = 'DR-' + d.getFullYear().toString().slice(2) + (d.getMonth()+1+'').padStart(2,'0') + d.getDate().toString().padStart(2,'0') + '-' + Math.floor(Math.random()*900+100);
    
      ['classic','super','light'].forEach(renderBundle);
      $$('[data-add-bundle]').forEach(btn=> btn.addEventListener('click',()=> addBundle(btn.dataset.addBundle)));
    
      renderSingles();
      renderCombos();
      renderCareLists();
      renderCart();
      wireActions();
    }
    document.addEventListener('DOMContentLoaded', init);

    
    </script>
    <script type="module">
      const {
  auth, db, addDoc, collection,
  serverTimestamp, signInAnonymously, onAuthStateChanged,
  doc, writeBatch
} = window.__fb;


// 1) åŒ¿åç™»å…¥
signInAnonymously(auth).catch(console.error);

// ğŸ§© å°ä¿éšªï¼šç­‰ç™»å…¥å®Œæˆå†é–‹å•Ÿã€Œé–‹å§‹é¸è³¼ã€æŒ‰éˆ•
const startBtn = document.querySelector('#customer-form button[type="submit"]');
startBtn.disabled = true;
onAuthStateChanged(auth, (user) => {
  if (user) startBtn.disabled = false;
});

// DOM
const gateEl = document.getElementById('customer-gate');
const shopEl = document.getElementById('shop-root');
// âœ… åœ¨é€™è£¡æ’å…¥ä»˜æ¬¾æ–¹å¼åˆ‡æ›ç¨‹å¼ç¢¼
const payRemit   = document.getElementById('pay-remit');
const payCash    = document.getElementById('pay-cash');   // å¯èƒ½ä¸å­˜åœ¨
const last5Wrap  = document.getElementById('last5-wrap');
const remitLast5 = document.getElementById('remit-last5');

function updateLast5Required(){
  const isRemit = !!payRemit && payRemit.checked;
  last5Wrap.style.display = isRemit ? '' : 'none';
  remitLast5.required = isRemit;
  if (!isRemit) remitLast5.value = '';
}

if (payRemit) payRemit.addEventListener('change', updateLast5Required);
if (payCash)  payCash.addEventListener('change',  updateLast5Required); // åªæœ‰å­˜åœ¨æ‰ç¶

updateLast5Required(); // åˆå§‹åŒ–

      // âœ… å·¥å…·ï¼šæ­£è¦åŒ–è³‡æ–™ï¼ˆé›»è©±æ·¨åŒ–ã€Email å°å¯«ã€èº«åˆ†è­‰å¤§å¯«ï¼‰
      const normalizeInfo = (raw) => ({
  name: raw.name.trim(),
  phone: raw.phone.replace(/[^\d+]/g, ''), // åªç•™æ•¸å­—èˆ‡ +
  email: raw.email.trim().toLowerCase(),
  nationalId: raw.nationalId.trim().toUpperCase(),
  address: (raw.address ?? '').trim(),
  payMethod: raw.payMethod === 'cash' ? 'cash' : 'remit',
  remitLast5: (raw.remitLast5 ?? '').trim(),
});

    
      // âœ… æŸ¥é‡ï¼šä¸‰æ¢ä»¶ä»»ä¸€å‘½ä¸­å³è¦–ç‚ºã€Œå·²å­˜åœ¨ã€
      async function customerExists({ phone, email, nationalId }) {
        const customersRef = collection(db, 'customers');
    
        const [qPhoneSnap, qEmailSnap, qNidSnap] = await Promise.all([
          getDocs(query(customersRef, where('phone', '==', phone))),
          getDocs(query(customersRef, where('email', '==', email))),
          getDocs(query(customersRef, where('nationalId', '==', nationalId))),
        ]);
    
        return !qPhoneSnap.empty || !qEmailSnap.empty || !qNidSnap.empty;
      }
    
      // â— ä¸å†å› ç‚º localStorage æœ‰è³‡æ–™å°±è‡ªå‹•æ”¾è¡Œ
      // è®“æ¯æ¬¡é€²å…¥éƒ½å¿…é ˆé€šé Gate + æŸ¥é‡
      gateEl.style.display = '';
      shopEl.style.display = 'none';
    
      // 2) Gateï¼šæäº¤è¡¨å–® â†’ å…ˆæŸ¥é‡ â†’ è‹¥æœªé‡è¤‡å°±ã€Œå»ºç«‹ customers æª”æ¡ˆã€ä¸¦æ”¾è¡Œ
      document.getElementById('customer-form').addEventListener('submit', async (e) => {
  e.preventDefault();

  const infoRaw = {
  name:  document.getElementById('cust-name').value || '',
  phone: document.getElementById('cust-phone').value || '',
  email: document.getElementById('cust-email').value || '',
  nationalId: document.getElementById('cust-nid').value || '',
  address: document.getElementById('cust-address')?.value || '',
  payMethod: document.querySelector('input[name="payMethod"]:checked')?.value || 'remit',
  remitLast5: document.getElementById('remit-last5')?.value || '',
};

// åŸºæœ¬å¿…å¡«
if (!infoRaw.name.trim() || !infoRaw.phone.trim() || !infoRaw.email.trim() || !infoRaw.nationalId.trim() || !infoRaw.address.trim()) {
  alert('è«‹å®Œæ•´å¡«å¯«è³‡æ–™'); return;
}
// åŒ¯æ¬¾ â†’ å¾Œäº”ç¢¼å¿…å¡«ä¸”ç‚º 5 ä½æ•¸å­—
if (infoRaw.payMethod === 'remit' && !/^\d{5}$/.test(infoRaw.remitLast5)) {
  alert('è«‹è¼¸å…¥ 5 ä½æ•¸å­—çš„åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼'); return;
}

  

  const info = normalizeInfo(infoRaw); // ä½ å‰é¢å·²å®šç¾©çš„ normalizeInfo

  try {
    // ğŸ§© åŸå­æ‰¹æ¬¡ï¼šå»ºç«‹ 3 å€‹å”¯ä¸€éµ + 1 å€‹ customer
    const batch = writeBatch(db);

    // å›ºå®š ID çš„ docï¼šè‹¥å·²å­˜åœ¨ï¼Œé€™æ¬¡ set æœƒè¢«è¦–ç‚º updateï¼Œè¦å‰‡ä¸å…è¨± update â†’ æ‰¹æ¬¡å¤±æ•—
    const phoneRef = doc(db, 'phoneKeys', info.phone);
    const emailRef = doc(db, 'emailKeys', info.email);
    const nidRef   = doc(db, 'nidKeys', info.nationalId);

    const customersRef = collection(db, 'customers');
    const custRef = doc(customersRef); // å…ˆç”¢ä¸€å€‹æ–°çš„è‡ªå‹• ID

    const stamp = serverTimestamp();

    batch.set(phoneRef, { createdAt: stamp, customerRef: custRef.path });
    batch.set(emailRef, { createdAt: stamp, customerRef: custRef.path });
    batch.set(nidRef,   { createdAt: stamp, customerRef: custRef.path });

    batch.set(custRef, {
      ...info,
      createdAt: stamp,
      source: 'gate',
    });

    await batch.commit();  // âœ… å…¨éƒ¨æˆåŠŸæ‰æœƒçœŸçš„å¯«é€²å»

    // æœ¬åœ°ä¿å­˜ï¼Œé€²å…¥å•†åº—
    localStorage.setItem('customerInfo', JSON.stringify(info));
    gateEl.style.display = 'none';
    shopEl.style.display = '';
  } catch (err) {
    console.error(err);
    // è¦å‰‡æ‹’çµ•ï¼ˆå¸¸è¦‹ codeï¼špermission-deniedï¼‰â†’ å¤šåŠæ˜¯æŸå€‹å”¯ä¸€éµå·²å­˜åœ¨
    if (err?.code === 'permission-denied') {
      alert('è³‡æ–™é‡è¤‡ï¼šé›»è©± / Email / èº«åˆ†è­‰å…¶ä¸­ä¸€é …å·²å­˜åœ¨æ–¼èˆŠè³‡æ–™ï¼Œç„¡æ³•é€²å…¥è³¼ç‰©ã€‚');
    } else {
      alert('é©—è­‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
    }
  }
});

    
      // 3) è¦†å¯« submitOrderï¼ˆæ²¿ç”¨ä½ åŸæœ¬è¡Œç‚ºï¼›æ­¤æ®µä¸è®Šï¼‰
      const _origSubmitOrder = window.submitOrder;
      window.submitOrder = async function () {
        if (cart.length === 0) { alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„'); return; }
    
        const info = JSON.parse(localStorage.getItem('customerInfo') || 'null');
        if (!info?.name || !info?.phone || !info?.email || !info?.nationalId) {
          alert('è«‹å…ˆå¡«å¯«é¡§å®¢åŸºæœ¬è³‡æ–™');
          gateEl.style.display = '';
          shopEl.style.display = 'none';
          return;
        }
    
        const orderNo = document.getElementById('orderNo').textContent;
        const payload = {
          orderNo,
          customer: info,
          items: JSON.parse(JSON.stringify(cart)),
          totals: {
            subtotalCents: toCents(document.getElementById('subtotal').textContent),
            discountCents: toCents(document.getElementById('discount').textContent),
            grandCents:    toCents(document.getElementById('grandTotal').textContent),
          },
          createdAt: serverTimestamp(),
          from: "github-pages/index.html"
        };
    
        try {
          await addDoc(collection(db, 'orders'), payload);
          console.log('é€å‡ºè¨‚å–®ï¼š', payload);
          alert('å·²é€å‡ºï¼æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„è¨‚å–®ã€‚');
    
          cart.length = 0;
          renderCart();
        } catch (err) {
          console.error(err);
          alert('é€å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      };
    </script>
    
    
</body>
</html>
