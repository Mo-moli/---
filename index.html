<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é†«å¸«å‹¾é¸å–®ï¼ˆåœ–ç‰‡åƒç´ ç´šæ’ç‰ˆï½œMNT ç½/è¢‹ï¼‰ï½œç´”å‰ç«¯ç‰ˆ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#1b2430; --muted:#6b7280; --bg:#f7f7f9; --panel:#ffffff; --border:#e5e7eb;
    --head:#2c3446; --head-text:#e5e7ee; --tab:#eef2f7; --price:#0f172a;
    --pill-bg:#e8eefc; --pill-text:#3556c6; --warn:#b45309;
    --tab-active:#4b5569; --tab-active-text:#fff;
    --page-max: 1600px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    letter-spacing:.2px;
  }
  .topbar{ background:var(--head); color:var(--head-text); padding:10px 16px 6px; border-bottom:4px solid #424c64; }
  .topbar .title{ font-weight:900; letter-spacing:2px; font-size:26px; text-align:center }
  .topbar .meta{ display:flex; justify-content:flex-end; gap:18px; margin-top:4px; font-size:13px; opacity:.95 }
  .tabs{ background:#f0f2f7; border-bottom:1px solid var(--border) }
  .tabs .wrap{ display:flex; gap:8px; padding:8px 12px; max-width:1180px; margin:0 auto }
  .tabbtn{ appearance:none; border:1px solid var(--border); background:#fff; color:var(--ink); padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600; font-size:14px; }
  .tabbtn.active{ background:var(--tab-active); color:var(--tab-active-text); border-color:var(--tab-active) }
  .wrap{ max-width: var(--page-max); margin:14px auto 24px; padding:0 12px }
  .grid{ display:grid; grid-template-columns: repeat(6, 1fr); gap:16px; align-items: stretch; }
  @media (max-width:1280px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
  @media (max-width:860px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
  @media (max-width:600px){ .grid{ grid-template-columns: 1fr; } }
  .cart-full{ grid-column: 1 / -1; position: relative; }
  .cart-care{ position: sticky; top: 78px; align-self: start; }
  .grid-care{ display:grid; grid-template-columns: 1fr 520px; gap:12px; }
  @media (max-width:1220px){ .grid-care{ grid-template-columns: 1fr; } }
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:10px; overflow:hidden }
  .card.hang{ position:relative }
  .card.hang:before{ content:""; position:absolute; top:-12px; left:50%; transform:translateX(-50%);
    width:36px; height:36px; border-radius:999px; background:#f0f2f7; border:4px solid #cfd6e8;
    box-shadow: inset 0 0 0 6px #f7f8fb; z-index:2; }
  .card h3{ margin:0; padding:9px 12px; font-size:15px; color:#fff; background:#4b5569;
            border-bottom:1px solid #3e485d; letter-spacing:1px }
  .content{ padding:10px 12px }
  table{ width:100%; border-collapse:collapse; font-size:12.5px }
  thead th{ background:#eef1f6; font-weight:700; font-size:12.5px }
  th,td{ padding:10px 8px; border-bottom:1px solid var(--border); vertical-align:middle; line-height:1.2 }
  tr{ height:44px }
  th.qty, td.qty{ width:96px; text-align:center; white-space:nowrap }
  td.right{ text-align:right }
  .price{ font-variant-numeric:tabular-nums; color:var(--price) }
  .mnt-row td{ padding:10px 8px }
  .mnt-name{ display:block; font-weight:500; margin-bottom:6px }
  .mnt-subline{ display:flex; gap:14px; flex-wrap:wrap; font-size:12px; color:var(--muted) }
  .mnt-subline label{ display:inline-flex; align-items:center; gap:6px }
  .mnt-subline input{ width:58px; text-align:center; height:28px }
  .mnt-qty-total{ font-weight:700 }
  .stack{ display:flex; flex-direction:column; gap:6px }
  .row{ display:flex; justify-content:space-between; align-items:center; gap:8px }
  .pill{ display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; background:var(--pill-bg); color:var(--pill-text); border:1px solid #c9d5ff }
  .muted{ color:#6b7280; font-size:12px }
  .warn{ color:var(--warn); font-size:12px }
  .btn{ appearance:none; border:1px solid #4b5569; color:#4b5569; background:#fff; cursor:pointer; padding:6px 10px; border-radius:8px; font-size:13px }
  .btn.primary{ background:#4b5569; color:#fff }
  .tag{ font-size:11px; padding:2px 6px; border-radius:999px; background:#fef3c7; border:1px solid #f8ce7a; color:#7a5200 }
  .list{ list-style:none; padding:0; margin:0 }
  .list li{ display:flex; justify-content:space-between; align-items:center; gap:6px; padding:8px 0; border-bottom:1px solid var(--border) }
  .list .meta{ display:flex; align-items:center; gap:6px }
  #singlesList{ display:flex; flex-direction:column; gap:0; font-size:12.5px; line-height:1.2; }
  #singlesList li{ list-style:none; display:flex; align-items:center; height:48px; padding:0 8px; border-bottom:1px solid var(--border); }
  #singlesList li:last-child{ border-bottom:0; }
  #singlesList label{ display:flex; justify-content:space-between; align-items:center; width:100%; border:0 !important; background:transparent !important; padding:0; margin:0; }
  #singlesList .left{ flex:1; min-width:0; display:flex; gap:6px; align-items:center; overflow:hidden; white-space:nowrap; }
  #singlesList .left .name{ flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; }
  #singlesList .left .muted{ flex-shrink:0; white-space:nowrap; }
  #singlesList input[type="number"]{ width:64px; height:32px; text-align:center; box-sizing:border-box; margin-left:auto; }
  .cart .row{ font-size:14px }
  .cart .subtotal{ font-weight:800; padding-top:8px; border-top:1px dashed var(--border) }
  .cart-item{ display:grid; grid-template-columns:1fr auto; gap:4px; padding:8px 0; border-bottom:1px dashed var(--border) }
  .qtyctl{ display:flex; align-items:center; gap:6px }
  .qtyctl button{ width:28px; height:28px; border-radius:6px }
  @media print {
  @page {
    size: A5 landscape;  /* A5 æ©«å‘ */
    margin: 0;           /* ğŸ”¹ä¸è¦ç•™ä»»ä½•é‚Šè· */
  }
  body {
    background: #fff;
    margin: 0;
    padding: 0;          /* å…§å®¹ç·Šè²¼ç‰ˆé¢ */
  }
  .wrap {
    padding: 10mm;       /* ğŸ”¹å¦‚æœéœ€è¦äººå·¥ç•™å®‰å…¨è·ï¼Œå¯èª¿æ•´ */
  }
  .topbar { 
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  .tabs { display: none !important; }
  .card.hang:before { display: none !important; }
  .grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
  .cart-full { grid-column: 1 / -1; }
  .content { padding: 8px 10px; }
  th,td { padding: 5px; font-size: 12px; }
  .btn { display: none !important; }
}

  .combo-block b{ font-size:15px; line-height:1.25; }
  .combo-block input[type="number"]{ width:58px !important; height:28px !important; text-align:center !important; }
  #qtywrap-mix8 label{ font-size:12.5px; }
  #qtywrap-mix8 .muted{ font-size:12px; }
  [data-mntpack]{ font-size:12.5px; }
  .combo-block .mntpack-row{ font-size:12.5px; }
  #combos-right .combo-block:has([data-add-combo="earlyLate"]) .row:has(input[type="number"]) > span,
  #combos-right .combo-block:has([data-add-combo="tea3"]) .row:has(input[type="number"]) > span { font-size: 12.5px; }
  #combos-right .combo-block:has([data-add-combo="earlyLate"]) .row:has(input[type="number"]) > span .muted,
  #combos-right .combo-block:has([data-add-combo="tea3"]) .row:has(input[type="number"]) > span .muted { font-size: 12px; }
  #combos-right .list .meta span:not(.muted) { font-size:12.5px; }
  #combos-right .list .meta .muted { font-size:12px; }
  .card.cart { background: #e1f0f7; border-color: #bae6fd; }
  .card.cart h3 { background: #4f646d; color: #ffffff; border-bottom: 1px solid #0284c7; }
  .card.cart .price { color: #124c6b; font-weight: 600; }
  .card.cart .muted { color: #475569; }
  .cart-item{ border-bottom:1px dashed #000000 !important; }
  .cart .subtotal{ border-top:1px dashed #000000 !important; }
  .card.cart hr{ border-top:1px solid #ff0000 !important; }

  /* ====== éš±è—æŠ˜æ‰£è¦–è¦ºï¼ˆä½†ä¿ç•™è¨ˆç®—ï¼‰ ====== */
  .no-discount-ui .pill,
  .no-discount-ui #classicDeal,
  .no-discount-ui #superDeal,
  .no-discount-ui #lightDeal,
  .no-discount-ui #classicHint,
  .no-discount-ui #superHint,
  .no-discount-ui #lightHint,
  .no-discount-ui #bundleNotes,
  .no-discount-ui #bundleNotes-care { display:none !important; }
</style>
</head>
<body>
  <!-- ===== é¡§å®¢è³‡æ–™ Gateï¼ˆç´”å‰ç«¯ï¼šä¸é€£ä»»ä½•å¾Œç«¯ï¼‰ ===== -->
  <div id="customer-gate" style="max-width:520px;margin:24px auto;padding:16px;background:#fff;border:1px solid #e5e7eb;border-radius:10px">
    <h2 style="margin:0 0 12px">å…ˆå¡«å¯«åŸºæœ¬è³‡æ–™</h2>
    <p class="muted" style="margin-top:0">å®Œæˆå¾Œå³å¯é€²å…¥å‹¾é¸è³¼ç‰©é é¢ï¼ˆè³‡æ–™åªä¿å­˜åœ¨ä½ çš„ç€è¦½å™¨ï¼‰ã€‚</p>

    <form id="customer-form" class="stack" style="gap:10px">
      <label class="stack">
        <span>å§“å</span>
        <input id="cust-name" type="text" required placeholder="ç‹æ›‰æ˜" style="height:36px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px">
      </label>
      <label class="stack">
        <span>é›»è©±</span>
        <input id="cust-phone" type="tel" required placeholder="0xxxxxxxxx" pattern="^0[0-9]{9}$" title="å¿…é ˆæ˜¯ 0 é–‹é ­çš„ 10 ä½æ•¸å­—" style="height:36px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px">
      </label>
      <label class="stack">
        <span>Email</span>
        <input id="cust-email" type="email" required placeholder="name@example.com" style="height:36px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px">
      </label>
      <label class="stack">
        <span>èº«åˆ†è­‰å­—è™Ÿ</span>
        <input id="cust-nid" type="text" required placeholder="A123456789" pattern="^[A-Za-z][12][0-9]{8}$" title="æ ¼å¼ç‚ºè‹±æ–‡å­—æ¯+1æˆ–2+8ä½æ•¸å­—ï¼Œä¾‹å¦‚ A123456789" style="height:36px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px">
      </label>
      <label class="stack">
        <span>æ”¶ä»¶åœ°å€</span>
        <input id="cust-address" type="text" required placeholder="å°ä¸­å¸‚è¥¿å±¯å€â€¦" style="height:36px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px">
      </label>
      <fieldset style="border:0;padding:0;margin:0">
        <legend class="muted" style="margin-bottom:6px">ä»˜æ¬¾æ–¹å¼</legend>
        <label style="display:inline-flex;align-items:center;gap:6px;margin-right:16px">
          <input type="radio" name="payMethod" value="remit" id="pay-remit" checked>
          <span>åŒ¯æ¬¾</span>
        </label>
      </fieldset>
      <label class="stack" id="last5-wrap">
        <span>åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</span>
        <input id="remit-last5" inputmode="numeric" pattern="^[0-9]{5}$" maxlength="5" placeholder="12345" title="è«‹è¼¸å…¥ 5 ä½æ•¸å­—" style="height:36px;padding:6px 10px;border:1px solid #d1d5db;border-radius:8px">
        <small class="muted">â€» æš«ä¸é–‹æ”¾ç¾é‡‘ä»˜æ¬¾</small>
      </label>
      <label style="display:flex;gap:8px;align-items:center;margin-top:4px">
        <input id="agree" type="checkbox" required>
        <span class="muted">æˆ‘åŒæ„è¨ºæ‰€ä½¿ç”¨æœ¬è³‡æ–™è™•ç†è¨‚å–®ï¼ˆåƒ…ä¿å­˜åœ¨æœ¬æ©Ÿæˆ–ä½ ä¸‹è¼‰çš„æª”æ¡ˆä¸­ï¼‰</span>
      </label>
      <div class="row" style="justify-content:flex-end;margin-top:6px">
        <button class="btn primary" type="submit" id="startBtn">é–‹å§‹é¸è³¼</button>
      </div>
    </form>
  </div>

  <div id="shop-root" style="display:none">
    <div class="topbar">
      <div class="title">é†«&nbsp;&nbsp;å¸«&nbsp;&nbsp;å‹¾&nbsp;&nbsp;é¸&nbsp;&nbsp;å–®</div>
      <div class="meta">
        <div>æ—¥æœŸï¼š<span id="today"></span></div>
        <div>å–®è™Ÿï¼š<span id="orderNo"></span></div>
      </div>
    </div>

    <nav class="tabs">
      <div class="wrap">
        <button class="tabbtn active" data-tab="main">ä¸»é ï¼ˆå¥—çµ„ / å–®å“ / çµ„åˆåƒ¹ï¼‰</button>
        <button class="tabbtn" data-tab="care">ç„¡é½¡é†«å¸«ä¿é¤Šå“ & èŒ¶é£²</button>
      </div>
    </nav>

    <!-- Page Aï¼šä¸»é  -->
    <section class="wrap" id="page-main" aria-hidden="false">
      <div class="grid">
        <!-- ä¸‰å€‹å¥—çµ„ -->
        <section class="card hang" id="classicCard">
          <h3>ç¶“å…¸å¥—çµ„</h3>
          <div class="content">
            <table>
              <thead><tr><th>å“é …</th><th class="qty">æ•¸é‡</th></tr></thead>
              <tbody id="classicBody"></tbody>
            </table>
            <div class="content stack" style="padding:8px 0 0">
              <!-- ä¸‹åˆ—æŠ˜æ‰£æç¤ºæœƒè¢« CSS éš±è—ï¼Œä½†ä»ä¿ç•™ç¯€é» -->
              <div class="row"><span class="pill">å¥—çµ„å„ªæƒ </span><b class="price" id="classicDeal"></b></div>
              <div class="muted" id="classicHint"></div>
              <div class="row"><button class="btn primary" data-add-bundle="classic">åŠ å…¥è³¼ç‰©è»Š</button></div>
            </div>
          </div>
        </section>

        <section class="card hang" id="superCard">
          <h3>è¶…å€¼å‡ç´šå¥—çµ„</h3>
          <div class="content">
            <table>
              <thead><tr><th>å“é …</th><th class="qty">æ•¸é‡</th></tr></thead>
              <tbody id="superBody"></tbody>
            </table>
            <div class="content stack" style="padding:8px 0 0">
              <div class="row"><span class="pill">å¥—çµ„å„ªæƒ </span><b class="price" id="superDeal"></b></div>
              <div class="muted" id="superHint"></div>
              <div class="row"><button class="btn primary" data-add-bundle="super">åŠ å…¥è³¼ç‰©è»Š</button></div>
            </div>
          </div>
        </section>

        <section class="card hang" id="lightCard">
          <h3>è¼•ç›ˆå¥—çµ„</h3>
          <div class="content">
            <table>
              <thead><tr><th>å“é …</th><th class="qty">æ•¸é‡</th></tr></thead>
              <tbody id="lightBody"></tbody>
            </table>
            <div class="content stack" style="padding:8px 0 0">
              <div class="row"><span class="pill">å¥—çµ„å„ªæƒ </span><b class="price" id="lightDeal"></b></div>
              <div class="muted" id="lightHint"></div>
              <div class="row"><button class="btn primary" data-add-bundle="light">åŠ å…¥è³¼ç‰©è»Š</button></div>
            </div>
          </div>
        </section>

        <!-- å–®å“ -->
        <section class="card">
          <h3>å–®å“</h3>
          <div class="content">
            <ul class="list" id="singlesList"></ul>
          </div>
        </section>

        <!-- çµ„åˆå„ªæƒ ï¼ˆå·¦/å³ï¼‰ -->
        <section class="card">
          <h3>çµ„åˆå„ªæƒ åƒ¹</h3>
          <div class="content stack" id="combos"></div>
        </section>
        <section class="card">
          <h3>çµ„åˆå„ªæƒ åƒ¹</h3>
          <div class="content stack" id="combos-right"></div>
        </section>

        <!-- ä¸»é è³¼ç‰©è»Š -->
        <aside class="card cart cart-full">
          <h3>è³¼ç‰©è»Š</h3>
          <div class="content">
            <div id="cartItems"></div>
            <div class="muted" id="bundleNotes" style="margin-top:6px"></div>
            <hr style="border:none;border-top:1px solid var(--border);margin:8px 0" />
            <div class="row subtotal"><span>ç¸½è¨ˆ</span><span class="price" id="grandTotal">$0</span></div>
            <div class="row" style="gap:8px; margin-top:10px; flex-wrap:wrap">
              <button class="btn" id="clearCart">æ¸…ç©º</button>
              <button class="btn primary" id="viewOrder">æŸ¥çœ‹è¨‚å–®</button>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- Page Bï¼šä¿é¤Š / èŒ¶é£² -->
    <section class="wrap" id="page-care" aria-hidden="true" style="display:none">
      <div class="grid-care">
        <div class="stack">
          <section class="card">
            <h3>ğŸ’§ ä¿é¤Šå“</h3>
            <div class="content"><ul class="list" id="care-skin"></ul></div>
          </section>
          <section class="card">
            <h3>ğŸµ é£Ÿå“ / èŒ¶åŒ…</h3>
            <div class="content"><ul class="list" id="care-drink"></ul></div>
          </section>
          <section class="card">
            <h3>ğŸ› ï¸ å…¶ä»–ç”¨å“</h3>
            <div class="content"><ul class="list" id="care-others"></ul></div>
          </section>
          <section class="card">
            <h3>ğŸŒ¸ ç§å¯†ä¿é¤Š</h3>
            <div class="content"><ul class="list" id="care-intimate"></ul></div>
          </section>
          <section class="card">
            <h3>ğŸ’ª å¥åº·è£œçµ¦</h3>
            <div class="content"><ul class="list" id="care-health"></ul></div>
          </section>
          <section class="card">
            <h3>ä¿é¤Šä¸‰ä»¶çµ„ï¼ˆå›ºå®šçµ„åˆï¼‰</h3>
            <div class="content stack">
              <div class="row"><span class="tag">çµ„åˆåƒ¹ $4,980</span></div>
              <ul class="list">
                <li><div class="meta"><span>èƒºåŸºé…¸æ´—é¡æ…•çµ² Ã— 1</span><span class="muted">$680</span></div></li>
                <li><div class="meta"><span>å¤–æ³Œé«”ä¿®è­·ç²¾è¯æ¶² Ã— 1</span><span class="muted">$2,500</span></div></li>
                <li><div class="meta"><span>çš®è„‚è†œä¿®è­·ä¹³éœœ Ã— 1</span><span class="muted">$2,050</span></div></li>
              </ul>
              <div class="row">
                <label class="muted" style="display:inline-flex;align-items:center;gap:6px">
                  <span>çµ„æ•¸</span>
                  <input type="number" min="1" value="1" id="sets-skin3" style="width:64px;text-align:center;height:28px">
                </label>
                <button class="btn primary" id="add-skin3">åŠ å…¥è³¼ç‰©è»Š</button>
              </div>
            </div>
          </section>
        </div>
        <aside class="card cart cart-care">
          <h3>è³¼ç‰©è»Š</h3>
          <div class="content">
            <div id="cartItems-care"></div>
            <div class="muted" id="bundleNotes-care" style="margin-top:6px"></div>
            <hr style="border:none;border-top:1px solid var(--border);margin:8px 0" />
            <div class="row subtotal"><span>ç¸½è¨ˆ</span><span class="price" id="grandTotal-care">$0</span></div>
            <div class="row" style="gap:8px; margin-top:10px; flex-wrap:wrap">
              <button class="btn" id="clearCart-care">æ¸…ç©º</button>
              <button class="btn primary" id="viewOrder-care">æŸ¥çœ‹è¨‚å–®</button>
            </div>
            <div class="muted">ï¼ˆæ­¤è™•é¡¯ç¤ºèˆ‡ä¸»é è³¼ç‰©è»ŠåŒæ­¥ï¼‰</div>
          </div>
        </aside>
      </div>
    </section>
  </div>

<script>
/****************** å·¥å…· ******************/
const currency = n => "$" + (n||0).toLocaleString();
function toCents(text){ if(text==null) return 0; const s=String(text).trim(); if(!s) return 0; const hasParen=/^\(.*\)$/.test(s); const cleaned=s.replace(/[^0-9.\-]/g,""); const num=parseFloat(cleaned); if(isNaN(num)) return 0; const val=hasParen? -num : num; return Math.round(val); }
const $ = s=>document.querySelector(s);
const $$ = s=>[...document.querySelectorAll(s)];

/****************** å•†å“è³‡æ–™ï¼ˆç•¥ï¼šåŸæ¨£ï¼‰ ******************/
const singles = [
  { id:"mnt_protein", name:"MNT è›‹ç™½ç²‰", unitPrice:1880 },
  { id:"light_digest", name:"æš¢ä¾¿è¼•", unitPrice:1200 },
  { id:"wei_shijia", name:"è¡›é©ä½³", unitPrice:1200 },
  { id:"jiao_yuan_c", name:"å¬Œåœ“C", unitPrice:1200 },
  { id:"morning_capsule", name:"æ—©å®‰è† å›Š", unitPrice:900 },
  { id:"night_chew", name:"æ™šå®‰å’€åš¼éŒ ", unitPrice:900 },
  { id:"oil_cut", name:"æ²¹æ¾±é›™åˆ‡", unitPrice:600 },
  { id:"elite", name:"å„ªå…ˆç›ˆ", unitPrice:1500 },
  { id:"clean_mouth", name:"æ¸…å£æ¨‚", unitPrice:600 },
  { id:"double_l", name:"é›™Lç›ŠèŒç³–", unitPrice:1200 },
  { id:"fish_oil", name:"é»ƒæ™¶é­šæ²¹", unitPrice:1300 },
  { id:"night_relax", name:"å¤œå…çœ ", unitPrice:1300 },
  { id:"sensitive", name:"å…æ•é€š", unitPrice:1300 },
  { id:"berry", name:"å…åª„è“", unitPrice:1300 }
];
const careCatalog = {
  skin: [
    { id:"foam_cleanser", name:"èƒºåŸºé…¸æ´—é¡æ…•çµ²", unitPrice:680 },
    { id:"exo_serum", name:"å¤–æ³Œé«”ä¿®è­·ç²¾è¯æ¶²", unitPrice:2500 },
    { id:"lipid_cream", name:"çš®è„‚è†œä¿®è­·ä¹³éœœ", unitPrice:2050 },
    { id:"tinted_sunscreen", name:"è¼•é€æ½¤è‰²é˜²æ›¬ä¹³", unitPrice:980 },
    { id:"exo_mask_single", name:"å¤–æ³Œé«”ä¿®è­·é¢è†œï¼ˆå–®ç‰‡ï¼‰", unitPrice:180 },
    { id:"exo_mask_box", name:"å¤–æ³Œé«”ä¿®è­·é¢è†œï¼ˆä¸€ç›’5ç‰‡ï¼‰", unitPrice:850 },
  ],
  drink: [
    { id:"yogurt", name:"å…å„ªæ ¼ï¼ˆé™å°åŒ—ç„¡é½¡è‡ªå–ï¼‰", unitPrice:680 },
    { id:"tea_calm", name:"å¥½å¥½å®‰å¿ƒèŒ¶", unitPrice:600 },
    { id:"tea_beauty", name:"ç¾ç¾æ¼‚æ¼‚èŒ¶", unitPrice:600 },
    { id:"tea_energy", name:"æ»¿æ»¿æ´»åŠ›èŒ¶", unitPrice:600 },
  ],
  others: [
    { id:"ketone_device", name:"æ°£é…®æ©Ÿ", unitPrice:3950 },
    { id:"blender_bottle", name:"Blender æ–æ¯", unitPrice:380 },
  ],
  intimate: [
    { id:"intimate_firm", name:"ç§å¯†ç·Šå¯¦ç²¾èƒ", unitPrice:3110 },
    { id:"intimate_clean", name:"ç§å¯†æ·¨æ½¤ç²¾èƒ", unitPrice:1880 },
    { id:"intimate_hyal", name:"ç»å°¿é…¸ç§å¯†éœ²", unitPrice:550 },
  ],
  health: [ { id:"b1_patch", name:"B1 æ´»åŠ›è²¼ç‰‡", unitPrice:780 } ]
};
const singlesByName = Object.fromEntries([...singles, ...Object.values(careCatalog).flat()].map(s=>[s.name, s.unitPrice]));

const bundleDefs = {
  classic: {
    title:"ç¶“å…¸å¥—çµ„", minPrice:16140, discount:1140,
    items:[["MNT è›‹ç™½ç²‰",3],["æš¢ä¾¿è¼•",2],["è¡›é©ä½³",1],["å¬Œåœ“C",2],["æ—©å®‰è† å›Š",1],["æ™šå®‰å’€åš¼éŒ ",1],["æ²¹æ¾±é›™åˆ‡",1],["å„ªå…ˆç›ˆ",1],["æ¸…å£æ¨‚",1],["4+2R è¿½è¹¤",1]]
  },
  super: {
    title:"è¶…å€¼å‡ç´šå¥—çµ„", minPrice:33340, discount:3340,
    items:[["MNT è›‹ç™½ç²‰",8],["æš¢ä¾¿è¼•",4],["è¡›é©ä½³",2],["å¬Œåœ“C",3],["æ—©å®‰è† å›Š",2],["æ™šå®‰å’€åš¼éŒ ",2],["æ²¹æ¾±é›™åˆ‡",1],["å„ªå…ˆç›ˆ",1],["æ¸…å£æ¨‚",1],["é›™Lç›ŠèŒç³–",1],["4+2R è¿½è¹¤",2]]
  },
  light: {
    title:"è¼•ç›ˆå¥—çµ„", minPrice:9840, discount:40,
    items:[["MNT è›‹ç™½ç²‰",3],["æš¢ä¾¿è¼•",1],["å¬Œåœ“C",1],["æ—©å®‰è† å›Š",1],["æ™šå®‰å’€åš¼éŒ ",1],["4+2R è¿½è¹¤",1]]
  }
};
const mntPreset = { classic:{can:1,bag:2}, super:{can:3,bag:5}, light:{can:1,bag:2} };
const combos = [
  { id:"mnt3pack", title:"MNT è›‹ç™½ç²‰ 3 å…¥ä»»é¸ï¼ˆç½ï¼è¢‹ï¼‰", rule:{ type:"mntCanBagTotalFixed", n:3, fixedPrice:5000, init:{can:1, bag:2} }, product:"MNT è›‹ç™½ç²‰" },
  { id:"mix8", title:"æš¢/è¡›/C/L/é­š/å¤œ/æ•/è“ çµ„åˆ", rule:{ type:"pickTierFixed", tiers:[ {n:6, price:6300}, {n:3, price:3300} ] }, choices:["æš¢ä¾¿è¼•","è¡›é©ä½³","å¬Œåœ“C","é›™Lç›ŠèŒç³–","é»ƒæ™¶é­šæ²¹","å¤œå…çœ ","å…æ•é€š","å…åª„è“"] },
  { id:"earlyLate", title:"æ—©æ™šå®‰çµ„åˆ", rule:{type:"pickNFixed", n:4, fixedPrice:3200}, choices:["æ—©å®‰è† å›Š","æ™šå®‰å’€åš¼éŒ "] },
  { id:"goldOil", title:"é‡‘éŠ€åŒ…çµ„åˆ", rule:{ type:"exactBundleFixed", fixedPrice:5000, items:[ {name:"å„ªå…ˆç›ˆ", qty:3}, {name:"æ²¹æ¾±é›™åˆ‡", qty:2} ] } },
  { id:"gradFav", title:"ç•¢æ¥­ç”Ÿæœ€æ„›çµ„åˆ", rule:{ type:"exactBundleFixed", fixedPrice:6200, items:[ {name:"å„ªå…ˆç›ˆ", qty:3}, {name:"é›™Lç›ŠèŒç³–", qty:2} ] } },
  { id:"tea3", title:"èŒ¶åŒ…ä¸‰å…¥ä»»é¸", rule:{ type:"pickNFixed", n: 3, fixedPrice: 1500 }, choices: ["å¥½å¥½å®‰å¿ƒèŒ¶","ç¾ç¾æ¼‚æ¼‚èŒ¶","æ»¿æ»¿æ´»åŠ›èŒ¶"] }
];

/****************** ç‹€æ…‹ ******************/
const cart = [];
function initialStateFromBundle(key){ const def=bundleDefs[key]; const o={}; def.items.forEach(([name,qty])=>{ if(name==="MNT è›‹ç™½ç²‰"){ o[name] = { ...mntPreset[key] }; } else { o[name] = qty; } }); return o; }
const state = { classic:initialStateFromBundle('classic'), super:initialStateFromBundle('super'), light:initialStateFromBundle('light') };

/****************** å¥—çµ„è¨ˆç®— & UIï¼ˆéš±è—æŠ˜æ‰£æ–‡å­—ï¼Œä½†ä¿ç•™åˆ¤æ–·ï¼‰ ******************/
function bundleSubtotal(key){
  const o=state[key]; let sum=0;
  for(const [name,qty] of Object.entries(o)){
    if(name==="MNT è›‹ç™½ç²‰"){
      const unit=singlesByName[name]||0;
      const can=(qty&&qty.can)?+qty.can:0; const bag=(qty&&qty.bag)?+qty.bag:0;
      sum += (can+bag)*unit;
    }else{
      sum += (singlesByName[name]||0) * (+qty||0);
    }
  }
  return sum;
}
function setBundleUi(key, subtotal){
  const def = bundleDefs[key];
  const eligible = subtotal >= def.minPrice;

  // pillï¼šä¿æŒé¡¯ç¤ºã€Œå¥—çµ„å„ªæƒ ã€
  const pill = document.querySelector(`#${key}Card .pill`);
  if (pill) pill.textContent = 'å¥—çµ„å„ªæƒ ';

  // ã€Œæ‡‰ä»˜é‡‘é¡ã€ï¼šé”æ¨™æ‰é¡¯ç¤ºå¯¦ä»˜ï¼Œæœªé”æ¨™é¡¯ç¤º â”€
  const dealEl = document.querySelector(`#${key}Deal`);
  if (dealEl) {
    if (eligible) {
      const shouldPay = Math.max(0, subtotal - def.discount);
      dealEl.textContent = `æ‡‰ä»˜ ${currency(shouldPay)}`;
    } else {
      dealEl.textContent = 'â€”';
    }
  }

  // æç¤ºè©ï¼šé”æ¨™é¡¯ç¤ºã€Œå¯æ­ã€ï¼‹æŠ˜æ‰£è³‡è¨Šï¼›æœªé”é¡¯ç¤ºé–€æª»æç¤º
  const hint = document.querySelector(`#${key}Hint`);
  if (hint) {
    if (eligible) {
      // light å…ˆå‰æ˜¯ã€Œåªé™è¤‡è¨ºã€ï¼Œå…¶å®ƒå…©çµ„æ˜¯ã€Œåˆ / è¤‡è¨ºå¯æ­ã€
      const compat = (key === 'light') ? 'åªé™è¤‡è¨º' : 'åˆ / è¤‡è¨ºå¯æ­';
      hint.textContent = `${compat}ï¼›å·²æŠ˜ ${currency(def.discount)}ã€‚`;
    } else {
      hint.textContent = `æœªé”é–€æª»ï¼ˆéœ€æ»¿ ${currency(def.minPrice)}ï¼‰ï¼Œç„¡æ³•åŠ å…¥æ•´çµ„ã€‚`;
    }
  }

  // åŠ å…¥è³¼ç‰©è»ŠæŒ‰éˆ•çš„å•Ÿç”¨èˆ‡ tooltip
  const btn = document.querySelector(`[data-add-bundle='${key}']`);
  if (btn) {
    btn.disabled = !eligible;
    btn.title = eligible ? `å¯åŠ å…¥ï¼ˆæŠ˜ ${currency(def.discount)}ï¼‰` : `æœªé”é–€æª» ${currency(def.minPrice)}`;
  }
}


/****************** å¥—çµ„æ¸²æŸ“ ******************/
function renderBundle(key){
  const def=bundleDefs[key];
  const tbody=$(`#${key}Body`);
  tbody.innerHTML = def.items.map(([name,qty])=>{
    if(name==="MNT è›‹ç™½ç²‰"){
      const cur=state[key][name]||{can:0,bag:0};
      const total=(+cur.can||0)+(+cur.bag||0);
      return `<tr class="mnt-row"><td><span class="mnt-name">${name}</span><div class="mnt-subline"><label>ç½ <input type="number" min="0" step="1" value="${cur.can}" data-mnt="${key}:can"></label><label>è¢‹ <input type="number" min="0" step="1" value="${cur.bag}" data-mnt="${key}:bag"></label></div></td><td class="qty"><span class="mnt-qty-total" id="${key}-mnt-total">${total}</span></td></tr>`;
    }
    if(name==="4+2R è¿½è¹¤"){
      const fixed=qty; state[key][name]=fixed;
      return `<tr class="fixed-row"><td>${name} <span class="tag">å›ºå®š</span></td><td class="qty"><span class="muted">${fixed}</span></td></tr>`;
    }
    const val = state[key][name] ?? qty;
    return `<tr><td>${name}</td><td class="qty"><input type="number" min="0" step="1" value="${val}" data-bq="${key}:${name}" style="width:58px;text-align:center;height:28px"></td></tr>`;
  }).join("");

  setBundleUi(key, bundleSubtotal(key));

  $$(`input[data-bq^="${key}:"]`).forEach(i=>{
    i.addEventListener("input",()=>{
      const [k,name]=i.dataset.bq.split(":");
      state[k][name]=Math.max(0, parseInt(i.value||"0")||0);
      setBundleUi(k, bundleSubtotal(k));
    });
  });
  $$(`input[data-mnt^='${key}:']`).forEach(i=>{
    i.addEventListener('input',()=>{
      const [k,which]=i.dataset.mnt.split(':');
      const obj=state[k]["MNT è›‹ç™½ç²‰"]||{can:0,bag:0};
      obj[which]=Math.max(0, parseInt(i.value||'0')||0);
      state[k]["MNT è›‹ç™½ç²‰"]=obj;
      const total=(+obj.can||0)+(+obj.bag||0);
      const totalEl=$(`#${k}-mnt-total`);
      if(totalEl) totalEl.textContent=String(total);
      setBundleUi(k, bundleSubtotal(k));
    });
  });
}

/****************** ä¸»é å–®å“ ******************/
function renderSingles(){
  const ul=$("#singlesList"); ul.innerHTML="";
  singles.forEach(s=>{
    const li=document.createElement("li");
    li.innerHTML=`<label><span class="left"><span class="name">${s.name}</span><span class="muted">${currency(s.unitPrice)}</span></span><input type="number" min="0" value="0" data-single="${s.id}"></label>`;
    ul.appendChild(li);
  });
  const addRow=document.createElement("div");
  addRow.style="margin-top:10px; text-align:right";
  addRow.innerHTML=`<button class="btn primary" id="syncSingles">åŠ å…¥è³¼ç‰©è»Š</button>`;
  ul.parentElement.appendChild(addRow);
  $("#syncSingles").addEventListener("click",()=>{
    const inputs=[...document.querySelectorAll("input[data-single]")];
    const mainSingleIds=new Set(singles.map(s=>s.id));
    for(let i=cart.length-1;i>=0;i--){
      const c=cart[i]; if(c.type==='single' && mainSingleIds.has(c.itemId)) cart.splice(i,1);
    }
    inputs.forEach(inp=>{
      const qty=Math.max(0, parseInt(inp.value||"0",10)||0);
      if(qty>0){
        const s=singles.find(x=>x.id===inp.dataset.single);
        cart.push({ type:'single', itemId:s.id, name:s.name, unitPrice:s.unitPrice, qty });
      }
    });
    renderCart();
  });
}

/****************** çµ„åˆæ¸²æŸ“ï¼ˆåŸæ¨£ï¼Œåƒ… UI èª¿æ•´å·²åœ¨ CSS æ§åˆ¶ï¼‰ ******************/
function renderCombos(){
  const mainWrap=$("#combos"), rightWrap=$("#combos-right");
  mainWrap.innerHTML=""; if(rightWrap) rightWrap.innerHTML="";
  const RIGHT=new Set(["earlyLate","goldOil","gradFav","tea3"]);
  const mount=(el,container)=>{ if(container) container.appendChild(el); };

  combos.forEach(c=>{
    const target=RIGHT.has(c.id)? rightWrap : mainWrap;

    if(c.rule.type==="mntCanBagTotalFixed"){
      const id=c.id, n=c.rule.n;
      const initCan=c.rule.init?.can||0; const initBag=c.rule.init?.bag||0;
      const block=document.createElement("div");
      block.className="card combo-block";
      block.innerHTML =
        '<div class="content">'
        + '<div class="row" style="margin-bottom:6px"><b>'+c.title+'</b>'
        + '<span class="tag">'+n+' å…¥ä»»é¸ / çµ„åˆåƒ¹ '+currency(c.rule.fixedPrice)+'</span></div>'
        + '<div class="row mntpack-row" style="margin:6px 0"><span>'+c.product+'ï¼ˆç½ï¼‰</span>'
        + '<input type="number" min="0" value="'+initCan+'" data-mntpack="'+id+':can" style="width:58px;text-align:center;height:28px"></div>'
        + '<div class="row mntpack-row" style="margin:6px 0"><span>'+c.product+'ï¼ˆè¢‹ï¼‰</span>'
        + '<input type="number" min="0" value="'+initBag+'" data-mntpack="'+id+':bag" style="width:58px;text-align:center;height:28px"></div>'
        + '<div class="row" style="margin-top:6px"><div class="muted">ç¸½è¨ˆ <b id="cnt-'+id+'">'+(initCan+initBag)+'</b> / '+n
        + '</div><button class="btn primary" data-add-mntpack="'+id+'" '+(((initCan+initBag)===n)? '' : 'disabled')+'>åŠ å…¥è³¼ç‰©è»Š</button></div>'
        + '</div>';
      mount(block,target);

      const canI=document.querySelector('input[data-mntpack="'+id+':can"]');
      const bagI=document.querySelector('input[data-mntpack="'+id+':bag"]');
      const btn=document.querySelector('[data-add-mntpack="'+id+'"]');
      const cnt=$("#cnt-"+id);
      const update=()=>{ const can=+canI.value||0, bag=+bagI.value||0, sum=can+bag; cnt.textContent=String(sum); btn.disabled = sum!==n; };
      canI.addEventListener('input',update); bagI.addEventListener('input',update);
      btn.addEventListener('click',()=>{
        const can=+canI.value||0, bag=+bagI.value||0; const selections=[];
        if(can>0) selections.push({name:c.product+'ï¼ˆç½ï¼‰', qty:can});
        if(bag>0) selections.push({name:c.product+'ï¼ˆè¢‹ï¼‰', qty:bag});
        cart.push({ type:'combo', name:c.title, rule:c.rule, selections, qty:1 });
        canI.value=c.rule.init?.can||0; bagI.value=c.rule.init?.bag||0; update(); renderCart();
      });
      update();
      return;
    }

    if(c.rule.type==="pickTierFixed"){
      const id=c.id;
      const [tierA,tierB]=c.rule.tiers;

      const block=document.createElement("div");
      block.className="card combo-block";

      // å…ˆæŠŠ choices çš„è¡¨å–® HTML æ‹¼å¥½ï¼ˆé¿å…å·¢ç‹€åå¼•è™Ÿï¼‰
      const choicesHtml = c.choices.map(function(name){
        const unit = singlesByName[name]||0;
        const showUnitPrice = id !== "mix8";
        return (
          '<label style="display:flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius:8px; padding:6px 8px; justify-content:space-between">'
          + '<span>'+name+(showUnitPrice? ' <span class="muted">'+currency(unit)+'</span>' : '')+'</span>'
          + '<input type="number" min="0" value="0" data-qty="'+id+':'+name+'" style="width:64px; text-align:center; height:28px">'
          + '</label>'
        );
      }).join("");

      block.innerHTML =
        '<div class="content">'
        + '<div class="row" style="margin-bottom:6px"><b>'+c.title+'</b></div>'
        + '<div class="row" style="gap:16px; margin:6px 0 10px">'
          + '<label style="display:inline-flex;align-items:center;gap:6px">'
            + '<input type="radio" name="tier-'+id+'" value="0" checked>'
            + '<span>'+tierA.n+' å…¥ / '+currency(tierA.price)+'</span>'
          + '</label>'
          + '<label style="display:inline-flex;align-items:center;gap:6px">'
            + '<input type="radio" name="tier-'+id+'" value="1">'
            + '<span>'+tierB.n+' å…¥ / '+currency(tierB.price)+'</span>'
          + '</label>'
        + '</div>'
        + '<div id="qtywrap-'+id+'" style="display:flex; flex-direction:column; gap:10px; margin-bottom:8px">'+choicesHtml+'</div>'
        + '<div class="row" style="margin-top:6px">'
          + '<div class="muted">å·²é¸ <b id="cnt-'+id+'">0</b> / <span id="need-'+id+'">'+tierA.n+'</span></div>'
          + '<button class="btn primary" data-add-mix8="'+id+'" disabled>åŠ å…¥è³¼ç‰©è»Š</button>'
        + '</div>'
        + '</div>';

      const target = RIGHT.has(c.id)? rightWrap : mainWrap;
      if(target) target.appendChild(block);

      const radios=[...document.querySelectorAll('input[name="tier-'+id+'"]')];
      const qtyInputs=[...document.querySelectorAll('input[data-qty^="'+id+':"]')];
      const cntEl=$("#cnt-"+id), needEl=$("#need-"+id), addBtn=document.querySelector('[data-add-mix8="'+id+'"]');

      let currentTier=0;
      const need=()=> currentTier===0? tierA.n : tierB.n;
      const price=()=> currentTier===0? tierA.price : tierB.price;
      const sumQty=()=> qtyInputs.reduce((s,i)=> s+(+i.value||0),0);

      const update=()=>{
        const selected=sumQty();
        cntEl.textContent=String(selected);
        needEl.textContent=String(need());
        addBtn.disabled = selected!==need();
      };

      radios.forEach(r=> r.addEventListener('change',()=>{
        currentTier=+r.value; qtyInputs.forEach(i=> i.value="0"); update();
      }));
      qtyInputs.forEach(i=> i.addEventListener('input',()=>{
        const v=Math.max(0, parseInt(i.value||"0",10)||0); i.value=String(v); update();
      }));
      addBtn.addEventListener('click',()=>{
        const selections=qtyInputs.map(i=>({ name:i.dataset.qty.split(':')[1], qty:+i.value||0 })).filter(s=>s.qty>0);
        cart.push({ type:'combo', name:(c.title+'ï¼ˆ'+need()+'å…¥ï¼‰'), rule:{ fixedPrice:price() }, selections, qty:1 });
        qtyInputs.forEach(i=> i.value="0"); update(); renderCart();
      });
      update();
      return;
    }

    if(c.rule.type==="pickNFixed"){
      const id=c.id;
      const block=document.createElement("div");
      block.className="card combo-block";
      const rowsHtml = c.choices.map(function(name){
        const unit=singlesByName[name]||0;
        return (
          '<div class="row" style="margin:6px 0"><span>'+name+' <span class="muted">'+currency(unit)+'</span></span>'
          + '<input type="number" min="0" value="0" data-choice="'+id+':'+name+'" style="width:58px;text-align:center;height:28px"></div>'
        );
      }).join("");
      block.innerHTML =
        '<div class="content">'
        + '<div class="row" style="margin-bottom:6px"><b>'+c.title+'</b>'
        + '<span class="tag">'+c.rule.n+' å…¥ä»»é¸ / çµ„åˆåƒ¹ '+currency(c.rule.fixedPrice)+'</span></div>'
        + rowsHtml
        + '<div class="row" style="margin-top:6px"><div class="muted">å·²é¸ <b id="cnt-'+id+'">0</b> / '+c.rule.n+'</div>'
        + '<button class="btn primary" data-add-combo="'+id+'" disabled>åŠ å…¥è³¼ç‰©è»Š</button></div>'
        + '</div>';
      mount(block,target);
      const inputs=[...document.querySelectorAll('input[data-choice^="'+id+':"]')];
      const btn=document.querySelector('[data-add-combo="'+id+'"]');
      const cnt=$("#cnt-"+id);
      const update=()=>{ const sum=inputs.reduce((s,i)=> s+(+i.value||0),0); cnt.textContent=String(sum); btn.disabled = sum!==c.rule.n; };
      inputs.forEach(i=> i.addEventListener('input',update));
      btn.addEventListener('click',()=>{
        const selections=inputs.map(i=>({ name:i.dataset.choice.split(':')[1], qty:+i.value||0 })).filter(x=>x.qty>0);
        cart.push({ type:'combo', name:c.title, rule:c.rule, selections, qty:1 });
        inputs.forEach(i=> i.value=0); update(); renderCart();
      });
      update(); return;
    }

    if(c.rule.type==="exactBundleFixed"){
      const id=c.id;
      const block=document.createElement("div");
      block.className="card";
      const itemsHtml = c.rule.items.map(it=>
        "<li><div class='meta'><span>"+it.name+" Ã— "+it.qty+"</span><span class='muted'>å–®åƒ¹ "+currency(singlesByName[it.name]||0)+"</span></div></li>"
      ).join("");
      block.innerHTML =
        '<div class="content"><div class="row" style="margin-bottom:6px"><b>'+c.title+'</b>'
        + '<span class="tag">å›ºå®šçµ„åˆ / çµ„åˆåƒ¹ '+currency(c.rule.fixedPrice)+'</span></div>'
        + '<ul class="list" style="margin-bottom:8px">'+itemsHtml+'</ul>'
        + '<div class="row" style="margin-top:6px"><label class="muted" style="display:inline-flex;align-items:center;gap:6px"><span>çµ„æ•¸</span>'
        + '<input type="number" min="1" value="1" id="sets-'+id+'" style="width:64px;text-align:center;height:28px"></label>'
        + '<button class="btn primary" data-add-exact="'+id+'">åŠ å…¥è³¼ç‰©è»Š</button></div></div>';
      mount(block,target);
      const addBtn=document.querySelector('[data-add-exact="'+id+'"]');
      const setsInput=$("#sets-"+id);
      addBtn.addEventListener('click',()=>{
        const sets=Math.max(1, parseInt(setsInput.value||"1",10));
        const selections=c.rule.items.map(it=>({ name:it.name, qty:it.qty }));
        cart.push({ type:'combo', name:c.title, rule:{ fixedPrice:c.rule.fixedPrice }, selections, qty:sets });
        setsInput.value="1"; renderCart();
      });
      return;
    }
  });
}

/****************** ç¬¬äºŒé æ¸…å–® â†’ ä¸€æ¬¡åŠ å…¥ ******************/
function renderCareLists(){
  const fill=(elId,items)=>{
    const ul=$("#"+elId); ul.innerHTML="";
    items.forEach(s=>{
      const li=document.createElement("li");
      li.innerHTML=`<div class="meta"><span>${s.name}</span><span class="muted">${currency(s.unitPrice)}</span></div><input type="number" min="0" value="0" data-care-qty="${s.id}" style="width:64px; text-align:center; height:28px">`;
      ul.appendChild(li);
    });
    const action=document.createElement("div");
    action.style="margin-top:10px; text-align:right";
    action.innerHTML=`<button class="btn primary" data-sync-care>åŠ å…¥è³¼ç‰©è»Š</button>`;
    ul.parentElement.appendChild(action);
  };
  fill("care-skin",careCatalog.skin);
  fill("care-drink",careCatalog.drink);
  fill("care-others",careCatalog.others);
  fill("care-intimate",careCatalog.intimate);
  fill("care-health",careCatalog.health);

  $$('[data-sync-care]').forEach(btn=> btn.addEventListener('click',()=>{
    const careIds=new Set(Object.values(careCatalog).flat().map(s=>s.id));
    for(let i=cart.length-1;i>=0;i--){
      const c=cart[i]; if(c.type==='single' && careIds.has(c.itemId)) cart.splice(i,1);
    }
    const inputs=[...document.querySelectorAll('input[data-care-qty]')];
    inputs.forEach(inp=>{
      const qty=Math.max(0, parseInt(inp.value||"0",10)||0);
      if(qty>0){
        const s=Object.values(careCatalog).flat().find(x=> x.id===inp.dataset.careQty);
        if(s){ cart.push({ type:'single', itemId:s.id, name:s.name, unitPrice:s.unitPrice, qty }); }
      }
    });
    renderCart();
  }));

  $("#add-skin3").addEventListener('click',()=>{
    const sets=Math.max(1, parseInt($("#sets-skin3").value||"1",10));
    const selections=[{name:"èƒºåŸºé…¸æ´—é¡æ…•çµ²",qty:1},{name:"å¤–æ³Œé«”ä¿®è­·ç²¾è¯æ¶²",qty:1},{name:"çš®è„‚è†œä¿®è­·ä¹³éœœ",qty:1}];
    cart.push({ type:'combo', name:'ä¿é¤Šä¸‰ä»¶çµ„', rule:{ fixedPrice:4980 }, selections, qty:sets });
    $("#sets-skin3").value="1"; renderCart();
  });
}

/****************** è³¼ç‰©è»Šæ¸²æŸ“ & é‡‘é¡ï¼ˆä¸é¡¯ç¤ºæŠ˜æ‰£æ–‡æ¡ˆï¼‰ ******************/
function renderCart(){
  const boxMain=$("#cartItems"); if(boxMain) boxMain.innerHTML='';
  const boxCare=$("#cartItems-care"); if(boxCare) boxCare.innerHTML='';
  let gross=0, discountTotal=0;

  cart.forEach((ci,idx)=>{
    const rowHTMLSingle=(line)=>`<div><div class='name'>å–®å“ï½œ${ci.name}</div><div class='muted'>å–®åƒ¹ ${currency(ci.unitPrice)}</div></div><div class='right'><div class='qtyctl'><button class='btn' data-dec='${idx}'>âˆ’</button><span>${ci.qty}</span><button class='btn' data-inc='${idx}'>ï¼‹</button><button class='btn' data-del='${idx}' title='åˆªé™¤'>âœ•</button></div><div class='price'>${currency(line)}</div></div>`;
    const rowHTMLBundle=(netLine,sel)=>`<div><div class='name'>å¥—çµ„ï½œ${ci.name}</div>${sel?`<div class='muted'>${sel}</div>`:''}</div><div class='right'><div class='qtyctl'><button class='btn' data-dec='${idx}'>âˆ’</button><span>${ci.qty}</span><button class='btn' data-inc='${idx}'>ï¼‹</button><button class='btn' data-del='${idx}' title='åˆªé™¤'>âœ•</button></div><div class='price'>${currency(netLine)}</div></div>`;
    const rowHTMLCombo=(line,seltext)=>`<div><div class='name'>çµ„åˆï½œ${ci.name}</div><div class='muted'>${seltext}</div><span class='tag'>çµ„åˆåƒ¹ ${currency(ci.rule.fixedPrice)} / çµ„</span></div><div class='right'><div class='qtyctl'><button class='btn' data-dec='${idx}'>âˆ’</button><span>${ci.qty}</span><button class='btn' data-inc='${idx}'>ï¼‹</button><button class='btn' data-del='${idx}' title='åˆªé™¤'>âœ•</button></div><div class='price'>${currency(line)}</div></div>`;

    let row;
    if(ci.type==='single'){
      const unitLine=ci.unitPrice; gross += unitLine*ci.qty;
      const net=unitLine*ci.qty;
      row=document.createElement('div'); row.className='cart-item'; row.innerHTML=rowHTMLSingle(net);
    }else if(ci.type==='bundle'){
      const unitSub=ci.unitSubtotal, unitDisc=ci.unitDiscount;
      gross += unitSub*ci.qty; discountTotal += unitDisc*ci.qty;
      const net=(unitSub-unitDisc)*ci.qty;
      const sel=ci.selections?.map(s=>`${s.name}Ã—${s.qty}`).join('ã€')||'';
      row=document.createElement('div'); row.className='cart-item'; row.innerHTML=rowHTMLBundle(net,sel);
    }else{
      const unit=ci.rule.fixedPrice; gross += unit*ci.qty;
      const net=unit*ci.qty;
      const seltext=ci.selections.map(s=>`${s.name}Ã—${s.qty}`).join('ã€');
      row=document.createElement('div'); row.className='cart-item'; row.innerHTML=rowHTMLCombo(net,seltext);
    }
    if(boxMain) boxMain.appendChild(row.cloneNode(true));
    if(boxCare) boxCare.appendChild(row);
  });

  const syncMoney=(suf)=>{
    const $sub=$("#subtotal"+suf), $tot=$("#grandTotal"+suf), $note=$("#bundleNotes"+suf);
    if($sub) $sub.textContent=currency(gross);
    if($tot) $tot.textContent=currency(Math.max(0, gross-discountTotal));
    if($note) $note.textContent = ""; // ä¸é¡¯ç¤ºã€Œå·²å¥—ç”¨æŠ˜æ‰£ã€ç­‰æ–‡æ¡ˆ
  };
  syncMoney(''); syncMoney('-care');

  $$('[data-inc]').forEach(b=> b.addEventListener('click',()=>{ cart[+b.dataset.inc].qty++; renderCart(); }));
  $$('[data-dec]').forEach(b=> b.addEventListener('click',()=>{ const i=+b.dataset.dec; cart[i].qty=Math.max(1, cart[i].qty-1); renderCart(); }));
  $$('[data-del]').forEach(b=> b.addEventListener('click',()=>{ cart.splice(+b.dataset.del,1); renderCart(); }));
}

/****************** å¥—çµ„åŠ å…¥è³¼ç‰©è»Šï¼ˆè¨ˆç®—ä¿ç•™ï¼‰ ******************/
function addBundle(key){
  const def=bundleDefs[key];
  const selections=[];
  Object.entries(state[key]).forEach(([name,qty])=>{
    if(name==='MNT è›‹ç™½ç²‰' && qty && typeof qty==='object'){
      const unitPrice=singlesByName[name]||0;
      const can=Math.max(0,+qty.can||0); const bag=Math.max(0,+qty.bag||0);
      if(can>0) selections.push({ name:'MNT è›‹ç™½ç²‰ï¼ˆç½ï¼‰', qty:can, unitPrice });
      if(bag>0) selections.push({ name:'MNT è›‹ç™½ç²‰ï¼ˆè¢‹ï¼‰', qty:bag, unitPrice });
    }else{
      const q=Math.max(0,+qty||0);
      if(q>0) selections.push({ name, qty:q, unitPrice:singlesByName[name]||0 });
    }
  });
  const sub=selections.reduce((s,x)=> s+x.qty*x.unitPrice,0);
  if(sub<def.minPrice){
    alert(`æœªé”è³¼è²·æ¢ä»¶ï¼Œè«‹èª¿æ•´æ•¸é‡ã€‚`);
    return;
  }
  cart.push({ type:'bundle', bundleKey:key, name:def.title, unitSubtotal:sub, unitDiscount:def.discount, selections, qty:1 });
  renderCart();
}

/****************** Gateï¼ˆç´”å‰ç«¯ï¼‰ ******************/
function normalizeInfo(raw){
  return {
    name:raw.name.trim(),
    phone:raw.phone.replace(/[^\d+]/g,''),
    email:raw.email.trim().toLowerCase(),
    nationalId:raw.nationalId.trim().toUpperCase(),
    address:(raw.address||'').trim(),
    payMethod:(raw.payMethod==='cash'?'cash':'remit'),
    remitLast5:(raw.remitLast5||'').trim(),
  };
}
function updateLast5Required(){
  const isRemit=$('#pay-remit')?.checked;
  const last5Wrap=$('#last5-wrap');
  const remitLast5=$('#remit-last5');
  if(last5Wrap && remitLast5){
    last5Wrap.style.display = isRemit? '' : 'none';
    remitLast5.required = !!isRemit;
    if(!isRemit) remitLast5.value='';
  }
}

/****************** è¨‚å–®é‡‘é¡è¨ˆç®—ï¼ˆä¾›åŒ¯å‡ºä½¿ç”¨ï¼‰ ******************/
function computeTotalsFromCart(){
  let gross=0, discount=0;
  cart.forEach(ci=>{
    if(ci.type==='single'){
      gross += Number(ci.unitPrice||0) * Number(ci.qty||0);
    }else if(ci.type==='bundle'){
      gross += Number(ci.unitSubtotal||0) * Number(ci.qty||0);
      discount += Number(ci.unitDiscount||0) * Number(ci.qty||0);
    }else{
      gross += Number(ci.rule?.fixedPrice||0) * Number(ci.qty||0);
    }
  });
  const grand = Math.max(0, gross - discount);
  return { gross, discount, grand };
}

/****************** å‰ç«¯åŒ¯å‡º/åˆ—å°å·¥å…·ï¼ˆä¸é¡¯ç¤ºæŠ˜æ‰£ï¼Œä½†ä¿ç•™ç²¾æº–é‡‘é¡ï¼‰ ******************/
function buildOrderPayload(){
  const today=$('#today').textContent;
  const orderNo=$('#orderNo').textContent;
  const info = JSON.parse(localStorage.getItem('customerInfo')||'null');
  const t = computeTotalsFromCart();
  return {
    orderNo, date: today,
    customer: info||{},
    items: JSON.parse(JSON.stringify(cart)),
    totals: {
      subtotalCents: Math.round(t.gross),
      discountCents: Math.round(t.discount),
      grandCents: Math.round(t.grand),
    },
    from: 'github-pages/index.html'
  };
}
function payloadToText(p){
  const lines = [];
  lines.push(`å–®è™Ÿï¼š${p.orderNo}`);
  lines.push(`æ—¥æœŸï¼š${p.date}`);

  const c = p.customer || {};
  lines.push(`é¡§å®¢ï¼š${c.name||''}ï½œ${c.phone||''}ï½œ${c.email||''}`);
  lines.push(`åœ°å€ï¼š${c.address||''}`);
  lines.push(`ä»˜æ¬¾ï¼š${c.payMethod==='remit'?'åŒ¯æ¬¾':''}${c.remitLast5?`ï¼ˆå¾Œäº”ç¢¼ ${c.remitLast5}ï¼‰`:''}`);
  lines.push('--- æ˜ç´° ---');

  p.items.forEach(it => {
    if(it.type === 'single'){
      lines.push(`å–®å“ï½œ${it.name} Ã— ${it.qty}  å–®åƒ¹ $${Number(it.unitPrice||0).toLocaleString()}`);
      lines.push('--------------');
    }else if(it.type === 'bundle'){
      const unitPay = Math.max(0, Number(it.unitSubtotal||0) - Number(it.unitDiscount||0));
      lines.push(`å¥—çµ„ï½œ${it.name} Ã— ${it.qty}  æ‡‰ä»˜ $${unitPay.toLocaleString()} / çµ„`);
      (it.selections||[]).forEach(s=>{
        const totalQty = Number(s.qty||0) * Number(it.qty||0);
        if(totalQty>0) lines.push(`  - ${s.name} Ã— ${totalQty}`);
      });
      lines.push('--------------');
    }else{
      const unitPrice = Number(it.rule?.fixedPrice||0);
      const line = unitPrice * Number(it.qty||0);
      lines.push(`çµ„åˆï½œ${it.name} Ã— ${it.qty}  æ‡‰ä»˜ $${line.toLocaleString()}`);
      (it.selections||[]).forEach(s=>{
        const totalQty = Number(s.qty||0) * Number(it.qty||0);
        if(totalQty>0) lines.push(`  - ${s.name} Ã— ${totalQty}`);
      });
      lines.push('--------------');
    }
  });
  lines.push('--------------');
  lines.push(`ç¸½è¨ˆï¼š$${Math.round((p.totals?.grandCents||0)).toLocaleString()}`);
  return lines.join('\n');
}

async function copyOrderText(){
  const p=buildOrderPayload();
  const text=payloadToText(p);
  try{ await navigator.clipboard.writeText(text); alert('å·²è¤‡è£½è¨‚å–®å…§å®¹åˆ°å‰ªè²¼ç°¿'); }
  catch{ prompt('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š', text); }
}
function downloadOrderJson(){
  const p=buildOrderPayload();
  const blob=new Blob([JSON.stringify(p,null,2)], {type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`order_${p.orderNo}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(a.href);
}
function printOrder(){ window.print(); }

/****************** è¨‚å–®é è¦½è¦–çª— ******************/
function openOrderPreview(){
  const p = buildOrderPayload();
  const text = payloadToText(p);
  const esc = s => s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

  const html = `<!doctype html>
  <html lang="zh-Hant"><head><meta charset="utf-8">
  <title>è¨‚å–®é è¦½ï½œ${p.orderNo}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root{ --ink:#1b2430; --muted:#6b7280; --border:#e5e7eb; }
    *{ box-sizing:border-box }
    body{ margin:0; color:var(--ink); background:#fff; font-family:"Noto Sans TC",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; letter-spacing:.2px; }
    .top{ display:flex; justify-content:space-between; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border) }
    .title{ font-weight:900; letter-spacing:1px }
    .meta{ font-size:12px; color:var(--muted) }
    .wrap{ max-width:860px; margin:0 auto; padding:16px }
    pre{ margin:16px 0 0; padding:16px; border:1px solid var(--border); border-radius:8px;
         white-space:pre-wrap; word-break:break-word; background:#fafafa; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .controls{ display:flex; gap:8px; }
    .btn{ appearance:none; border:1px solid #4b5569; color:#fff; background:#4b5569; cursor:pointer; padding:8px 12px; border-radius:8px; font-size:13px }
    .btn.secondary{ background:#fff; color:#4b5569 }
    .hint{ margin-left:8px; font-size:12px; color:var(--muted) }
    @media print{ .controls{ display:none!important } .top{ border:0 } body{ background:#fff } }
  </style></head>
  <body>
    <div class="top">
      <div><div class="title">è¨‚å–®é è¦½</div>
      <div class="meta">å–®è™Ÿï¼š${esc(p.orderNo)}ã€€æ—¥æœŸï¼š${esc(p.date)}</div></div>
      <div class="controls">
        <button class="btn secondary" id="copyBtn" type="button">è¤‡è£½å…§å®¹</button>
        <button class="btn" id="printBtn" type="button">åˆ—å° / å¦å­˜ PDF</button>
      </div>
    </div>
    <div class="wrap">
      <pre id="previewText">${esc(text)}</pre>
      <div class="hint">æç¤ºï¼šæ­¤è¦–çª—åˆ—å°æ™‚åªæœƒè¼¸å‡ºä»¥ä¸Šå…§å®¹èˆ‡æ’ç‰ˆã€‚</div>
    </div>
    <script>
      (function(){
        const getText = () => document.getElementById('previewText').innerText || document.getElementById('previewText').textContent || '';
        async function robustCopy(str){
          // 1) å…ˆå˜—è©¦ Clipboard API
          try{
            if (navigator.clipboard && window.isSecureContext !== false){
              await navigator.clipboard.writeText(str);
              return true;
            }
          }catch(e){}
          // 2) é€€å›éš±è— textarea + execCommand
          try{
            const ta = document.createElement('textarea');
            ta.value = str;
            ta.setAttribute('readonly','');
            ta.style.position = 'fixed';
            ta.style.top = '-9999px';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            ta.setSelectionRange(0, ta.value.length);
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
          }catch(e){
            return false;
          }
        }

        document.getElementById('copyBtn').addEventListener('click', async ()=>{
          const txt = getText();
          const ok = await robustCopy(txt);
          if(ok){ alert('å·²è¤‡è£½è¨‚å–®å…§å®¹åˆ°å‰ªè²¼ç°¿'); }
          else{ prompt('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä»¥ä¸‹å…§å®¹ï¼š', txt); }
        });

        document.getElementById('printBtn').addEventListener('click', ()=>{ window.print(); });

        // Ctrl/Cmd + P ç›´æ¥åˆ—å°
        window.addEventListener('keydown', (e)=>{
          if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='p'){ e.preventDefault(); window.print(); }
        });
      })();
    <\/script>
  </body></html>`;

  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.target = '_blank';
  a.rel = 'noopener';
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch(_){} }, 60_000);
}

/****************** åˆ†é /äº‹ä»¶ç¶å®š ******************/
function wireActions(){
  // æ¸…ç©ºè³¼ç‰©è»Šï¼ˆä¸»é /ä¿é¤Šé ï¼‰
  $('#clearCart').addEventListener('click',()=>{ cart.length=0; renderCart(); });
  $('#clearCart-care').addEventListener('click',()=>{ cart.length=0; renderCart(); });

  // æŸ¥çœ‹è¨‚å–® â†’ é–‹æ–°è¦–çª—é è¦½
  $('#viewOrder').addEventListener('click', openOrderPreview);
  $('#viewOrder-care').addEventListener('click', openOrderPreview);

  // åˆ†é åˆ‡æ›
  $$('[data-tab]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      $$('[data-tab]').forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      const target=btn.dataset.tab;
      const showMain=(target==='main');
      $('#page-main').style.display = showMain? '' : 'none';
      $('#page-main').setAttribute('aria-hidden', String(!showMain));
      $('#page-care').style.display = showMain? 'none' : '';
      $('#page-care').setAttribute('aria-hidden', String(showMain));
      renderCart();
    });
  });
}

/****************** åˆå§‹åŒ– ******************/
function init(){
  

  const d=new Date();
  $('#today').textContent = d.toLocaleDateString('zh-TW');
  const rand = Math.floor(Math.random()*900+100);
  const y = d.getFullYear().toString().slice(2);
  const m=(d.getMonth()+1+'').padStart(2,'0');
  const dd=d.getDate().toString().padStart(2,'0');
  $('#orderNo').textContent = `DR-${y}${m}${dd}-${rand}`;

  ['classic','super','light'].forEach(renderBundle);
  $$('[data-add-bundle]').forEach(btn=> btn.addEventListener('click',()=> addBundle(btn.dataset.addBundle)));
  renderSingles(); renderCombos(); renderCareLists(); renderCart(); wireActions();

  updateLast5Required();
  $('#pay-remit')?.addEventListener('change', updateLast5Required);

  $('#customer-form').addEventListener('submit', (e)=>{
    e.preventDefault();
    const infoRaw={
      name:$('#cust-name').value||'',
      phone:$('#cust-phone').value||'',
      email:$('#cust-email').value||'',
      nationalId:$('#cust-nid').value||'',
      address:$('#cust-address').value||'',
      payMethod: document.querySelector('input[name="payMethod"]:checked')?.value || 'remit',
      remitLast5: $('#remit-last5')?.value || ''
    };
    if(!infoRaw.name.trim()||!infoRaw.phone.trim()||!infoRaw.email.trim()||!infoRaw.nationalId.trim()||!infoRaw.address.trim()){
      alert('è«‹å®Œæ•´å¡«å¯«è³‡æ–™'); return;
    }
    if(infoRaw.payMethod==='remit' && !/^\d{5}$/.test(infoRaw.remitLast5)){
      alert('è«‹è¼¸å…¥ 5 ä½æ•¸å­—çš„åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼'); return;
    }
    const info=normalizeInfo(infoRaw);
    localStorage.setItem('customerInfo', JSON.stringify(info));
    document.getElementById('customer-gate').style.display='none';
    document.getElementById('shop-root').style.display='';
  });
}
document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
