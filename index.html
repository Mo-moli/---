<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é†«å¸«å‹¾é¸å–®ï¼ˆåœ–ç‰‡åƒç´ ç´šæ’ç‰ˆï½œMNT ç½/è¢‹ï¼‰</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#1b2430; --muted:#6b7280; --bg:#f7f7f9; --panel:#ffffff; --border:#e5e7eb;
    --head:#2c3446; --head-text:#e5e7ee; --tab:#eef2f7; --price:#0f172a;
    --pill-bg:#e8eefc; --pill-text:#3556c6; --warn:#b45309;
    --tab-active:#4b5569; --tab-active-text:#fff;

    --page-max: 1600px;   /* ä¸»å®¹å™¨æœ€å¤§å¯¬åº¦ */
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"Noto Sans TC", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    letter-spacing:.2px;
  }

  /* ===== é ‚éƒ¨æ·±è‰²æ¨™é¡Œæ¢ ===== */
  .topbar{
    background:var(--head); color:var(--head-text);
    padding:10px 16px 6px; border-bottom:4px solid #424c64;
  }
  .topbar .title{ font-weight:900; letter-spacing:2px; font-size:26px; text-align:center }
  .topbar .meta{ display:flex; justify-content:flex-end; gap:18px; margin-top:4px; font-size:13px; opacity:.95 }

  /* ===== åˆ†é  Tab ===== */
  .tabs{ background:#f0f2f7; border-bottom:1px solid var(--border) }
  .tabs .wrap{ display:flex; gap:8px; padding:8px 12px; max-width:1180px; margin:0 auto }
  .tabbtn{
    appearance:none; border:1px solid var(--border); background:#fff; color:var(--ink);
    padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600; font-size:14px;
  }
  .tabbtn.active{ background:var(--tab-active); color:var(--tab-active-text); border-color:var(--tab-active) }

  /* ===== ç‰ˆé¢ï¼šä¸Šæ–¹ 6 å¡ç‰‡ + ä¸‹æ–¹æ•´æ’è³¼ç‰©è»Š ===== */
  .wrap{ max-width: var(--page-max); margin:14px auto 24px; padding:0 12px }

  .grid{
    display:grid;
    grid-template-columns: repeat(6, 1fr); /* ä¸Šæ’ 6 å¼µå¡å‰›å¥½ä¸€åˆ— */
    gap:16px;
    align-items:start;
  }
  /* éŸ¿æ‡‰å¼ï¼šä¸­è¢å¹• 3 æ¬„ï¼Œå°è¢å¹• 2 / 1 æ¬„ */
  @media (max-width:1280px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
  @media (max-width:860px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
  @media (max-width:600px){ .grid{ grid-template-columns: 1fr; } }

  /* ===== ä¸»é è³¼ç‰©è»Šï¼ˆç½®åº•æ•´æ’ï¼‰ ===== */
    .cart-full{
      grid-column: 1 / -1;
      position: relative;  /* ä¸è¦å›ºå®š */
    }

    /* ===== ç¬¬äºŒé è³¼ç‰©è»Šï¼ˆå³ä¸Šè§’å›ºå®šï¼‰ ===== */
    .cart-care{
      position: sticky;
      top: 78px;
      align-self: start;
    }


  /* ===== ç¬¬äºŒé ï¼ˆä¿é¤Šï¼èŒ¶é£²ï¼‰ç‰ˆé¢ï¼šå…§å®¹ + è³¼ç‰©è»Š ===== */
  .grid-care{
    display:grid; grid-template-columns: 1fr 520px; gap:12px;
  }
  @media (max-width:1220px){ .grid-care{ grid-template-columns: 1fr; } }

  /* ===== å¡ç‰‡ ===== */
  .card{ background:var(--panel); border:1px solid var(--border); border-radius:10px; overflow:hidden }
  .card.hang{ position:relative }
  .card.hang:before{
    content:""; position:absolute; top:-12px; left:50%; transform:translateX(-50%);
    width:36px; height:36px; border-radius:999px; background:#f0f2f7; border:4px solid #cfd6e8;
    box-shadow: inset 0 0 0 6px #f7f8fb; z-index:2;
  }
  .card h3{ margin:0; padding:9px 12px; font-size:15px; color:#fff; background:#4b5569;
            border-bottom:1px solid #3e485d; letter-spacing:1px }
  .content{ padding:10px 12px }

  /* ===== è¡¨æ ¼ ===== */
  table{ width:100%; border-collapse:collapse; font-size:12.5px }
  thead th{ background:#eef1f6; font-weight:700; font-size:12.5px }
  th,td{ padding:10px 8px; border-bottom:1px solid var(--border); vertical-align:middle; line-height:1.2 }
  tr{ height:44px }
  th.qty, td.qty{ width:96px; text-align:center; white-space:nowrap }
  td.right{ text-align:right }
  .price{ font-variant-numeric:tabular-nums; color:var(--price) }

  /* ===== MNT ç½ï¼è¢‹åˆ— ===== */
  .mnt-row td{ padding:10px 8px }
  .mnt-name{ display:block; font-weight:500; margin-bottom:6px }
  .mnt-subline{ display:flex; gap:14px; flex-wrap:wrap; font-size:12px; color:var(--muted) }
  .mnt-subline label{ display:inline-flex; align-items:center; gap:6px }
  .mnt-subline input{ width:58px; text-align:center; height:28px }
  .mnt-qty-total{ font-weight:700 }

  /* ===== å°å…ƒä»¶ ===== */
  .stack{ display:flex; flex-direction:column; gap:6px }
  .row{ display:flex; justify-content:space-between; align-items:center; gap:8px }
  .pill{ display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px;
         background:var(--pill-bg); color:var(--pill-text); border:1px solid #c9d5ff }
  .muted{ color:#6b7280; font-size:12px }
  .warn{ color:var(--warn); font-size:12px }
  .btn{ appearance:none; border:1px solid #4b5569; color:#4b5569; background:#fff; cursor:pointer;
        padding:6px 10px; border-radius:8px; font-size:13px }
  .btn.primary{ background:#4b5569; color:#fff }
  .tag{ font-size:11px; padding:2px 6px; border-radius:999px; background:#fef3c7; border:1px solid #f8ce7a; color:#7a5200 }

  /* ===== æ¸…å–® ===== */
  .list{ list-style:none; padding:0; margin:0 }
  .list li{ display:flex; justify-content:space-between; align-items:center; gap:6px; padding:8px 0;
            border-bottom:1px solid var(--border) }
  .list .meta{ display:flex; align-items:center; gap:6px }

  /* ===== è³¼ç‰©è»Š ===== */
  .cart .row{ font-size:14px }
  .cart .subtotal{ font-weight:800; padding-top:8px; border-top:1px dashed var(--border) }
  .cart-item{ display:grid; grid-template-columns:1fr auto; gap:4px; padding:8px 0; border-bottom:1px dashed var(--border) }
  .qtyctl{ display:flex; align-items:center; gap:6px }
  .qtyctl button{ width:28px; height:28px; border-radius:6px }

  /* ===== åˆ—å° ===== */
  @media print{
    body{ background:#fff }
    .topbar{ -webkit-print-color-adjust:exact; print-color-adjust:exact }
    .tabs{ display:none!important }
    .card.hang:before{ display:none!important }
    .grid{ grid-template-columns: repeat(3, 1fr); gap:10px }
    .cart-full{ grid-column: 1 / -1; }
    .content{ padding:8px 10px }
    th,td{ padding:5px 5px; font-size:12px }
    .btn{ display:none!important }
  }
</style>
</head>
<body>
  <!-- æ·±è‰²æŠ¬é ­å€ -->
  <div class="topbar">
    <div class="title">é†«&nbsp;&nbsp;å¸«&nbsp;&nbsp;å‹¾&nbsp;&nbsp;é¸&nbsp;&nbsp;å–®</div>
    <div class="meta">
      <div>æ—¥æœŸï¼š<span id="today"></span></div>
      <div>å–®è™Ÿï¼š<span id="orderNo"></span></div>
    </div>
  </div>

  <!-- åˆ†é  -->
  <nav class="tabs">
    <div class="wrap">
      <button class="tabbtn active" data-tab="main">ä¸»é ï¼ˆå¥—çµ„ / å–®å“ / çµ„åˆåƒ¹ï¼‰</button>
      <button class="tabbtn" data-tab="care">ç„¡é½¡é†«å¸«ä¿é¤Šå“ & èŒ¶é£²</button>
    </div>
  </nav>

  <!-- Page Aï¼šä¸»é  -->
  <section class="wrap" id="page-main" aria-hidden="false">
    <div class="grid">
      <!-- ä¸‰å€‹å¥—çµ„ -->
      <section class="card hang" id="classicCard">
        <h3>ç¶“å…¸å¥—çµ„</h3>
        <div class="content">
          <table>
            <thead><tr><th>å“é …</th><th class="qty">æ•¸é‡</th></tr></thead>
            <tbody id="classicBody"></tbody>
          </table>
          <div class="content stack" style="padding:8px 0 0">
            <div class="row"><span class="pill">å¯æ­åƒ¹</span><b class="price" id="classicDeal"></b></div>
            <div class="row"><span>å•†å“å°è¨ˆ</span><b class="price" id="classicSub"></b></div>
            <div class="muted">åˆ / è¤‡è¨ºå¯æ­ $15,000</div>
            <div class="muted" id="classicHint"></div>
            <div class="row"><button class="btn primary" data-add-bundle="classic">åŠ å…¥æ•´çµ„</button></div>
          </div>
        </div>
      </section>

      <section class="card hang" id="superCard">
        <h3>è¶…å€¼å‡ç´šå¥—çµ„</h3>
        <div class="content">
          <table>
            <thead><tr><th>å“é …</th><th class="qty">æ•¸é‡</th></tr></thead>
            <tbody id="superBody"></tbody>
          </table>
          <div class="content stack" style="padding:8px 0 0">
            <div class="row"><span class="pill">å¯æ­åƒ¹</span><b class="price" id="superDeal"></b></div>
            <div class="row"><span>å•†å“å°è¨ˆ</span><b class="price" id="superSub"></b></div>
            <div class="muted">åˆ / è¤‡è¨ºå¯æ­ $30,000</div>
            <div class="muted" id="superHint"></div>
            <div class="row"><button class="btn primary" data-add-bundle="super">åŠ å…¥æ•´çµ„</button></div>
          </div>
        </div>
      </section>

      <section class="card hang" id="lightCard">
        <h3>è¼•ç›ˆå¥—çµ„</h3>
        <div class="content">
          <table>
            <thead><tr><th>å“é …</th><th class="qty">æ•¸é‡</th></tr></thead>
            <tbody id="lightBody"></tbody>
          </table>
          <div class="content stack" style="padding:8px 0 0">
            <div class="row"><span class="pill">å¯æ­åƒ¹</span><b class="price" id="lightDeal"></b></div>
            <div class="row"><span>å•†å“å°è¨ˆ</span><b class="price" id="lightSub"></b></div>
            <div class="muted">åªé™æ ¸è¨º $9,800</div>
            <div class="muted" id="lightHint"></div>
            <div class="row"><button class="btn primary" data-add-bundle="light">åŠ å…¥æ•´çµ„</button></div>
          </div>
        </div>
      </section>

      <!-- å–®å“ -->
      <section class="card">
        <h3>å–®å“</h3>
        <div class="content">
          <ul class="list" id="singlesList"></ul>
        </div>
      </section>

      <!-- çµ„åˆå„ªæƒ ï¼ˆå·¦ï¼‰ -->
      <section class="card">
        <h3>çµ„åˆå„ªæƒ åƒ¹</h3>
        <div class="content stack" id="combos"></div>
      </section>

      <!-- çµ„åˆå„ªæƒ ï¼ˆå³ï¼‰ -->
      <section class="card">
        <h3>çµ„åˆå„ªæƒ åƒ¹</h3>
        <div class="content stack" id="combos-right"></div>
      </section>

      <!-- â†“â†“â†“ é€™ä¸€å¡Šæ”¹æˆç½®åº•æ•´æ’è³¼ç‰©è»Š â†“â†“â†“ -->
      <aside class="card cart cart-full">
        <h3>è³¼ç‰©è»Š</h3>
        <div class="content">
          <div id="cartItems"></div>
          <div class="muted" id="bundleNotes" style="margin-top:6px"></div>
          <hr style="border:none;border-top:1px solid var(--border);margin:8px 0" />
          <div class="row"><span>å°è¨ˆ</span><span class="price" id="subtotal">$0</span></div>
          <div class="row"><span>æŠ˜æ‰£</span><span class="price" id="discount">$0</span></div>
          <div class="row subtotal"><span>ç¸½è¨ˆ</span><span class="price" id="grandTotal">$0</span></div>
          <div class="row" style="gap:8px; margin-top:10px">
            <button class="btn" id="clearCart">æ¸…ç©º</button>
            <button class="btn primary" id="submitOrder">é€å‡ºè¨‚å–®</button>
          </div>
        </div>
      </aside>
      <!-- â†‘â†‘â†‘ ç½®åº•æ•´æ’è³¼ç‰©è»Š â†‘â†‘â†‘ -->
    </div>
  </section>

  <!-- Page Bï¼šç„¡é½¡é†«å¸«ä¿é¤Šå“ & èŒ¶é£²ï¼ˆç¶­æŒåŸæœ¬ï¼‰ -->
  <section class="wrap" id="page-care" aria-hidden="true" style="display:none">
    <div class="grid-care">
      <div class="stack">
        <section class="card">
          <h3>ğŸ’§ ä¿é¤Šå“</h3>
          <div class="content"><ul class="list" id="care-skin"></ul></div>
        </section>
        <section class="card">
          <h3>ğŸµ é£Ÿå“ / é£²å“</h3>
          <div class="content"><ul class="list" id="care-drink"></ul></div>
        </section>
        <section class="card">
          <h3>ğŸ› ï¸ å…¶ä»–ç”¨å“</h3>
          <div class="content"><ul class="list" id="care-others"></ul></div>
        </section>
        <section class="card">
          <h3>ğŸŒ¸ ç§å¯†ä¿é¤Š</h3>
          <div class="content"><ul class="list" id="care-intimate"></ul></div>
        </section>
        <section class="card">
          <h3>ğŸ’ª å¥åº·è£œçµ¦</h3>
          <div class="content"><ul class="list" id="care-health"></ul></div>
        </section>

        <!-- å›ºå®šé…æ–¹çµ„åˆ -->
        <section class="card">
          <h3>ä¿é¤Šä¸‰ä»¶çµ„ï¼ˆå›ºå®šé…æ–¹ï¼‰</h3>
          <div class="content stack">
            <div class="row"><span class="tag">å›ºå®šåƒ¹ $4,980ï¼ˆåŸåƒ¹ $5,230ï¼‰</span></div>
            <ul class="list">
              <li><div class="meta"><span>èƒºåŸºé…¸æ´—é¡æ…•çµ² Ã— 1</span><span class="muted">$680</span></div></li>
              <li><div class="meta"><span>å¤–æ³Œé«”ä¿®è­·ç²¾è¯æ¶² Ã— 1</span><span class="muted">$2,500</span></div></li>
              <li><div class="meta"><span>çš®è„‚è†œä¿®è­·ä¹³éœœ Ã— 1</span><span class="muted">$2,050</span></div></li>
            </ul>
            <div class="row">
              <label class="muted" style="display:inline-flex;align-items:center;gap:6px">
                <span>çµ„æ•¸</span>
                <input type="number" min="1" value="1" id="sets-skin3" style="width:64px;text-align:center;height:28px">
              </label>
              <button class="btn primary" id="add-skin3">åŠ å…¥çµ„åˆåŒ…</button>
            </div>
          </div>
        </section>
      </div>

      <!-- å³ï¼šè³¼ç‰©è»Šï¼ˆåŒæ­¥ï¼‰ -->
      <!-- å³ï¼šè³¼ç‰©è»Šï¼ˆåŒæ­¥ï¼‰ -->
      <aside class="card cart cart-care">
        <h3>è³¼ç‰©è»Š</h3>
        <div class="content">
          <div id="cartItems-care"></div>
          <div class="muted" id="bundleNotes-care" style="margin-top:6px"></div>
          <hr style="border:none;border-top:1px solid var(--border);margin:8px 0" />
          <div class="row"><span>å°è¨ˆ</span><span class="price" id="subtotal-care">$0</span></div>
          <div class="row"><span>æŠ˜æ‰£</span><span class="price" id="discount-care">$0</span></div>
          <div class="row subtotal"><span>ç¸½è¨ˆ</span><span class="price" id="grandTotal-care">$0</span></div>
          <div class="row" style="gap:8px; margin-top:10px">
            <button class="btn" id="clearCart-care">æ¸…ç©º</button>
            <button class="btn primary" id="submitOrder-care">é€å‡ºè¨‚å–®</button>
          </div>
          <div class="muted">ï¼ˆæ­¤è™•é¡¯ç¤ºèˆ‡ä¸»é è³¼ç‰©è»ŠåŒæ­¥ï¼‰</div>
        </div>
      </aside>

    </div>
  </section>

<script>
/****************** è³‡æ–™ ******************/
const currency = n => "$" + (n||0).toLocaleString();

// å–®å“ï¼ˆä¸»é ï¼‰
const singles = [
  { id:"mnt_protein", name:"MNT è›‹ç™½ç²‰", unitPrice:1880 },
  { id:"light_digest", name:"æš¢ä¾¿è¼•", unitPrice:1200 },
  { id:"wei_shijia", name:"è¡›é©ä½³", unitPrice:1200 },
  { id:"jiao_yuan_c", name:"å¬Œåœ“C", unitPrice:1200 },
  { id:"morning_capsule", name:"æ—©å®‰è† å›Š", unitPrice:900 },
  { id:"night_chew", name:"æ™šå®‰å’€åš¼éŒ ", unitPrice:900 },
  { id:"oil_cut", name:"æ²¹æ¾±é›™åˆ‡", unitPrice:600 },
  { id:"elite", name:"å„ªå…ˆç›ˆ", unitPrice:1500 },
  { id:"clean_mouth", name:"æ¸…å£æ¨‚", unitPrice:600 },
  { id:"double_l", name:"é›™Lç›ŠèŒç³–", unitPrice:1200 },
  { id:"fish_oil", name:"é»ƒæ™¶é­šæ²¹", unitPrice:1300 },
  { id:"night_relax", name:"å¤œå…çœ ", unitPrice:1300 },
  { id:"sensitive", name:"å…æ•é€š", unitPrice:1300 },
  { id:"berry", name:"å…åª„è“", unitPrice:1300 }
];

// ===== æ–°å¢ï¼šç„¡é½¡é†«å¸«ä¿é¤Šå“ & èŒ¶é£²ï¼ˆç¬¬äºŒé ï¼‰ =====
const careCatalog = {
  skin: [
    { id:"foam_cleanser", name:"èƒºåŸºé…¸æ´—é¡æ…•çµ²", unitPrice:680 },
    { id:"exo_serum", name:"å¤–æ³Œé«”ä¿®è­·ç²¾è¯æ¶²", unitPrice:2500 },
    { id:"lipid_cream", name:"çš®è„‚è†œä¿®è­·ä¹³éœœ", unitPrice:2050 },
    { id:"tinted_sunscreen", name:"è¼•é€æ½¤è‰²é˜²æ›¬ä¹³", unitPrice:980 },
    { id:"exo_mask_single", name:"å¤–æ³Œé«”ä¿®è­·é¢è†œï¼ˆå–®ç‰‡ï¼‰", unitPrice:180 },
    { id:"exo_mask_box", name:"å¤–æ³Œé«”ä¿®è­·é¢è†œï¼ˆä¸€ç›’5ç‰‡ï¼‰", unitPrice:850 },
  ],
  drink: [
    { id:"yogurt", name:"å…å„ªæ ¼ï¼ˆé™å°åŒ—ç„¡é½¡è‡ªå–ï¼‰", unitPrice:680 },
    { id:"tea_calm", name:"å¥½å¥½å®‰å¿ƒèŒ¶", unitPrice:600 },
    { id:"tea_beauty", name:"ç¾ç¾æ¼‚æ¼‚èŒ¶", unitPrice:600 },
    { id:"tea_energy", name:"æ»¿æ»¿æ´»åŠ›èŒ¶", unitPrice:600 },
  ],
  others: [
    { id:"ketone_device", name:"æ°£é…®æ©Ÿ", unitPrice:3950 },
    { id:"blender_bottle", name:"Blender æ–æ¯", unitPrice:380 },
  ],
  intimate: [
    { id:"intimate_firm", name:"ç§å¯†ç·Šå¯¦ç²¾èƒ", unitPrice:3110 },
    { id:"intimate_clean", name:"ç§å¯†æ·¨æ½¤ç²¾èƒ", unitPrice:1880 },
    { id:"intimate_hyal", name:"ç»å°¿é…¸ç§å¯†éœ²", unitPrice:550 },
  ],
  health: [
    { id:"b1_patch", name:"B1 æ´»åŠ›è²¼ç‰‡", unitPrice:780 },
  ]
};

const singlesByName = Object.fromEntries(
  [...singles, ...Object.values(careCatalog).flat()].map(s=>[s.name, s.unitPrice])
);

// å¥—çµ„å®šç¾©ï¼ˆä¸»é ï¼‰
const bundleDefs = {
  classic: {
    title:"ç¶“å…¸å¥—çµ„", displayPrice:15000, minPrice:16140,
    items:[
      ["MNT è›‹ç™½ç²‰",3], ["æš¢ä¾¿è¼•",2], ["è¡›é©ä½³",1], ["å¬Œåœ“C",2], ["æ—©å®‰è† å›Š",1], ["æ™šå®‰å’€åš¼éŒ ",1], ["æ²¹æ¾±é›™åˆ‡",1], ["å„ªå…ˆç›ˆ",1], ["æ¸…å£æ¨‚",1], ["4+2R è¿½è¹¤",1]
    ]
  },
  super: {
    title:"è¶…å€¼å‡ç´šå¥—çµ„", displayPrice:30000, minPrice:33340,
    items:[
      ["MNT è›‹ç™½ç²‰",8], ["æš¢ä¾¿è¼•",4], ["è¡›é©ä½³",2], ["å¬Œåœ“C",3], ["æ—©å®‰è† å›Š",2], ["æ™šå®‰å’€åš¼éŒ ",2], ["æ²¹æ¾±é›™åˆ‡",1], ["å„ªå…ˆç›ˆ",1], ["æ¸…å£æ¨‚",1], ["é›™Lç›ŠèŒç³–",1], ["4+2R è¿½è¹¤",2]
    ]
  },
  light: {
    title:"è¼•ç›ˆå¥—çµ„", displayPrice:9800, minPrice:9840,
    items:[
      ["MNT è›‹ç™½ç²‰",3], ["æš¢ä¾¿è¼•",1], ["å¬Œåœ“C",1], ["æ—©å®‰è† å›Š",1], ["æ™šå®‰å’€åš¼éŒ ",1], ["4+2R è¿½è¹¤",1]
    ]
  }
};

// MNT ç½ / è¢‹ é è¨­ï¼ˆç¸½æ•¸åˆ†åˆ¥ç‚º 3 / 8 / 3ï¼‰
const mntPreset = {
  classic: { can:1, bag:2 },
  super:   { can:3, bag:5 },
  light:   { can:1, bag:2 }
};

// çµ„åˆï¼ˆä¸»é ï¼‰
const combos = [
  { id:"mnt3pack", title:"MNT è›‹ç™½ç²‰ 3 å…¥ä»»é¸ï¼ˆç½ï¼è¢‹ï¼‰",
    rule:{ type:"mntCanBagTotalFixed", n:3, fixedPrice:5000, init:{can:1, bag:2} }, product:"MNT è›‹ç™½ç²‰" },
  { id:"mix8", title:"æš¢/è¡›/C/L/é­š/å¤œ/æ•/è“ çµ„åˆ",
    rule:{ type:"pickTierFixed", tiers:[ {n:6, price:6300}, {n:3, price:3300} ] },
    choices:["æš¢ä¾¿è¼•","è¡›é©ä½³","å¬Œåœ“C","é›™Lç›ŠèŒç³–","é»ƒæ™¶é­šæ²¹","å¤œå…çœ ","å…æ•é€š","å…åª„è“"] },
  { id:"earlyLate", title:"æ—©æ™šå®‰çµ„åˆ", rule:{type:"pickNFixed", n:4, fixedPrice:3200}, choices:["æ—©å®‰è† å›Š","æ™šå®‰å’€åš¼éŒ "] },
  { id:"goldOil", title:"é‡‘éŠ€åŒ…çµ„åˆ", rule:{ type:"exactBundleFixed", fixedPrice:5000, items:[ {name:"å„ªå…ˆç›ˆ", qty:3}, {name:"æ²¹æ¾±é›™åˆ‡", qty:2} ] } },
  { id:"gradFav", title:"ç•¢æ¥­ç”Ÿæœ€æ„›çµ„åˆ", rule:{ type:"exactBundleFixed", fixedPrice:6200, items:[ {name:"å„ªå…ˆç›ˆ", qty:3}, {name:"é›™Lç›ŠèŒç³–", qty:2} ] } },
  { id:"tea3", title:"èŒ¶åŒ…ä¸‰å…¥ä»»é¸", rule:{ type:"pickNFixed", n: 3, fixedPrice: 1500 }, choices: ["å¥½å¥½å®‰å¿ƒèŒ¶","ç¾ç¾æ¼‚æ¼‚èŒ¶","æ»¿æ»¿æ´»åŠ›èŒ¶"] }
];

/****************** ç‹€æ…‹ ******************/
const cart = [];

function initialStateFromBundle(key){
  const def = bundleDefs[key];
  const o = {};
  def.items.forEach(([name,qty])=>{
    if(name === "MNT è›‹ç™½ç²‰"){ o[name] = { ...mntPreset[key] }; }
    else{ o[name] = qty; }
  });
  return o;
}
const state = {
  classic: initialStateFromBundle('classic'),
  super:   initialStateFromBundle('super'),
  light:   initialStateFromBundle('light')
};

/****************** å·¥å…· ******************/
const $ = s=>document.querySelector(s);
const $$ = s=>[...document.querySelectorAll(s)];
function bundleSubtotal(key){
  const o = state[key]; let sum = 0;
  for(const [name,qty] of Object.entries(o)){
    if(name === "MNT è›‹ç™½ç²‰"){
      const unit = singlesByName[name]||0;
      const can = (qty && qty.can)? +qty.can : 0;
      const bag = (qty && qty.bag)? +qty.bag : 0;
      sum += (can + bag) * unit;
    }else{
      sum += (singlesByName[name]||0) * (+qty||0);
    }
  }
  return sum;
}

/****************** Renderï¼šä¸‰å€‹å¥—çµ„ï¼ˆä¸»é ï¼‰ ******************/
function renderBundle(key){
  const def = bundleDefs[key];
  const tbody = document.getElementById(key+"Body");
  tbody.innerHTML = def.items.map(([name,qty])=>{
    if(name === "MNT è›‹ç™½ç²‰"){
      const cur = state[key][name] || { can:0, bag:0 };
      const total = (+cur.can||0) + (+cur.bag||0);
      return `<tr class="mnt-row">
        <td>
          <span class="mnt-name">${name}</span>
          <div class="mnt-subline">
            <label>ç½ <input type="number" min="0" step="1" value="${cur.can}" data-mnt="${key}:can"></label>
            <label>è¢‹ <input type="number" min="0" step="1" value="${cur.bag}" data-mnt="${key}:bag"></label>
          </div>
        </td>
        <td class="qty"><span class="mnt-qty-total" id="${key}-mnt-total">${total}</span></td>
      </tr>`;
    }
    const val = state[key][name] ?? qty;
    return `<tr>
      <td>${name}</td>
      <td class="qty"><input type="number" min="0" step="1" value="${val}" data-bq="${key}:${name}" style="width:58px;text-align:center;height:28px"></td>
    </tr>`;
  }).join("");

  const sub = bundleSubtotal(key);
  document.getElementById(key+"Deal").textContent = currency(sub||def.displayPrice);
  document.getElementById(key+"Sub").textContent  = currency(sub);
  const hint = document.getElementById(key+"Hint");
  hint.textContent = sub < def.minPrice ? "ç›®å‰å•†å“å°è¨ˆä½æ–¼æœ€ä½æ‡‰ä»˜ï¼ŒåŠ å…¥è³¼ç‰©è»Šæ™‚å°‡è‡ªå‹•è£œå·®ã€‚" : "å·²é”æˆ–è¶…éæœ€ä½æ‡‰ä»˜ï¼Œå°‡ä»¥å•†å“å°è¨ˆè¨ˆåƒ¹ã€‚";

  // ç¶ä¸€èˆ¬å“ input
  $$(`input[data-bq^="${key}:"]`).forEach(i=>{
    i.addEventListener("input",()=>{
      const [k,name] = i.dataset.bq.split(":");
      state[k][name] = Math.max(0, parseInt(i.value||"0")||0);
      const s = bundleSubtotal(k);
      document.getElementById(k+"Deal").textContent = currency(s||bundleDefs[k].displayPrice);
      document.getElementById(k+"Sub").textContent  = currency(s);
      document.getElementById(k+"Hint").textContent = s < bundleDefs[k].minPrice ? "ç›®å‰å•†å“å°è¨ˆä½æ–¼æœ€ä½æ‡‰ä»˜ï¼ŒåŠ å…¥è³¼ç‰©è»Šæ™‚å°‡è‡ªå‹•è£œå·®ã€‚" : "å·²é”æˆ–è¶…éæœ€ä½æ‡‰ä»˜ï¼Œå°‡ä»¥å•†å“å°è¨ˆè¨ˆåƒ¹ã€‚";
    });
  });

  // ç¶ MNT ç½/è¢‹ input
  $$(`input[data-mnt^='${key}:']`).forEach(i=>{
    i.addEventListener('input',()=>{
      const [k,which] = i.dataset.mnt.split(':');
      const obj = state[k]["MNT è›‹ç™½ç²‰"] || {can:0, bag:0};
      obj[which] = Math.max(0, parseInt(i.value||'0')||0);
      state[k]["MNT è›‹ç™½ç²‰"] = obj;

      const total = (+obj.can||0) + (+obj.bag||0);
      const totalEl = document.getElementById(`${k}-mnt-total`);
      if(totalEl) totalEl.textContent = String(total);

      const s = bundleSubtotal(k);
      document.getElementById(k+"Deal").textContent = currency(s||bundleDefs[k].displayPrice);
      document.getElementById(k+"Sub").textContent  = currency(s);
      document.getElementById(k+"Hint").textContent = s < bundleDefs[k].minPrice ? "ç›®å‰å•†å“å°è¨ˆä½æ–¼æœ€ä½æ‡‰ä»˜ï¼ŒåŠ å…¥è³¼ç‰©è»Šæ™‚å°‡è‡ªå‹•è£œå·®ã€‚" : "å·²é”æˆ–è¶…éæœ€ä½æ‡‰ä»˜ï¼Œå°‡ä»¥å•†å“å°è¨ˆè¨ˆåƒ¹ã€‚";
    });
  });
}

/****************** Renderï¼šä¸»é å–®å“ ******************/
function renderSingles(){
  const ul = document.getElementById("singlesList");
  ul.innerHTML = "";
  singles.forEach(s=>{
    const li = document.createElement("li");
    li.innerHTML = `<div class="meta"><span>${s.name}</span><span class="muted">${currency(s.unitPrice)}</span></div>
                    <button class="btn" data-single="${s.id}">ï¼‹</button>`;
    ul.appendChild(li);
  });
  $$("[data-single]").forEach(btn=> btn.addEventListener("click",()=>{
    const s = [...singles, ...Object.values(careCatalog).flat()].find(x=>x.id===btn.dataset.single);
    const found = cart.find(c=> c.type==='single' && c.itemId===s.id);
    if(found){ found.qty++; }else{ cart.push({type:'single', itemId:s.id, name:s.name, unitPrice:s.unitPrice, qty:1}); }
    renderCart();
  }));
}

/****************** Renderï¼šçµ„åˆï¼ˆä¸»é ï¼Œåˆ†æµåˆ°ä¸»å®¹å™¨ & å³æ¬„ï¼‰ ******************/
function renderCombos(){
  const mainWrap  = document.getElementById("combos");
  const rightWrap = document.getElementById("combos-right");
  mainWrap.innerHTML = "";
  if (rightWrap) rightWrap.innerHTML = "";

  // ä»ä¿ç•™å³å´ç²¾é¸å››çµ„ï¼ˆç…§èˆŠï¼‰
  const RIGHT_COMBO_IDS = new Set(["earlyLate", "goldOil", "gradFav", "tea3"]);

  const appendBlock = (el) => (container) => container && container.appendChild(el);

  combos.forEach(c=>{
    const target = RIGHT_COMBO_IDS.has(c.id) ? rightWrap : mainWrap;

    if(c.rule.type === "mntCanBagTotalFixed"){
      const id = c.id, n=c.rule.n;
      const initCan = (c.rule.init && c.rule.init.can) || 0;
      const initBag = (c.rule.init && c.rule.init.bag) || 0;

      const block = document.createElement("div");
      block.className = "card";
      block.innerHTML = `<div class="content">
        <div class="row" style="margin-bottom:6px">
          <b>${c.title}</b>
          <span class="tag">${n} å…¥ä»»é¸ / å›ºå®šåƒ¹ ${currency(c.rule.fixedPrice)}</span>
        </div>
        <div class="row" style="margin:6px 0"><span>${c.product}ï¼ˆç½ï¼‰</span><input type="number" min="0" value="${initCan}" data-mntpack="${id}:can" style="width:58px;text-align:center;height:28px"></div>
        <div class="row" style="margin:6px 0"><span>${c.product}ï¼ˆè¢‹ï¼‰</span><input type="number" min="0" value="${initBag}" data-mntpack="${id}:bag" style="width:58px;text-align:center;height:28px"></div>
        <div class="row" style="margin-top:6px">
          <div class="muted">ç¸½è¨ˆ <b id="cnt-${id}">${initCan+initBag}</b> / ${n}</div>
          <button class="btn primary" data-add-mntpack="${id}" ${(initCan+initBag)===n? "":"disabled"}>åŠ å…¥çµ„åˆåŒ…</button>
        </div>
      </div>`;
      appendBlock(block)(target);

      const canInput = document.querySelector(`input[data-mntpack='${id}:can']`);
      const bagInput = document.querySelector(`input[data-mntpack='${id}:bag']`);
      const btn = document.querySelector(`[data-add-mntpack='${id}']`);
      const cnt = document.getElementById(`cnt-${id}`);
      const update=()=>{
        const can=+canInput.value||0, bag=+bagInput.value||0, sum=can+bag;
        cnt.textContent=String(sum); btn.disabled = sum!==n;
      };
      canInput.addEventListener('input',update);
      bagInput.addEventListener('input',update);
      btn.addEventListener('click', ()=>{
        const can=+canInput.value||0, bag=+bagInput.value||0;
        const selections=[]; if(can>0) selections.push({name:`${c.product}ï¼ˆç½ï¼‰`, qty:can});
        if(bag>0) selections.push({name:`${c.product}ï¼ˆè¢‹ï¼‰`, qty:bag});
        cart.push({ type:'combo', name:c.title, rule:c.rule, selections, qty:1 });
        canInput.value=c.rule.init?.can||0; bagInput.value=c.rule.init?.bag||0; update(); renderCart();
      });
      update(); return;
    }

    if (c.rule.type === "pickTierFixed") {
  const id = c.id;
  const [tierA, tierB] = c.rule.tiers; // ä¾‹å¦‚ {n:6, price:6300}ã€{n:3, price:3300}
  const block = document.createElement("div");
  block.className = "card";
  block.innerHTML = `
    <div class="content">
      <div class="row" style="margin-bottom:6px">
        <b>${c.title}</b>
        <span class="tag" id="tag-${id}">${tierA.n} å…¥ä»»é¸ / å›ºå®šåƒ¹ ${currency(tierA.price)}</span>
      </div>

      <!-- 6å…¥ / 3å…¥ æ–¹æ¡ˆåˆ‡æ› -->
      <div class="row" style="gap:16px; margin:6px 0 10px">
        <label style="display:inline-flex;align-items:center;gap:6px">
          <input type="radio" name="tier-${id}" value="0" checked>
          <span>${tierA.n} å…¥ / ${currency(tierA.price)}</span>
        </label>
        <label style="display:inline-flex;align-items:center;gap:6px">
          <input type="radio" name="tier-${id}" value="1">
          <span>${tierB.n} å…¥ / ${currency(tierB.price)}</span>
        </label>
      </div>

      <!-- å¯è¼¸å…¥ã€Œæ•¸é‡ã€çš„æ¸…å–®ï¼ˆå…©æ¬„ï¼‰ -->
      <div id="qtywrap-${id}" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px">
        ${c.choices.map(name=>{
          const unit = singlesByName[name]||0;
          const safeId = `${id}:${name}`;
          return `
            <label style="display:flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius:8px; padding:6px 8px; justify-content:space-between">
              <span>${name} <span class="muted">${currency(unit)}</span></span>
              <input type="number" min="0" value="0" data-qty="${safeId}" style="width:64px; text-align:center; height:28px">
            </label>
          `;
        }).join("")}
      </div>

      <div class="row" style="margin-top:6px">
        <div class="muted">å·²é¸ <b id="cnt-${id}">0</b> / <span id="need-${id}">${tierA.n}</span></div>
        <button class="btn primary" data-add-mix8="${id}" disabled>åŠ å…¥çµ„åˆåŒ…</button>
      </div>
    </div>
  `;
  appendBlock(block)(target);

  // æ§åˆ¶å…ƒä»¶
  const radios = [...document.querySelectorAll(`input[name='tier-${id}']`)];
  const qtyInputs = [...document.querySelectorAll(`input[data-qty^='${id}:']`)];
  const tagEl  = document.getElementById(`tag-${id}`);
  const cntEl  = document.getElementById(`cnt-${id}`);
  const needEl = document.getElementById(`need-${id}`);
  const addBtn = document.querySelector(`[data-add-mix8='${id}']`);

  let currentTier = 0; // 0 -> tierA(6å…¥), 1 -> tierB(3å…¥)

  const need = () => currentTier === 0 ? tierA.n : tierB.n;
  const price = () => currentTier === 0 ? tierA.price : tierB.price;

  // è¨ˆç®—ç›®å‰ç¸½æ•¸é‡
  const sumQty = () => qtyInputs.reduce((s, i) => s + (+i.value || 0), 0);

  // æ›´æ–°ç•«é¢/æŒ‰éˆ•ç‹€æ…‹
  const update = () => {
    const selected = sumQty();
    cntEl.textContent = String(selected);
    needEl.textContent = String(need());
    addBtn.disabled = selected !== need();
    tagEl.textContent = `${need()} å…¥ä»»é¸ / å›ºå®šåƒ¹ ${currency(price())}`;
  };

  // åˆ‡æ› 6å…¥/3å…¥ï¼šæ¸…ç©ºæ•¸é‡ï¼Œé‡ç®—
  radios.forEach(r => r.addEventListener('change', () => {
    currentTier = +r.value;
    qtyInputs.forEach(i => i.value = "0");
    update();
  }));

  // ä»»ä¸€å“é …æ•¸é‡æ”¹è®Šå°±é‡ç®—
  qtyInputs.forEach(i => i.addEventListener('input', () => {
    // é¿å…è² æ•¸æˆ– NaN
    const v = Math.max(0, parseInt(i.value || "0", 10) || 0);
    i.value = String(v);
    update();
  }));

  // åŠ å…¥è³¼ç‰©è»Š
  addBtn.addEventListener('click', () => {
    // æ”¶é›†æœ‰å¡«æ•¸é‡çš„å“é …
    const selections = qtyInputs
      .map(i => {
        const name = i.dataset.qty.split(':')[1];
        const qty = +i.value || 0;
        return { name, qty };
      })
      .filter(s => s.qty > 0);

    // å¯«å…¥è³¼ç‰©è»Šï¼Œå›ºå®šåƒ¹ä»¥ tier å°æ‡‰
    cart.push({
      type: 'combo',
      name: `${c.title}ï¼ˆ${need()}å…¥ï¼‰`,
      rule: { fixedPrice: price() },
      selections,
      qty: 1
    });

    // é‡ç½®è¼¸å…¥æ¡†èˆ‡ç‹€æ…‹
    qtyInputs.forEach(i => i.value = "0");
    update();
    renderCart();
  });

  // ä¸€é–‹å§‹å…ˆç®—ä¸€æ¬¡
  update();
  return;
}


    if(c.rule.type === "pickNFixed"){
      const id = c.id;
      const block = document.createElement("div");
      block.className = "card";
      block.innerHTML = `<div class="content">
        <div class="row" style="margin-bottom:6px"><b>${c.title}</b><span class="tag">${c.rule.n} å…¥ä»»é¸ / å›ºå®šåƒ¹ ${currency(c.rule.fixedPrice)}</span></div>
        ${c.choices.map(name=>{
          const unit = singlesByName[name]||0;
          return `<div class="row" style="margin:6px 0">
            <span>${name} <span class="muted">${currency(unit)}</span></span>
            <input type="number" min="0" value="0" data-choice="${id}:${name}" style="width:58px;text-align:center;height:28px">
          </div>`;
        }).join("")}
        <div class="row" style="margin-top:6px">
          <div class="muted">å·²é¸ <b id="cnt-${id}">0</b> / ${c.rule.n}</div>
          <button class="btn primary" data-add-combo="${id}" disabled>åŠ å…¥çµ„åˆåŒ…</button>
        </div>
      </div>`;
      appendBlock(block)(target);

      const inputs = [...document.querySelectorAll(`input[data-choice^='${id}:']`)];
      const btn = document.querySelector(`[data-add-combo='${id}']`);
      const cnt = document.getElementById(`cnt-${id}`);
      const update=()=>{
        const sum = inputs.reduce((s,i)=> s + (+i.value||0), 0);
        cnt.textContent = String(sum); btn.disabled = sum !== c.rule.n;
      };
      inputs.forEach(i=> i.addEventListener('input', update));
      btn.addEventListener('click', ()=>{
        const selections = inputs.map(i=>({name: i.dataset.choice.split(':')[1], qty: +i.value||0})).filter(x=>x.qty>0);
        cart.push({ type:'combo', name:c.title, rule:c.rule, selections, qty:1 });
        inputs.forEach(i=> i.value = 0); update(); renderCart();
      });
      update(); return;
    }

    if (c.rule.type === "exactBundleFixed") {
      const id=c.id;
      const block=document.createElement("div"); block.className="card";
      block.innerHTML=`<div class="content">
        <div class="row" style="margin-bottom:6px"><b>${c.title}</b><span class="tag">å›ºå®šé…æ–¹ / å›ºå®šåƒ¹ ${currency(c.rule.fixedPrice)}</span></div>
        <ul class="list" style="margin-bottom:8px">
          ${c.rule.items.map(it => `<li><div class="meta"><span>${it.name} Ã— ${it.qty}</span><span class="muted">å–®åƒ¹ ${currency(singlesByName[it.name]||0)}</span></div></li>`).join("")}
        </ul>
        <div class="row" style="margin-top:6px">
          <label class="muted" style="display:inline-flex;align-items:center;gap:6px"><span>çµ„æ•¸</span><input type="number" min="1" value="1" id="sets-${id}" style="width:64px;text-align:center;height:28px"></label>
          <button class="btn primary" data-add-exact="${id}">åŠ å…¥çµ„åˆåŒ…</button>
        </div>
      </div>`;
      appendBlock(block)(target);

      const addBtn = document.querySelector(`[data-add-exact='${id}']`);
      const setsInput = document.getElementById(`sets-${id}`);
      addBtn.addEventListener("click", () => {
        const sets = Math.max(1, parseInt(setsInput.value || "1", 10));
        const selections = c.rule.items.map(it => ({ name: it.name, qty: it.qty }));
        cart.push({ type:"combo", name:c.title, rule:{ fixedPrice:c.rule.fixedPrice }, selections, qty:sets });
        setsInput.value = "1"; renderCart();
      });
      return;
    }
  });
}

/****************** Renderï¼šç¬¬äºŒé å•†å“æ¸…å–® ******************/
function renderCareLists(){
  const fill = (elId, items)=>{
    const ul = document.getElementById(elId); ul.innerHTML = "";
    items.forEach(s=>{
      const li = document.createElement("li");
      li.innerHTML = `<div class="meta"><span>${s.name}</span><span class="muted">${currency(s.unitPrice)}</span></div>
                      <button class="btn" data-care="${s.id}">ï¼‹</button>`;
      ul.appendChild(li);
    });
  };
  fill("care-skin",   careCatalog.skin);
  fill("care-drink",  careCatalog.drink);
  fill("care-others", careCatalog.others);
  fill("care-intimate", careCatalog.intimate);
  fill("care-health", careCatalog.health);

  $$("[data-care]").forEach(btn=> btn.addEventListener("click", ()=>{
    const s = Object.values(careCatalog).flat().find(x=> x.id===btn.dataset.care);
    const found = cart.find(c=> c.type==='single' && c.itemId===s.id);
    if(found){ found.qty++; }else{ cart.push({type:'single', itemId:s.id, name:s.name, unitPrice:s.unitPrice, qty:1}); }
    renderCart();
  }));

  // ä¿é¤Šä¸‰ä»¶çµ„ï¼ˆå›ºå®š $4,980ï¼‰
  const addSkin3 = document.getElementById('add-skin3');
  const setsSkin3 = document.getElementById('sets-skin3');
  addSkin3.addEventListener('click', ()=>{
    const sets = Math.max(1, parseInt(setsSkin3.value||"1",10));
    const selections = [
      { name:"èƒºåŸºé…¸æ´—é¡æ…•çµ²", qty:1 },
      { name:"å¤–æ³Œé«”ä¿®è­·ç²¾è¯æ¶²", qty:1 },
      { name:"çš®è„‚è†œä¿®è­·ä¹³éœœ", qty:1 },
    ];
    cart.push({ type:'combo', name:'ä¿é¤Šä¸‰ä»¶çµ„', rule:{ fixedPrice:4980 }, selections, qty:sets });
    setsSkin3.value = "1";
    renderCart();
  });
}

/****************** Renderï¼šè³¼ç‰©è»Šï¼ˆåŒæ­¥åˆ°å…©é çš„é¡¯ç¤ºå€ï¼‰ ******************/
function renderCart(){
  const boxMain = document.getElementById('cartItems'); if(boxMain) boxMain.innerHTML = '';
  const boxCare = document.getElementById('cartItems-care'); if(boxCare) boxCare.innerHTML = '';

  let subtotal = 0; let bundleNote = '';

  cart.forEach((ci, idx)=>{
    const rowHTMLSingle = (line)=>`
      <div><div class='name'>å–®å“ï½œ${ci.name}</div><div class='muted'>å–®åƒ¹ ${currency(ci.unitPrice)}</div></div>
      <div class='right'>
        <div class='qtyctl'>
          <button class='btn' data-dec='${idx}'>âˆ’</button>
          <span>${ci.qty}</span>
          <button class='btn' data-inc='${idx}'>ï¼‹</button>
          <button class='btn' data-del='${idx}' title='åˆªé™¤'>âœ•</button>
        </div>
        <div class='price'>${currency(line)}</div>
      </div>`;

    const rowHTMLBundle = (line,diff,sel)=>`
      <div>
        <div class='name'>å¥—çµ„ï½œ${ci.name}</div>
        ${sel?`<div class='muted'>${sel}</div>`:''}
        <div class='muted'>å¯æ­åƒ¹ <b>${currency(ci.displayPrice)}</b>ï¼ˆè‹¥ä¸è¶³è‡ªå‹•è£œå·®ï¼‰</div>
        ${diff>0?`<div class='warn'>é–€æª»è£œå·® ${currency(diff)} / çµ„</div>`:''}
      </div>
      <div class='right'>
        <div class='qtyctl'>
          <button class='btn' data-dec='${idx}'>âˆ’</button>
          <span>${ci.qty}</span>
          <button class='btn' data-inc='${idx}'>ï¼‹</button>
          <button class='btn' data-del='${idx}' title='åˆªé™¤'>âœ•</button>
        </div>
        <div class='price'>${currency(line)}</div>
      </div>`;

    const rowHTMLCombo = (line,seltext)=>`
      <div>
        <div class='name'>çµ„åˆï½œ${ci.name}</div>
        <div class='muted'>${seltext}</div>
        <span class='tag'>å›ºå®šåƒ¹ ${currency(ci.rule.fixedPrice)} / çµ„</span>
      </div>
      <div class='right'>
        <div class='qtyctl'>
          <button class='btn' data-dec='${idx}'>âˆ’</button>
          <span>${ci.qty}</span>
          <button class='btn' data-inc='${idx}'>ï¼‹</button>
          <button class='btn' data-del='${idx}' title='åˆªé™¤'>âœ•</button>
        </div>
        <div class='price'>${currency(line)}</div>
      </div>`;

    let row;
    if(ci.type==='single'){
      const line = ci.unitPrice * ci.qty; subtotal += line;
      row = document.createElement('div'); row.className='cart-item'; row.innerHTML = rowHTMLSingle(line);
    } else if(ci.type==='bundle'){
      const line = Math.max(ci.displayPrice, ci.minPrice) * ci.qty; subtotal += line;
      const diff = Math.max(0, ci.minPrice - ci.displayPrice);
      const sel = ci.selections?.map(s=>`${s.name}Ã—${s.qty}`).join('ã€') || '';
      row = document.createElement('div'); row.className='cart-item'; row.innerHTML = rowHTMLBundle(line,diff,sel);
      if(diff>0) bundleNote = 'éƒ¨åˆ†å¥—çµ„æœªé”æœ€ä½åƒ¹ï¼Œå·²è‡ªå‹•è¨ˆå…¥é–€æª»è£œå·®ã€‚';
    } else { // combo
      const line = ci.rule.fixedPrice * ci.qty; subtotal += line;
      const seltext = ci.selections.map(s=>`${s.name}Ã—${s.qty}`).join('ã€');
      row = document.createElement('div'); row.className='cart-item'; row.innerHTML = rowHTMLCombo(line,seltext);
    }

    if(boxMain) boxMain.appendChild(row.cloneNode(true));
    if(boxCare) boxCare.appendChild(row);
  });

  const syncMoney = (suf)=>{
    const $sub = document.getElementById('subtotal'+suf);
    const $dis = document.getElementById('discount'+suf);
    const $tot = document.getElementById('grandTotal'+suf);
    const $note= document.getElementById('bundleNotes'+suf);
    if($sub) $sub.textContent = currency(subtotal);
    if($dis) $dis.textContent = currency(0);
    if($tot) $tot.textContent = currency(subtotal);
    if($note) $note.textContent = bundleNote;
  };
  syncMoney('');
  syncMoney('-care');

  $$('[data-inc]').forEach(b=> b.addEventListener('click',()=>{ cart[+b.dataset.inc].qty++; renderCart(); }));
  $$('[data-dec]').forEach(b=> b.addEventListener('click',()=>{ const i=+b.dataset.dec; cart[i].qty=Math.max(1, cart[i].qty-1); renderCart(); }));
  $$('[data-del]').forEach(b=> b.addEventListener('click',()=>{ cart.splice(+b.dataset.del,1); renderCart(); }));
}

/****************** æ“ä½œï¼šåŠ å…¥å¥—çµ„ï¼ˆä¸»é ï¼‰ ******************/
function addBundle(key){
  const def = bundleDefs[key];
  const selections = Object.entries(state[key]).map(([name,qty])=>{
    let q = 0;
    if(name === 'MNT è›‹ç™½ç²‰' && qty && typeof qty === 'object'){ q = (+qty.can||0) + (+qty.bag||0); }
    else{ q = +qty||0; }
    return { name, qty:q, unitPrice: singlesByName[name]||0 };
  }).filter(s=> s.qty>0);
  const sub = selections.reduce((s,x)=> s + x.qty*x.unitPrice, 0);
  const found = cart.find(c=> c.type==='bundle' && c.bundleKey===key);
  if(found){ found.qty++; }
  else{ cart.push({ type:'bundle', bundleKey:key, name:def.title, displayPrice: sub||def.displayPrice, minPrice:def.minPrice, selections, qty:1 }); }
  renderCart();
}

/****************** åˆ†é åˆ‡æ› & é€å‡º/æ¸…ç©º ******************/
function wireActions(){
  document.getElementById('clearCart').addEventListener('click', ()=>{ cart.length=0; renderCart(); });
  document.getElementById('submitOrder').addEventListener('click', submitOrder);

  document.getElementById('clearCart-care').addEventListener('click', ()=>{ cart.length=0; renderCart(); });
  document.getElementById('submitOrder-care').addEventListener('click', submitOrder);

  $$('[data-tab]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('[data-tab]').forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      const target = btn.dataset.tab;
      const showMain = (target==='main');
      document.getElementById('page-main').style.display = showMain? '' : 'none';
      document.getElementById('page-main').setAttribute('aria-hidden', String(!showMain));
      document.getElementById('page-care').style.display = showMain? 'none' : '';
      document.getElementById('page-care').setAttribute('aria-hidden', String(showMain));
      renderCart();
    });
  });
}
function submitOrder(){
  if(cart.length===0){ alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„'); return; }
  const payload = { orderNo: document.getElementById('orderNo').textContent, items: cart };
  console.log('é€å‡ºè¨‚å–®ï¼š', payload); alert('å·²é€å‡ºï¼ˆç¤ºç¯„ï¼šåƒ… console.logï¼‰');
}

/****************** å•Ÿå‹• ******************/
function init(){
  const d = new Date();
  document.getElementById('today').textContent = d.toLocaleDateString('zh-TW');
  document.getElementById('orderNo').textContent = 'DR-' + d.getFullYear().toString().slice(2) + (d.getMonth()+1+'').padStart(2,'0') + d.getDate().toString().padStart(2,'0') + '-' + Math.floor(Math.random()*900+100);

  ['classic','super','light'].forEach(renderBundle);
  $$('[data-add-bundle]').forEach(btn=> btn.addEventListener('click',()=> addBundle(btn.dataset.addBundle)));

  renderSingles();
  renderCombos();
  renderCareLists();
  renderCart();
  wireActions();
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
